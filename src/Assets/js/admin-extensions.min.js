jQuery(document).ready(function($){$(document).on("click",".mds-check-updates",function(e){e.preventDefault();let $button=$(this),$row=$button.closest("tr"),extensionId=$row.data("extension-id"),currentVersion=$row.data("version");$button.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking...'),$.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_check_extension_updates",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:extensionId,current_version:currentVersion},dataType:"json",success:function(response){if(response.success)handleUpdateResponse(response.data,$row);else showNotice("error",response.data.message||"Failed to check for updates."),resetButton($button,"Check for Updates")},error:function(xhr,status,error){console.error("Error checking for updates:",error),showNotice("error","An error occurred while checking for updates."),resetButton($button,"Check for Updates")}})}),$(document).on("click",".mds-install-update",function(e){e.preventDefault();let $button=$(this),extensionId=$button.closest("tr").data("extension-id"),downloadUrl=$button.data("download-url");if(!confirm("Are you sure you want to install this update?"))return;$button.prop("disabled",!0).html('<span class="spinner is-active"></span> Updating...'),$.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_install_extension_update",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:extensionId,download_url:downloadUrl},dataType:"json",success:function(response){if(response.success){if(showNotice("success",response.data.message||"Update installed successfully."),response.data.reload)setTimeout(()=>window.location.reload(),1500)}else showNotice("error",response.data.message||"Failed to install update."),resetButton($button,"Install Update")},error:function(xhr,status,error){console.error("Error installing update:",error),showNotice("error","An error occurred while installing the update."),resetButton($button,"Install Update")}})});function handleUpdateResponse(updateInfo,$row){let $updateCell=$row.find(".mds-update-cell"),$button=$row.find(".mds-check-updates");if(updateInfo.update_available){let html=`
                <div class="mds-update-available">
                    <p><strong>Version ${updateInfo.latest_version} is available!</strong></p>
                    ${updateInfo.changelog?`<div class="mds-changelog">${updateInfo.changelog}</div>`:""}
                    <p>
                        <button class="button button-primary mds-install-update"
                                data-download-url="${updateInfo.download_url}">
                            Update Now
                        </button>
                    </p>
                </div>
            `;$updateCell.html(html),resetButton($button,"Check Again")}else $updateCell.html('<span class="mds-no-updates">You have the latest version.</span>'),resetButton($button,"Check for Updates");$row.trigger("mds-update-checked")}function showNotice(type,message){let noticeHtml=`
            <div class="notice ${type==="error"?"notice-error":"notice-success"} is-dismissible">
                <p>${message}</p>
                <button type="button" class="notice-dismiss">
                    <span class="screen-reader-text">Dismiss this notice.</span>
                </button>
            </div>
        `;$(".wrap > h1").after(noticeHtml),$(document).on("click",".notice-dismiss",function(){$(this).closest(".notice").fadeOut(200,function(){$(this).remove()})})}function resetButton($button,text){$button.prop("disabled",!1).html(text)}$(document).on("click",".mds-check-all-updates",function(e){e.preventDefault();let $button=$(this),$rows=$("tr[data-extension-id]"),completed=0,hasUpdates=!1;$button.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking All...'),$rows.each(function(){let $row=$(this),extensionId=$row.data("extension-id"),currentVersion=$row.data("version"),$updateButton=$row.find(".mds-check-updates");if($updateButton.prop("disabled")){completed++,checkAllComplete();return}$updateButton.trigger("click"),$row.off("mds-update-checked").on("mds-update-checked",function(){if(completed++,$row.find(".mds-update-available").length)hasUpdates=!0;checkAllComplete()})});function checkAllComplete(){if(completed>=$rows.length)if(resetButton($button,"Check All for Updates"),hasUpdates)showNotice("success","Finished checking for updates. Some extensions have updates available.");else showNotice("success","All extensions are up to date.")}}),$(document).on("click",".mds-install-extension",function(e){e.preventDefault();let $button=$(this),extensionId=$button.data("extension-id");if(!confirm("Are you sure you want to install this extension?"))return;$button.prop("disabled",!0).html('<span class="spinner is-active"></span> Installing...'),$.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_install_extension",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:extensionId},dataType:"json",success:function(response){if(response.success){if(showNotice("success",response.data.message||"Extension installed successfully."),response.data.reload)setTimeout(()=>window.location.reload(),1500)}else showNotice("error",response.data.message||"Failed to install extension."),resetButton($button,"Install")},error:function(xhr,status,error){console.error("Error installing extension:",error),showNotice("error","An error occurred while installing the extension."),resetButton($button,"Install")}})}),$(document).on("mds-update-checked",function(e){$(this).trigger("mds-update-checked")})});
