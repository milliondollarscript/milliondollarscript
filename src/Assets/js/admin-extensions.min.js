jQuery(document).ready(function(q){q(document).on("click",".mds-check-updates",function(z){z.preventDefault();let j=q(this),F=j.closest("tr"),E=F.data("extension-id"),G=F.data("version");j.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking...'),q.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_check_extension_updates",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:E,current_version:G},dataType:"json",success:function(D){if(D.success)P(D.data,F);else J("error",D.data.message||"Failed to check for updates."),K(j,"Check for Updates")},error:function(D,L,M){console.error("Error checking for updates:",M),J("error","An error occurred while checking for updates."),K(j,"Check for Updates")}})}),q(document).on("click",".mds-install-update",function(z){z.preventDefault();let j=q(this),E=j.closest("tr").data("extension-id"),G=j.data("download-url");if(!confirm("Are you sure you want to install this update?"))return;j.prop("disabled",!0).html('<span class="spinner is-active"></span> Updating...'),q.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_install_extension_update",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:E,download_url:G},dataType:"json",success:function(D){if(D.success){if(J("success",D.data.message||"Update installed successfully."),D.data.reload)setTimeout(()=>window.location.reload(),1500)}else J("error",D.data.message||"Failed to install update."),K(j,"Install Update")},error:function(D,L,M){console.error("Error installing update:",M),J("error","An error occurred while installing the update."),K(j,"Install Update")}})});function P(z,j){let F=j.find(".mds-update-cell"),E=j.find(".mds-check-updates");if(z.update_available){let G=`
                <div class="mds-update-available">
                    <p><strong>Version ${z.latest_version} is available!</strong></p>
                    ${z.changelog?`<div class="mds-changelog">${z.changelog}</div>`:""}
                    <p>
                        <button class="button button-primary mds-install-update"
                                data-download-url="${z.download_url}">
                            Update Now
                        </button>
                    </p>
                </div>
            `;F.html(G),K(E,"Check Again")}else F.html('<span class="mds-no-updates">You have the latest version.</span>'),K(E,"Check for Updates");j.trigger("mds-update-checked")}function J(z,j){let E=`
            <div class="notice ${z==="error"?"notice-error":"notice-success"} is-dismissible">
                <p>${j}</p>
                <button type="button" class="notice-dismiss">
                    <span class="screen-reader-text">Dismiss this notice.</span>
                </button>
            </div>
        `;q(".wrap > h1").after(E),q(document).on("click",".notice-dismiss",function(){q(this).closest(".notice").fadeOut(200,function(){q(this).remove()})})}function K(z,j){z.prop("disabled",!1).html(j)}q(document).on("click",".mds-check-all-updates",function(z){z.preventDefault();let j=q(this),F=q("tr[data-extension-id]"),E=0,G=!1;j.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking All...'),F.each(function(){let L=q(this),M=L.data("extension-id"),Q=L.data("version"),O=L.find(".mds-check-updates");if(O.prop("disabled")){E++,D();return}O.trigger("click"),L.off("mds-update-checked").on("mds-update-checked",function(){if(E++,L.find(".mds-update-available").length)G=!0;D()})});function D(){if(E>=F.length)if(K(j,"Check All for Updates"),G)J("success","Finished checking for updates. Some extensions have updates available.");else J("success","All extensions are up to date.")}}),q(document).on("mds-update-checked",function(z){q(this).trigger("mds-update-checked")})});
