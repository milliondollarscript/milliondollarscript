jQuery(document).ready(function(q){q(document).on("click",".mds-check-updates",function(z){z.preventDefault();let j=q(this),F=j.closest("tr"),D=F.data("extension-id"),K=F.data("version");j.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking...'),q.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_check_extension_updates",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:D,current_version:K},dataType:"json",success:function(E){if(E.success)P(E.data,F);else G("error",E.data.message||"Failed to check for updates."),J(j,"Check for Updates")},error:function(E,L,M){console.error("Error checking for updates:",M),G("error","An error occurred while checking for updates."),J(j,"Check for Updates")}})}),q(document).on("click",".mds-install-update",function(z){z.preventDefault();let j=q(this),D=j.closest("tr").data("extension-id"),K=j.data("download-url");if(!confirm("Are you sure you want to install this update?"))return;j.prop("disabled",!0).html('<span class="spinner is-active"></span> Updating...'),q.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_install_extension_update",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:D,download_url:K},dataType:"json",success:function(E){if(E.success){if(G("success",E.data.message||"Update installed successfully."),E.data.reload)setTimeout(()=>window.location.reload(),1500)}else G("error",E.data.message||"Failed to install update."),J(j,"Install Update")},error:function(E,L,M){console.error("Error installing update:",M),G("error","An error occurred while installing the update."),J(j,"Install Update")}})});function P(z,j){let F=j.find(".mds-update-cell"),D=j.find(".mds-check-updates");if(z.update_available){let K=`
                <div class="mds-update-available">
                    <p><strong>Version ${z.latest_version} is available!</strong></p>
                    ${z.changelog?`<div class="mds-changelog">${z.changelog}</div>`:""}
                    <p>
                        <button class="button button-primary mds-install-update"
                                data-download-url="${z.download_url}">
                            Update Now
                        </button>
                    </p>
                </div>
            `;F.html(K),J(D,"Check Again")}else F.html('<span class="mds-no-updates">You have the latest version.</span>'),J(D,"Check for Updates");j.trigger("mds-update-checked")}function G(z,j){let D=`
            <div class="notice ${z==="error"?"notice-error":"notice-success"} is-dismissible">
                <p>${j}</p>
                <button type="button" class="notice-dismiss">
                    <span class="screen-reader-text">Dismiss this notice.</span>
                </button>
            </div>
        `;q(".wrap > h1").after(D),q(document).on("click",".notice-dismiss",function(){q(this).closest(".notice").fadeOut(200,function(){q(this).remove()})})}function J(z,j){z.prop("disabled",!1).html(j)}q(document).on("click",".mds-check-all-updates",function(z){z.preventDefault();let j=q(this),F=q("tr[data-extension-id]"),D=0,K=!1;j.prop("disabled",!0).html('<span class="spinner is-active"></span> Checking All...'),F.each(function(){let L=q(this),M=L.data("extension-id"),Q=L.data("version"),O=L.find(".mds-check-updates");if(O.prop("disabled")){D++,E();return}O.trigger("click"),L.off("mds-update-checked").on("mds-update-checked",function(){if(D++,L.find(".mds-update-available").length)K=!0;E()})});function E(){if(D>=F.length)if(J(j,"Check All for Updates"),K)G("success","Finished checking for updates. Some extensions have updates available.");else G("success","All extensions are up to date.")}}),q(document).on("click",".mds-install-extension",function(z){z.preventDefault();let j=q(this),F=j.data("extension-id");if(!confirm("Are you sure you want to install this extension?"))return;j.prop("disabled",!0).html('<span class="spinner is-active"></span> Installing...'),q.ajax({url:MDS_EXTENSIONS_DATA.ajax_url,type:"POST",data:{action:"mds_install_extension",nonce:MDS_EXTENSIONS_DATA.nonce,extension_id:F},dataType:"json",success:function(D){if(D.success){if(G("success",D.data.message||"Extension installed successfully."),D.data.reload)setTimeout(()=>window.location.reload(),1500)}else G("error",D.data.message||"Failed to install extension."),J(j,"Install")},error:function(D,K,E){console.error("Error installing extension:",E),G("error","An error occurred while installing the extension."),J(j,"Install")}})}),q(document).on("mds-update-checked",function(z){q(this).trigger("mds-update-checked")})});
