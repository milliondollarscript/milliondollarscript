jQuery(document).ready(function($){let addnfs=[],remnfs=[],$document=$(document),$grid=$(".grid"),grid_bg_url=$grid.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,""),grid_img=$('<img alt="" src=""/>').attr("src",grid_bg_url),$nfs_covered_image=$(document.createDocumentFragment());function nfs_covered_image(){if($grid=$(document).find(".grid"),$grid.data("covered")===!1)return;$nfs_covered_image=$("<div>",{id:"nfs-covered-image",class:"nfs-covered"}),$grid.append($nfs_covered_image)}function nfs_covered_image_size(){let blocks=selection.getSelection();if(blocks.length===0)return;if(!$nfs_covered_image)$nfs_covered_image=$(".nfs-covered-image");let width=$grid.data("width"),height=$grid.data("height");$nfs_covered_image.width(blocks[blocks.length-1].offsetLeft-blocks[0].offsetLeft+width+"px"),$nfs_covered_image.height(blocks[blocks.length-1].offsetTop-blocks[0].offsetTop+height+"px"),$nfs_covered_image.css("position","absolute"),$nfs_covered_image.css("left",blocks[0].offsetLeft+"px"),$nfs_covered_image.css("top",blocks[0].offsetTop+"px")}function mds_nfs_refresh(html,css,message,dfd){if(css!==void 0&&css.length>0)$(document).find("#mds-admin-css-inline-css").html(css);$(document).find(".admin-content-inner").replaceWith(html).promise().done(function(){$(document).find(".loading").hide(function(){if($(this).remove(),message)$('<span class="message">'+message+"</span>").insertBefore(".grid").fadeOut(1e4,function(){$(this).remove()});dfd.resolve("success")})})}function mds_nfs_error(error){$document.scrollTop(0),$('<span class="message">'+MDS.lang.error+" "+error+"</span>").insertBefore(".grid").fadeOut(1e4,function(){$(this).remove()})}function handleResponse(response){let dfd=$.Deferred();try{if(response.success===!0)mds_nfs_refresh(response.data.html,response.data.css,MDS.lang.success,dfd);else mds_nfs_error(response.data[0].message),dfd.reject("error")}catch(e){console.log(e),mds_nfs_error(MDS.lang.error),dfd.reject("error")}return dfd.promise()}grid_img.off("load"),grid_img.on("load",function(){$(this).remove(),$(".loading").remove()}).each(function(){if(this.complete)$(this).trigger("load")});function processBlock(block){let $block=$(block),blockid;if($block.hasClass("nfs")){blockid=$block.attr("data-block"),addnfs.push(blockid);let index=remnfs.indexOf(blockid);if(index!==-1)remnfs.splice(index,1)}else if($block.hasClass("free")){blockid=$block.attr("data-block"),remnfs.push(blockid);let index=addnfs.indexOf(blockid);if(index!==-1)addnfs.splice(index,1)}}function toggleBlock(el){let $block=$(el);if($block.hasClass("nfs"))$block.removeClass("nfs"),$block.addClass("free");else $block.removeClass("free"),$block.addClass("nfs")}function getSelectionArea(){return new SelectionArea({selectables:["span.block"],startareas:[".grid"],boundaries:[".grid"]})}let selection=getSelectionArea();$(window).off("unload"),$(window).on("unload",function(){selection.destroy()}),selection.off("beforestart"),selection.off("move"),selection.off("stop"),selection.on("beforestart",(e)=>{for(let el of e.store.stored)$(el).removeClass("selected");if(selection.clearSelection(!0),$nfs_covered_image.length>0)$nfs_covered_image.remove(),$nfs_covered_image=null;nfs_covered_image()}).on("move",(e)=>{for(let el of e.store.changed.added)$(el).addClass("selected");for(let el of e.store.changed.removed)$(el).removeClass("selected");if(!$nfs_covered_image)$nfs_covered_image=$(".nfs-covered-image");if(e.store.selected.length>0)$nfs_covered_image.width(e.store.selected[e.store.selected.length-1].offsetLeft-e.store.selected[0].offsetLeft+10+"px"),$nfs_covered_image.height(e.store.selected[e.store.selected.length-1].offsetTop-e.store.selected[0].offsetTop+10+"px")}).on("stop",(e)=>{let els=e.store.selected;for(let el of els)toggleBlock(el),processBlock(el);nfs_covered_image_size()});let $save=$(".save"),$reset=$(".reset"),submitting=!1;$document.off("click",".save"),$document.on("click",".save",function(e){if(e.preventDefault(),e.stopPropagation(),$grid.append('<img class="loading" src="'+MDS.MDS_BASE_URL+'src/Assets/images/ajax-loader.gif" alt="" />'),$save.prop("disabled",!0),$reset.prop("disabled",!0),!submitting)submitting=!0,$.post(MDS.ajaxurl,{action:"mds_nfs_save",mds_nfs_nonce:MDS.mds_nfs_nonce,BID:$("#mds-nfs-grid").val(),addnfs:JSON.stringify(addnfs),remnfs:JSON.stringify(remnfs),dataType:"json"}).always(function(data){handleResponse(data).then(function(response){if(response!=="success")console.log(response)}),submitting=!1,$(".loading").hide(function(){$(this).remove()}),$save.prop("disabled",!1),$reset.prop("disabled",!1)});return!1});function confirm_dialog(title,message){$('<div id="confirm-dialog">'+message+"</div>").appendTo(".outer_box"),$("#confirm-dialog").dialog({title,modal:!0,width:"auto",resizable:!1,position:{my:"center top",at:"center top+1%",of:$(".outer_box")},buttons:{Yes:function(){$grid.append('<img class="loading" src="'+MDS.MDS_BASE_URL+'src/Assets/images/ajax-loader.gif" alt="" />'),$.post(MDS.ajaxurl,{action:"mds_nfs_reset",mds_nfs_nonce:MDS.mds_nfs_nonce,BID:$("#mds-nfs-grid").val(),dataType:"json"}).done(function(data){selection.clearSelection(),handleResponse(data).then(function(response){if(response!=="success")console.log(response)})}).fail(function(data){handleResponse(data).then(function(response){if(response!=="success")console.log(response)})}),$(this).dialog("close")},No:function(){$(this).dialog("close"),$save.prop("disabled",!1),$reset.prop("disabled",!1)}},close:function(){$(this).remove(),$save.prop("disabled",!1),$reset.prop("disabled",!1)}})}$document.off("click",".reset"),$document.on("click",".reset",function(e){return e.preventDefault(),e.stopPropagation(),$save.prop("disabled",!0),$reset.prop("disabled",!0),confirm_dialog(MDS.lang.reset,MDS.lang.reset_message),!1});function mds_nfs_form_submit(formData,$form,options){return $form.find("input").attr("disabled",!0),!0}function mds_nfs_form_submit_success(responseText,statusText,xhr,$form){$document.scrollTop(0),selection.clearSelection(),handleResponse(responseText).then(function(response){if(response==="success")console.log(response)})}$document.on("change","#mds-nfs-grid",function(){let form=$(this).closest("form");$(form).ajaxSubmit({target:".outer_box",type:"POST",url:MDS.adminpost,delegation:!0,beforeSubmit:mds_nfs_form_submit,success:mds_nfs_form_submit_success,data:{action:"mds_nfs_grid",mds_nfs_nonce:MDS.mds_nfs_nonce},error:function(jqXHR,textStatus,errorThrown){mds_nfs_error(errorThrown)}})},null,"json")});
