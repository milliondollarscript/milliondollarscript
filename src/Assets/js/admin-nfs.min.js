/*
 * Million Dollar Script Two
 *
 * @author      Ryan Rhode
 * @copyright   (C) 2025, Ryan Rhode
 * @license     https://opensource.org/licenses/GPL-3.0 GNU General Public License, version 3
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 *
 *    Million Dollar Script
 *    Pixels to Profit: Ignite Your Revolution
 *    https://milliondollarscript.com/
 *
 */
jQuery(document).ready((function(e){let s=[],o=[];const t=e(document);let n=e(".grid"),a=n.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,""),r=e('<img alt="" src=""/>').attr("src",a),c=e(document.createDocumentFragment());function i(s){t.scrollTop(0),e('<span class="message">'+MDS.lang.error+" "+s+"</span>").insertBefore(".grid").fadeOut(1e4,(function(){e(this).remove()}))}function d(s){let o=e.Deferred();try{!0===s.success?function(s,o,t,n){void 0!==o&&o.length>0&&e(document).find("#mds-admin-css-inline-css").html(o),e(document).find(".admin-content-inner").replaceWith(s).promise().done((function(){e(document).find(".loading").hide((function(){e(this).remove(),t&&e('<span class="message">'+t+"</span>").insertBefore(".grid").fadeOut(1e4,(function(){e(this).remove()})),n.resolve("success")}))}))}(s.data.html,s.data.css,MDS.lang.success,o):(i(s.data[0].message),o.reject("error"))}catch(e){console.log(e),i(MDS.lang.error),o.reject("error")}return o.promise()}function l(t){let n,a=e(t);if(a.hasClass("nfs")){n=a.attr("data-block"),s.push(n);let e=o.indexOf(n);-1!==e&&o.splice(e,1)}else if(a.hasClass("free")){n=a.attr("data-block"),o.push(n);let e=s.indexOf(n);-1!==e&&s.splice(e,1)}}function f(s){let o=e(s);o.hasClass("nfs")?(o.removeClass("nfs"),o.addClass("free")):(o.removeClass("free"),o.addClass("nfs"))}r.off("load"),r.on("load",(function(){e(this).remove(),e(".loading").remove()})).each((function(){this.complete&&e(this).trigger("load")}));let u=new SelectionArea({selectables:["span.block"],startareas:[".grid"],boundaries:[".grid"]});e(window).off("unload"),e(window).on("unload",(function(){u.destroy()})),u.off("beforestart"),u.off("move"),u.off("stop"),u.on("beforestart",(s=>{for(const o of s.store.stored)e(o).removeClass("selected");u.clearSelection(!0),c.length>0&&(c.remove(),c=null),n=e(document).find(".grid"),!1!==n.data("covered")&&(c=e("<div>",{id:"nfs-covered-image",class:"nfs-covered"}),n.append(c))})).on("move",(s=>{for(const o of s.store.changed.added)e(o).addClass("selected");for(const o of s.store.changed.removed)e(o).removeClass("selected");c||(c=e(".nfs-covered-image")),s.store.selected.length>0&&(c.width(s.store.selected[s.store.selected.length-1].offsetLeft-s.store.selected[0].offsetLeft+10+"px"),c.height(s.store.selected[s.store.selected.length-1].offsetTop-s.store.selected[0].offsetTop+10+"px"))})).on("stop",(s=>{let o=s.store.selected;for(const e of o)f(e),l(e);!function(){const s=u.getSelection();if(0===s.length)return;c||(c=e(".nfs-covered-image"));let o=n.data("width"),t=n.data("height");c.width(s[s.length-1].offsetLeft-s[0].offsetLeft+o+"px"),c.height(s[s.length-1].offsetTop-s[0].offsetTop+t+"px"),c.css("position","absolute"),c.css("left",s[0].offsetLeft+"px"),c.css("top",s[0].offsetTop+"px")}()}));let p=e(".save"),g=e(".reset"),m=!1;function h(e,s,o){return s.find("input").attr("disabled",!0),!0}function v(e,s,o,n){t.scrollTop(0),u.clearSelection(),d(e).then((function(e){"success"===e&&console.log(e)}))}t.off("click",".save"),t.on("click",".save",(function(t){return t.preventDefault(),t.stopPropagation(),n.append('<img class="loading" src="'+MDS.MDS_BASE_URL+'src/Assets/images/ajax-loader.gif" alt="" />'),p.prop("disabled",!0),g.prop("disabled",!0),m||(m=!0,e.post(MDS.ajaxurl,{action:"mds_nfs_save",mds_nfs_nonce:MDS.mds_nfs_nonce,BID:e("#mds-nfs-grid").val(),addnfs:JSON.stringify(s),remnfs:JSON.stringify(o),dataType:"json"}).always((function(s){d(s).then((function(e){"success"!==e&&console.log(e)})),m=!1,e(".loading").hide((function(){e(this).remove()})),p.prop("disabled",!1),g.prop("disabled",!1)}))),!1})),t.off("click",".reset"),t.on("click",".reset",(function(s){var o,t;return s.preventDefault(),s.stopPropagation(),p.prop("disabled",!0),g.prop("disabled",!0),o=MDS.lang.reset,t=MDS.lang.reset_message,e('<div id="confirm-dialog">'+t+"</div>").appendTo(".outer_box"),e("#confirm-dialog").dialog({title:o,modal:!0,width:"auto",resizable:!1,position:{my:"center top",at:"center top+1%",of:e(".outer_box")},buttons:{Yes:function(){n.append('<img class="loading" src="'+MDS.MDS_BASE_URL+'src/Assets/images/ajax-loader.gif" alt="" />'),e.post(MDS.ajaxurl,{action:"mds_nfs_reset",mds_nfs_nonce:MDS.mds_nfs_nonce,BID:e("#mds-nfs-grid").val(),dataType:"json"}).done((function(e){u.clearSelection(),d(e).then((function(e){"success"!==e&&console.log(e)}))})).fail((function(e){d(e).then((function(e){"success"!==e&&console.log(e)}))})),e(this).dialog("close")},No:function(){e(this).dialog("close"),p.prop("disabled",!1),g.prop("disabled",!1)}},close:function(){e(this).remove(),p.prop("disabled",!1),g.prop("disabled",!1)}}),!1})),t.on("change","#mds-nfs-grid",(function(){const s=e(this).closest("form");e(s).ajaxSubmit({target:".outer_box",type:"POST",url:MDS.adminpost,delegation:!0,beforeSubmit:h,success:v,data:{action:"mds_nfs_grid",mds_nfs_nonce:MDS.mds_nfs_nonce},error:function(e,s,o){i(o)}})}),null,"json")}));