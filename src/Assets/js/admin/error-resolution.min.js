(i=>{let r={modal:null,currentPageId:null,init:function(){this.bindEvents(),this.setupModal(),this.bindPageListErrorHelpers()},bindEvents:function(){i("#mds-scan-errors").on("click.error-resolution",this.scanForErrors.bind(this)),i("#mds-repair-all-issues").on("click.error-resolution",this.fixAllErrors.bind(this)),i("#mds-fix-all-errors").on("click.error-resolution",this.fixAllErrors.bind(this)),i(document).on("click","#mds-modal-close, #mds-modal-cancel",this.closeModal.bind(this)),i(document).on("click","#mds-modal-fix",this.applyModalFix.bind(this)),i(document).on("click",".mds-error-view-details",this.viewErrorDetails.bind(this)),i(document).on("click",".mds-error-fix-single",this.fixSingleError.bind(this)),i(document).on("click",".mds-modal-overlay",function(e){e.target===this&&r.closeModal()})},setupModal:function(){this.modal=i("#mds-error-modal")},bindPageListErrorHelpers:function(){i(document).on("click",".mds-error-help",function(e){e.preventDefault(),e.stopPropagation();e=i(this).data("post-id");e&&r.showErrorDetails(e)})},scanForErrors:function(e){e.preventDefault();let s=i(e.target).closest("button");e=i("#mds-error-results");window.mdsPageManagement&&window.mdsPageManagement.showProgress&&window.mdsPageManagement.showProgress("Scanning for Page Errors","Analyzing pages for validation errors..."),e.hide(),this.setButtonLoading(s,!0),s.prop("disabled",!0),i.ajax({url:window.ajaxurl||"/wp-admin/admin-ajax.php",method:"POST",data:{action:"mds_scan_errors",nonce:window.mdsPageManagement?window.mdsPageManagement.nonce:""}}).done(function(s){if(s.success&&s.data){var a=s.data.errors||s.data;r.displayErrorResults(a)}else{let e="Scan failed";a=[];s.data?"string"==typeof s.data?e+=": "+s.data:s.data.message?(e+=": "+s.data.message,s.data.debug_info&&(s.data.debug_info.error&&a.push("Error: "+s.data.debug_info.error),s.data.debug_info.file)&&s.data.debug_info.line&&a.push("Location: "+s.data.debug_info.file+":"+s.data.debug_info.line)):s.data.error?e+=": "+s.data.error:e+=": Unable to complete scan":e+=": No specific error information available",window.NotificationModal?window.NotificationModal.show("error","Scan Error",e,0<a.length?a:null):r.showError(e)}}).fail(function(e,s,a){var t="Unable to connect to server",o=[];e.status&&o.push("HTTP Status: "+e.status),s&&"error"!==s&&o.push("Status: "+s),a&&o.push("Error: "+a),window.NotificationModal?window.NotificationModal.show("error","Connection Error",t,0<o.length?o:null):r.showError(t)}).always(function(){window.mdsPageManagement&&window.mdsPageManagement.hideProgress&&window.mdsPageManagement.hideProgress(),r.setButtonLoading(s,!1),s.prop("disabled",!1)})},displayErrorResults:function(e){var s=i("#mds-error-results"),a=i(".mds-error-list"),t=i("#mds-fix-all-errors");if(e&&Array.isArray(e)&&0!==e.length){let o="",i=0;e.forEach(function(e){var s=e.suggested_fixes&&e.suggested_fixes.some(e=>e.auto_fixable),a=(s&&i++,s?"auto-fixable":"manual-fix"),t=e.validation_errors?e.validation_errors.slice(0,2).join(", "):"Unknown error";o+=`
                        <div class="mds-error-item ${a}" data-page-id="${e.page_id}">
                            <div class="mds-error-item-content">
                                <div class="mds-error-item-title">${e.page_title} (ID: ${e.page_id})</div>
                                <div class="mds-error-item-details">
                                    <strong>Page Type:</strong> ${e.page_type||"Unknown"}<br>
                                    <strong>Errors:</strong> ${t}
                                </div>
                            </div>
                            <div class="mds-error-item-actions">
                                <button type="button" class="button button-secondary mds-error-view-details" 
                                        data-page-id="${e.page_id}">
                                    View Details
                                </button>
                                ${s?`
                                <button type="button" class="button button-primary mds-error-fix-single" 
                                        data-page-id="${e.page_id}">
                                    Fix Now
                                </button>`:""}
                            </div>
                        </div>
                    `}),a.html(o),0<i?t.show().find("span:last").text(`Fix All Auto-Fixable Errors (${i})`):t.hide()}else a.html('<div class="mds-no-errors"><p>No pages with errors found!</p></div>'),t.hide(),window.mdsPageManagement&&window.mdsPageManagement.showNotification&&window.mdsPageManagement.showNotification("success","Scan Complete","No pages with errors found! All pages appear to be functioning correctly.");s.show()},showErrorDetails:function(e){this.currentPageId=e,i.ajax({url:`/wp-json/mds/v1/pages/${e}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){e.success&&e.data?(r.populateModal(e.data),r.openModal()):r.showError("Failed to load error details: "+(e.message||"Unknown error"))}).fail(function(e){r.showError("Error loading page details: "+e.statusText)})},populateModal:function(e){var s=i("#mds-modal-title"),a=i("#mds-modal-body"),t=i("#mds-modal-fix");s.text("Error Details: "+e.page_title);let o=`
                <div class="mds-error-detail">
                    <div class="mds-error-detail-label">Page Information</div>
                    <div class="mds-error-detail-value">
                        <strong>ID:</strong> ${e.page_id}<br>
                        <strong>Type:</strong> ${e.page_type||"Unknown"}<br>
                        <strong>Status:</strong> ${e.status}<br>
                        <strong>Confidence Score:</strong> ${e.confidence_score}<br>
                        <strong>Last Validated:</strong> ${e.last_validated||"Never"}
                    </div>
                </div>
            `;e.validation_errors&&0<e.validation_errors.length&&(o+=`
                    <div class="mds-error-detail">
                        <div class="mds-error-detail-label">Validation Errors</div>
                        <div class="mds-error-detail-value">
                            ${e.validation_errors.map(e=>"â€¢ "+e).join("<br>")}
                        </div>
                    </div>
                `),e.suggested_fixes&&0<e.suggested_fixes.length&&(o+='<div class="mds-suggested-fixes"><div class="mds-error-detail-label">Suggested Fixes</div>',e.suggested_fixes.forEach(function(e){var s=e.auto_fixable?"mds-auto-fixable":"";o+=`
                        <div class="mds-suggested-fix ${s}">
                            <div class="mds-suggested-fix-title">
                                ${e.title}
                                ${e.auto_fixable?" (Auto-fixable)":" (Manual)"}
                            </div>
                            <div class="mds-suggested-fix-description">${e.description}</div>
                        </div>
                    `}),o+="</div>",e.suggested_fixes.some(e=>e.auto_fixable))?t.show().data("page-id",e.page_id):t.hide(),a.html(o)},viewErrorDetails:function(e){e.preventDefault();e=i(e.target).data("page-id");this.showErrorDetails(e)},fixSingleError:function(e){e.preventDefault();var s=i(e.target).data("page-id"),e=i(e.target);this.applyFix(s,e)},applyModalFix:function(e){e.preventDefault();var e=i("#mds-modal-fix").data("page-id"),s=i("#mds-modal-fix");this.applyFix(e,s,!0)},applyFix:function(t,e,o=!1){let s=e.text();this.setButtonLoading(e,!0),e.prop("disabled",!0).text("Applying fixes..."),i.ajax({url:`/wp-json/mds/v1/pages/${t}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){var s,a;e.success&&e.data?(a=e.data.fixes_applied,s=e.data.new_status,a&&0<a.length?(r.showSuccess(`Applied ${a.length} fix(es). New status: `+s),a=i(`.mds-error-item[data-page-id="${t}"]`),"active"===s?a.fadeOut():r.refreshErrorItem(t),o&&setTimeout(()=>r.closeModal(),1500)):r.showError("No fixes were applied. The page may already be fixed.")):r.showError("Failed to apply fixes: "+(e.message||"Unknown error"))}).fail(function(e){r.showError("Error applying fixes: "+e.statusText)}).always(function(){r.setButtonLoading(e,!1),e.prop("disabled",!1).text(s)})},fixAllErrors:function(e){e.preventDefault();var e=i(e.target).closest("button"),s=i(".mds-error-item.auto-fixable").map(function(){return i(this).data("page-id")}).get();0===s.length?this.showError("No auto-fixable errors found."):(this.setButtonLoading(e,!0),e.prop("disabled",!0).text("Fixing all errors..."),this.fixErrorsBatch(s,0,e))},fixErrorsBatch:function(e,a,t){if(a>=e.length)this.setButtonLoading(t,!1),t.prop("disabled",!1).text("Fix All Auto-Fixable Errors"),this.showSuccess("Completed fixing all auto-fixable errors!"),setTimeout(()=>i("#mds-scan-errors").click(),1e3);else{var o=e[a];let s=i(`.mds-error-item[data-page-id="${o}"]`);s.css("opacity","0.5"),i.ajax({url:`/wp-json/mds/v1/pages/${o}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){e.success&&"active"===e.data.new_status?s.fadeOut():s.css("opacity","1")}).fail(function(){s.css("opacity","1")}).always(function(){setTimeout(()=>{r.fixErrorsBatch(e,a+1,t)},300)})}},refreshErrorItem:function(o){i.ajax({url:`/wp-json/mds/v1/pages/${o}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){var s,a,t;e.success&&e.data&&(s=i(`.mds-error-item[data-page-id="${o}"]`),a=(e=e.data).suggested_fixes&&e.suggested_fixes.some(e=>e.auto_fixable)?"auto-fixable":"manual-fix",t=e.validation_errors?e.validation_errors.slice(0,2).join(", "):"Unknown error",s.removeClass("auto-fixable manual-fix").addClass(a),s.find(".mds-error-item-details").html(`
                        <strong>Page Type:</strong> ${e.page_type||"Unknown"}<br>
                        <strong>Errors:</strong> ${t}
                    `))})},openModal:function(){this.modal.show(),i("body").addClass("modal-open")},closeModal:function(){this.modal.hide(),i("body").removeClass("modal-open"),this.currentPageId=null},showError:function(e){this.showNotice(e,"error")},showSuccess:function(e){this.showNotice(e,"success")},showNotice:function(s,a="info"){if(window.mdsPageManagement&&window.mdsPageManagement.showNotification)window.mdsPageManagement.showNotification(a,"error"===a?"Error":"success"===a?"Success":"Information",s);else{let e=i(`
                    <div class="notice notice-${a} is-dismissible" style="margin: 10px 0;">
                        <p>${s}</p>
                        <button type="button" class="notice-dismiss">
                            <span class="screen-reader-text">Dismiss this notice.</span>
                        </button>
                    </div>
                `);i(".wrap h1").after(e),setTimeout(()=>e.fadeOut(),5e3),e.on("click",".notice-dismiss",function(){e.fadeOut()})}},setButtonLoading:function(e,s){e=e.find(".dashicons");0!==e.length&&(s?(e.data("original-class")||e.data("original-class",e.attr("class")),e.removeClass().addClass("dashicons dashicons-update-alt").css({animation:"rotation 2s infinite linear"})):(s=e.data("original-class"))?(e.removeClass().attr("class",s).css("animation",""),e.removeData("original-class")):(e.removeClass("dashicons-update-alt").css("animation",""),e.hasClass("dashicons")||e.addClass("dashicons"),e.attr("class").includes("dashicons-")&&!e.hasClass("dashicons-update-alt")||e.addClass("dashicons-admin-tools")))}};i(document).ready(function(){r.init()}),window.MDSErrorResolution=r})(jQuery);