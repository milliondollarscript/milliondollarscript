!function(e){"use strict";const s={modal:null,currentPageId:null,init:function(){this.bindEvents(),this.setupModal(),this.bindPageListErrorHelpers()},bindEvents:function(){e("#mds-scan-errors").on("click.error-resolution",this.scanForErrors.bind(this)),e("#mds-repair-all-issues").on("click.error-resolution",this.fixAllErrors.bind(this)),e("#mds-fix-all-errors").on("click.error-resolution",this.fixAllErrors.bind(this)),e(document).on("click","#mds-modal-close, #mds-modal-cancel",this.closeModal.bind(this)),e(document).on("click","#mds-modal-fix",this.applyModalFix.bind(this)),e(document).on("click",".mds-error-view-details",this.viewErrorDetails.bind(this)),e(document).on("click",".mds-error-fix-single",this.fixSingleError.bind(this)),e(document).on("click",".mds-modal-overlay",(function(e){e.target===this&&s.closeModal()}))},setupModal:function(){this.modal=e("#mds-error-modal")},bindPageListErrorHelpers:function(){e(document).on("click",".mds-error-help",(function(t){t.preventDefault(),t.stopPropagation();const o=e(this).data("post-id");o&&s.showErrorDetails(o)}))},scanForErrors:function(t){t.preventDefault();const o=e(t.target).closest("button"),a=e("#mds-error-results");window.mdsPageManagement&&window.mdsPageManagement.showProgress&&window.mdsPageManagement.showProgress("Scanning for Page Errors","Analyzing pages for validation errors..."),a.hide(),this.setButtonLoading(o,!0),o.prop("disabled",!0),e.ajax({url:window.ajaxurl||"/wp-admin/admin-ajax.php",method:"POST",data:{action:"mds_scan_errors",nonce:window.mdsPageManagement?window.mdsPageManagement.nonce:""}}).done((function(e){if(e.success&&e.data){const t=e.data.errors||e.data;s.displayErrorResults(t)}else{let t="Scan failed",o=[];e.data?"string"==typeof e.data?t+=": "+e.data:e.data.message?(t+=": "+e.data.message,e.data.debug_info&&(e.data.debug_info.error&&o.push("Error: "+e.data.debug_info.error),e.data.debug_info.file&&e.data.debug_info.line&&o.push("Location: "+e.data.debug_info.file+":"+e.data.debug_info.line))):e.data.error?t+=": "+e.data.error:t+=": Unable to complete scan":t+=": No specific error information available",window.NotificationModal?window.NotificationModal.show("error","Scan Error",t,o.length>0?o:null):s.showError(t)}})).fail((function(e,t,o){let a="Unable to connect to server",n=[];e.status&&n.push("HTTP Status: "+e.status),t&&"error"!==t&&n.push("Status: "+t),o&&n.push("Error: "+o),window.NotificationModal?window.NotificationModal.show("error","Connection Error",a,n.length>0?n:null):s.showError(a)})).always((function(){window.mdsPageManagement&&window.mdsPageManagement.hideProgress&&window.mdsPageManagement.hideProgress(),s.setButtonLoading(o,!1),o.prop("disabled",!1)}))},displayErrorResults:function(s){const t=e("#mds-error-results"),o=e(".mds-error-list"),a=e("#mds-fix-all-errors");if(s&&Array.isArray(s)&&0!==s.length){let e="",t=0;s.forEach((function(s){const o=s.suggested_fixes&&s.suggested_fixes.some((e=>e.auto_fixable));o&&t++;const a=o?"auto-fixable":"manual-fix",n=s.validation_errors?s.validation_errors.slice(0,2).join(", "):"Unknown error";e+=`\n                        <div class="mds-error-item ${a}" data-page-id="${s.page_id}">\n                            <div class="mds-error-item-content">\n                                <div class="mds-error-item-title">${s.page_title} (ID: ${s.page_id})</div>\n                                <div class="mds-error-item-details">\n                                    <strong>Page Type:</strong> ${s.page_type||"Unknown"}<br>\n                                    <strong>Errors:</strong> ${n}\n                                </div>\n                            </div>\n                            <div class="mds-error-item-actions">\n                                <button type="button" class="button button-secondary mds-error-view-details" \n                                        data-page-id="${s.page_id}">\n                                    View Details\n                                </button>\n                                ${o?`\n                                <button type="button" class="button button-primary mds-error-fix-single" \n                                        data-page-id="${s.page_id}">\n                                    Fix Now\n                                </button>`:""}\n                            </div>\n                        </div>\n                    `})),o.html(e),t>0?a.show().find("span:last").text(`Fix All Auto-Fixable Errors (${t})`):a.hide()}else o.html('<div class="mds-no-errors"><p>No pages with errors found!</p></div>'),a.hide(),window.mdsPageManagement&&window.mdsPageManagement.showNotification&&window.mdsPageManagement.showNotification("success","Scan Complete","No pages with errors found! All pages appear to be functioning correctly.");t.show()},showErrorDetails:function(t){this.currentPageId=t,e.ajax({url:`/wp-json/mds/v1/pages/${t}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done((function(e){e.success&&e.data?(s.populateModal(e.data),s.openModal()):s.showError("Failed to load error details: "+(e.message||"Unknown error"))})).fail((function(e){s.showError("Error loading page details: "+e.statusText)}))},populateModal:function(s){const t=e("#mds-modal-title"),o=e("#mds-modal-body"),a=e("#mds-modal-fix");t.text(`Error Details: ${s.page_title}`);let n=`\n                <div class="mds-error-detail">\n                    <div class="mds-error-detail-label">Page Information</div>\n                    <div class="mds-error-detail-value">\n                        <strong>ID:</strong> ${s.page_id}<br>\n                        <strong>Type:</strong> ${s.page_type||"Unknown"}<br>\n                        <strong>Status:</strong> ${s.status}<br>\n                        <strong>Confidence Score:</strong> ${s.confidence_score}<br>\n                        <strong>Last Validated:</strong> ${s.last_validated||"Never"}\n                    </div>\n                </div>\n            `;if(s.validation_errors&&s.validation_errors.length>0&&(n+=`\n                    <div class="mds-error-detail">\n                        <div class="mds-error-detail-label">Validation Errors</div>\n                        <div class="mds-error-detail-value">\n                            ${s.validation_errors.map((e=>`â€¢ ${e}`)).join("<br>")}\n                        </div>\n                    </div>\n                `),s.suggested_fixes&&s.suggested_fixes.length>0){n+='<div class="mds-suggested-fixes">',n+='<div class="mds-error-detail-label">Suggested Fixes</div>',s.suggested_fixes.forEach((function(e){const s=e.auto_fixable?"mds-auto-fixable":"";n+=`\n                        <div class="mds-suggested-fix ${s}">\n                            <div class="mds-suggested-fix-title">\n                                ${e.title}\n                                ${e.auto_fixable?" (Auto-fixable)":" (Manual)"}\n                            </div>\n                            <div class="mds-suggested-fix-description">${e.description}</div>\n                        </div>\n                    `})),n+="</div>";s.suggested_fixes.some((e=>e.auto_fixable))?a.show().data("page-id",s.page_id):a.hide()}else a.hide();o.html(n)},viewErrorDetails:function(s){s.preventDefault();const t=e(s.target).data("page-id");this.showErrorDetails(t)},fixSingleError:function(s){s.preventDefault();const t=e(s.target).data("page-id"),o=e(s.target);this.applyFix(t,o)},applyModalFix:function(s){s.preventDefault();const t=e("#mds-modal-fix").data("page-id"),o=e("#mds-modal-fix");this.applyFix(t,o,!0)},applyFix:function(t,o,a=!1){const n=o.text();this.setButtonLoading(o,!0),o.prop("disabled",!0).text("Applying fixes..."),e.ajax({url:`/wp-json/mds/v1/pages/${t}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done((function(o){if(o.success&&o.data){const n=o.data.fixes_applied,i=o.data.new_status;if(n&&n.length>0){s.showSuccess(`Applied ${n.length} fix(es). New status: ${i}`);const o=e(`.mds-error-item[data-page-id="${t}"]`);"active"===i?o.fadeOut():s.refreshErrorItem(t),a&&setTimeout((()=>s.closeModal()),1500)}else s.showError("No fixes were applied. The page may already be fixed.")}else s.showError("Failed to apply fixes: "+(o.message||"Unknown error"))})).fail((function(e){s.showError("Error applying fixes: "+e.statusText)})).always((function(){s.setButtonLoading(o,!1),o.prop("disabled",!1).text(n)}))},fixAllErrors:function(s){s.preventDefault();const t=e(s.target).closest("button"),o=e(".mds-error-item.auto-fixable").map((function(){return e(this).data("page-id")})).get();0!==o.length?(this.setButtonLoading(t,!0),t.prop("disabled",!0).text("Fixing all errors..."),this.fixErrorsBatch(o,0,t)):this.showError("No auto-fixable errors found.")},fixErrorsBatch:function(t,o,a){if(o>=t.length)return this.setButtonLoading(a,!1),a.prop("disabled",!1).text("Fix All Auto-Fixable Errors"),this.showSuccess("Completed fixing all auto-fixable errors!"),void setTimeout((()=>e("#mds-scan-errors").click()),1e3);const n=t[o],i=e(`.mds-error-item[data-page-id="${n}"]`);i.css("opacity","0.5"),e.ajax({url:`/wp-json/mds/v1/pages/${n}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done((function(e){e.success&&"active"===e.data.new_status?i.fadeOut():i.css("opacity","1")})).fail((function(){i.css("opacity","1")})).always((function(){setTimeout((()=>{s.fixErrorsBatch(t,o+1,a)}),300)}))},refreshErrorItem:function(s){e.ajax({url:`/wp-json/mds/v1/pages/${s}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done((function(t){if(t.success&&t.data){const o=e(`.mds-error-item[data-page-id="${s}"]`),a=t.data,n=a.suggested_fixes&&a.suggested_fixes.some((e=>e.auto_fixable))?"auto-fixable":"manual-fix",i=a.validation_errors?a.validation_errors.slice(0,2).join(", "):"Unknown error";o.removeClass("auto-fixable manual-fix").addClass(n),o.find(".mds-error-item-details").html(`\n                        <strong>Page Type:</strong> ${a.page_type||"Unknown"}<br>\n                        <strong>Errors:</strong> ${i}\n                    `)}}))},openModal:function(){this.modal.show(),e("body").addClass("modal-open")},closeModal:function(){this.modal.hide(),e("body").removeClass("modal-open"),this.currentPageId=null},showError:function(e){this.showNotice(e,"error")},showSuccess:function(e){this.showNotice(e,"success")},showNotice:function(s,t="info"){if(window.mdsPageManagement&&window.mdsPageManagement.showNotification){const e="error"===t?"Error":"success"===t?"Success":"Information";window.mdsPageManagement.showNotification(t,e,s)}else{const o=e(`\n                    <div class="notice notice-${t} is-dismissible" style="margin: 10px 0;">\n                        <p>${s}</p>\n                        <button type="button" class="notice-dismiss">\n                            <span class="screen-reader-text">Dismiss this notice.</span>\n                        </button>\n                    </div>\n                `);e(".wrap h1").after(o),setTimeout((()=>o.fadeOut()),5e3),o.on("click",".notice-dismiss",(function(){o.fadeOut()}))}},setButtonLoading:function(e,s){const t=e.find(".dashicons");if(0!==t.length)if(s)t.data("original-class")||t.data("original-class",t.attr("class")),t.removeClass().addClass("dashicons dashicons-update-alt").css({animation:"rotation 2s infinite linear"});else{const e=t.data("original-class");e?(t.removeClass().attr("class",e).css("animation",""),t.removeData("original-class")):(t.removeClass("dashicons-update-alt").css("animation",""),t.hasClass("dashicons")||t.addClass("dashicons"),t.attr("class").includes("dashicons-")&&!t.hasClass("dashicons-update-alt")||t.addClass("dashicons-admin-tools"))}}};e(document).ready((function(){s.init()})),window.MDSErrorResolution=s}(jQuery);