!function(e){"use strict";const t={create:function(t,s,a,o=null){const n=e("<div>",{class:"mds-notification-modal",id:"mds-notification-modal"}),i=e("<div>",{class:"mds-modal-overlay"}),r=e("<div>",{class:`mds-modal-content mds-${t}`}),d=e("<div>",{class:"mds-modal-header"}).append(e("<h3>").text(s),e("<button>",{class:"mds-modal-close",type:"button","aria-label":"Close"}).html("&times;")),c=e("<div>",{class:"mds-modal-body"}).append(e("<div>",{class:`mds-notification-icon mds-${t}-icon`}),e("<div>",{class:"mds-notification-content"}).append(e("<p>").html(a)));if(o&&o.length>0){const t=e("<div>",{class:"mds-notification-details"}).append(e("<h4>").text("Details"),e("<ul>"));o.forEach((function(s){t.find("ul").append(e("<li>").text(s))})),c.find(".mds-notification-content").append(t)}const l=e("<div>",{class:"mds-modal-footer"}).append(e("<button>",{class:"button button-primary mds-modal-close",type:"button"}).text("OK"));return r.append(d,c,l),n.append(i,r),n},show:function(s,a,o,n=null,i=null){this.hide();const r=this.create(s,a,o,n);e("body").append(r),r.fadeIn(300),r.find(".mds-modal-content").addClass("mds-modal-show"),r.find(".mds-modal-close").on("click",(function(){t.hide(),i&&"function"==typeof i&&i()})),r.find(".mds-modal-overlay").on("click",(function(){t.hide()})),e(document).on("keydown.mds-modal",(function(e){27===e.keyCode&&t.hide()}))},hide:function(){const t=e("#mds-notification-modal, #mds-confirmation-modal");t.length&&(t.find(".mds-modal-content").removeClass("mds-modal-show"),t.fadeOut(300,(function(){t.remove()}))),e(document).off("keydown.mds-modal")},showConfirmation:function(s,a,o,n=null){this.hide();const i=e("<div>",{class:"mds-notification-modal",id:"mds-confirmation-modal"}),r=e("<div>",{class:"mds-modal-overlay"}),d=e("<div>",{class:"mds-modal-content mds-info"}),c=e("<div>",{class:"mds-modal-header"}).append(e("<h3>").text(s),e("<button>",{class:"mds-modal-close",type:"button","aria-label":"Close"}).html("&times;")),l=e("<div>",{class:"mds-modal-body"}).append(e("<div>",{class:"mds-notification-icon mds-info-icon"}),e("<div>",{class:"mds-notification-content"}).append(e("<p>").html(a))),m=e("<div>",{class:"mds-modal-footer"}).append(e("<button>",{class:"button mds-modal-cancel",type:"button"}).text("Cancel"),e("<button>",{class:"button button-primary mds-modal-confirm",type:"button"}).text("OK"));d.append(c,l,m),i.append(r,d),e("body").append(i),i.fadeIn(300),i.find(".mds-modal-content").addClass("mds-modal-show"),i.find(".mds-modal-close, .mds-modal-cancel, .mds-modal-overlay").on("click",(function(){t.hide(),n&&"function"==typeof n&&n()})),i.find(".mds-modal-confirm").on("click",(function(){t.hide(),o&&"function"==typeof o&&o()})),e(document).on("keydown.mds-modal",(function(e){27===e.keyCode&&(t.hide(),n&&"function"==typeof n&&n())}))}},s={config:{ajaxUrl:mdsPageManagement.ajaxUrl,nonce:mdsPageManagement.nonce,strings:mdsPageManagement.strings},progressInterval:null,currentProgress:0,operationState:{isRunning:!1,operationType:null,startTime:null},init:function(){this.bindEvents(),this.initializeFilters(),this.initializeModals(),this.loadInitialData()},bindEvents:function(){e("#mds-scan-all-pages").on("click",this.scanAllPages.bind(this)),e("#mds-repair-all-issues").on("click",this.repairAllPages.bind(this)),e("#mds-export-page-data").on("click",this.exportData.bind(this)),e("#mds-refresh-list").on("click",this.refreshData.bind(this)),"function"==typeof this.bulkUpdateImplementations&&e("#mds-bulk-update-implementations").on("click",this.bulkUpdateImplementations.bind(this)),"function"==typeof this.validateAllPages&&e("#mds-validate-all-pages").on("click",this.validateAllPages.bind(this)),e("#mds-scan-errors").on("click",this.scanForErrors.bind(this)),e("#mds-fix-all-errors").on("click",this.fixAllErrors.bind(this)),e("#mds-reset-page-statuses").on("click",this.resetPageStatuses.bind(this)),e(document).on("click",".mds-status-help-link",this.showPageErrorHelp.bind(this)),e("#mds-filter-form").on("submit",this.applyFilters.bind(this)),e(".mds-clear-filters").on("click",this.clearFilters.bind(this)),e(document).on("click",".mds-view-details",this.viewPageDetails.bind(this)),e(document).on("click",".mds-scan-page",this.scanSinglePage.bind(this)),e(document).on("click",".mds-repair-page",this.repairSinglePage.bind(this)),e(document).on("click",".mds-configure-page",this.configurePage.bind(this)),e(document).on("click",".mds-delete-page",this.deletePage.bind(this)),e(document).on("click",".mds-activate-page",this.activatePage.bind(this)),e(document).on("click",".mds-deactivate-page",this.deactivatePage.bind(this)),e("#doaction, #doaction2").on("click",this.handleBulkAction.bind(this)),e(document).on("click",".mds-modal-close",this.closeModal.bind(this)),e(document).on("click",".mds-modal",(function(e){e.target===this&&s.closeModal()})),mdsPageManagement.autoRefresh&&setInterval(this.refreshStats.bind(this),3e4)},initializeFilters:function(){let t;e("#mds-page-type-filter, #mds-status-filter, #mds-implementation-filter").on("change",(function(){e("#mds-filter-form").submit()})),e("#mds-search-input").on("input",(function(){clearTimeout(t),t=setTimeout((function(){e("#mds-filter-form").submit()}),500)}))},initializeModals:function(){},loadInitialData:function(){this.refreshStats()},startOperation:function(e){return this.operationState.isRunning?(this.showNotice("warning",`Another operation (${this.operationState.operationType}) is already running. Please wait for it to complete.`),!1):(this.operationState.isRunning=!0,this.operationState.operationType=e,this.operationState.startTime=Date.now(),!0)},endOperation:function(){this.operationState.isRunning=!1,this.operationState.operationType=null,this.operationState.startTime=null},isOperationRunning:function(){return this.operationState.isRunning},validateAllPages:function(a){a.preventDefault(),this.startOperation("Validate All Pages")&&(this.showProgress("Validating all pages...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_validate_pages_ajax",nonce:this.config.nonce},success:function(e){if(e.success){s.hideProgress();const a=e.data,o=`Validation completed: ${a.validated} pages checked, ${a.valid} valid, ${a.invalid} invalid, ${a.orphaned} orphaned.`;t.show("success","Validation Complete",o,null,(function(){window.location.reload()}))}else s.hideProgress(),s.showNotice("error",e.data.message||"An error occurred during validation.")},error:function(){s.hideProgress(),s.showNotice("error","An error occurred while validating pages.")},complete:function(){s.endOperation()}}))},scanAllPages:function(e){if(e.preventDefault(),!this.startOperation("Scan All Pages"))return;const s=this.config.strings.confirm_scan_all||"Are you sure you want to scan all pages? This will check all published pages for MDS content and may take some time.";t.showConfirmation("Confirm Scan All Pages",s,(()=>{this.startChunkedScan()}),(()=>{this.endOperation()}))},startChunkedScan:function(){this.showProgress("Initializing scan...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_scan_all_pages_start",nonce:this.config.nonce},success:function(e){e.success?s.processScanBatches(e.data):(s.showNotice("error",e.data||"Failed to initialize scan"),s.hideProgress(),s.endOperation())},error:function(){s.showNotice("error","An error occurred while initializing scan."),s.hideProgress(),s.endOperation()}})},processScanBatches:function(t){const{scan_id:a,total_pages:o,total_batches:n}=t;let i=0;const r=()=>{if(i>=n)return void this.completeScan(a,o);const t=`Scanning pages...<br>(${10*i+1}-${Math.min(10*(i+1),o)} of ${o})`;this.updateProgress(t,this.currentProgress),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_scan_all_pages_batch",scan_id:a,batch_number:i,nonce:this.config.nonce},success:function(e){if(e.success){const t=e.data;i++;const o=`Processed ${t.processed_pages} of ${t.total_pages} pages<br>(${t.found_pages} MDS pages found)`;s.updateProgress(o,t.progress_percentage),t.is_complete?s.completeScan(a,t.total_pages,t.found_pages):setTimeout(r,200)}else s.showNotice("error",e.data||"Batch processing failed"),s.hideProgress(),s.endOperation()},error:function(){s.showNotice("error",`Error processing batch ${i+1}`),s.hideProgress(),s.endOperation()}})};r()},completeScan:function(e,a,o){this.updateProgress("Scan completed!",100),setTimeout((()=>{this.hideProgress(),this.endOperation();const e=void 0!==o?`Scan completed! Processed ${a} pages and found ${o} MDS pages.`:`Scan completed! Processed ${a} pages.`;t.show("success","Scan Complete",e,null,(function(){s.refreshData()}))}),4e3)},repairAllPages:function(a){a.preventDefault();const o=this.config.strings.confirm_repair_all||"Are you sure you want to repair all pages with issues?";t.showConfirmation("Confirm Repair All",o,(()=>{this.showProgress("Repairing pages...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_repair_all_pages",nonce:this.config.nonce},success:function(e){if(e.success){const a="Repair Complete";t.show("success",a,e.data.message,null,(function(){s.refreshData()}))}else s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while repairing pages.")},complete:function(){s.hideProgress()}})}))},exportData:function(t){t.preventDefault();const s=e(t.target).data("format")||"json",a=e(t.target).data("include-content")||!1,o=e("<form>").attr("method","POST").attr("action",this.config.ajaxUrl).css("display","none");o.append(e("<input>").attr("name","action").val("mds_export_page_data")),o.append(e("<input>").attr("name","nonce").val(this.config.nonce)),o.append(e("<input>").attr("name","format").val(s)),o.append(e("<input>").attr("name","include_content").val(a?"1":"")),e("body").append(o),o.submit(),o.remove(),this.showNotice("success","Export started. Download should begin shortly.")},refreshData:function(e){e&&e.preventDefault(),this.showProgress("Refreshing data...",0),window.location.reload()},refreshStats:function(){e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_get_page_stats",nonce:this.config.nonce},success:function(e){e.success&&s.updateStats(e.data)}})},updateStats:function(t){e(".mds-stat-card.total .mds-stat-number").text(t.total||0),e(".mds-stat-card.active .mds-stat-number").text(t.active||0),e(".mds-stat-card.needs-attention .mds-stat-number").text(t.needs_attention||0),e(".mds-stat-card.auto-detected .mds-stat-number").text(t.auto_detected||0)},applyFilters:function(t){t.preventDefault();const s=e(t.target).serialize(),a=new URL(window.location);new URLSearchParams(s).forEach(((e,t)=>{e?a.searchParams.set(t,e):a.searchParams.delete(t)})),window.location.href=a.toString()},clearFilters:function(t){t.preventDefault(),e("#mds-filter-form")[0].reset();const s=new URL(window.location);s.search="",window.location.href=s.toString()},viewPageDetails:function(t){t.preventDefault();const a=e(t.target).closest("[data-page-id]").data("page-id");this.showProgress("Loading page details...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_get_page_details",page_id:a,nonce:this.config.nonce},success:function(e){e.success?s.showPageDetailsModal(e.data):s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while loading page details.")},complete:function(){s.hideProgress()}})},scanSinglePage:function(a){a.preventDefault();const o=e(a.target).closest("[data-page-id]").data("page-id"),n=e(a.target).closest("button");n.prop("disabled",!0).html('<span class="mds-spinner"></span> Scanning...'),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_scan_single_page",page_id:o,nonce:this.config.nonce},success:function(e){if(e.success)if(e.data.offer_removal){const a="Page is Not an MDS Page",o=e.data.message+"<br><br>Would you like to remove this page from MDS management? The WordPress page will not be deleted.";t.showConfirmation(a,o,(()=>{s.removePageFromList(e.data.page_id,e.data.page_title)}),(()=>{window.location.reload()}))}else{const s="Page Scan Complete";t.show("success",s,e.data.message,null,(function(){window.location.reload()}))}else s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while scanning the page.")},complete:function(){n.prop("disabled",!1).html('<span class="dashicons dashicons-search"></span>')}})},repairSinglePage:function(a){a.preventDefault();const o=e(a.target).closest("[data-page-id]").data("page-id"),n=e(a.target).closest("button"),i=this.config.strings.confirm_repair_page||"Are you sure you want to repair this page?";t.showConfirmation("Confirm Repair",i,(()=>{n.prop("disabled",!0).html('<span class="mds-spinner"></span> Repairing...'),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_repair_single_page",page_id:o,nonce:this.config.nonce},success:function(e){if(e.success){const s="Page Repair Complete";t.show("success",s,e.data.message),setTimeout((function(){window.location.reload()}),2e3)}else s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while repairing the page.")},complete:function(){n.prop("disabled",!1).html('<span class="dashicons dashicons-admin-tools"></span>')}})}),(()=>{}))},deletePage:function(a){a.preventDefault();const o=e(a.target).closest("[data-page-id]").data("page-id"),n=`Are you sure you want to delete "${e(a.target).closest("tr").find(".row-title").text()}"? This action cannot be undone.`;t.showConfirmation("Confirm Delete",n,(()=>{this.showProgress("Deleting page...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_delete_page",page_id:o,nonce:this.config.nonce},success:function(e){e.success?t.show("success","Page Deleted",e.data.message,null,(function(){window.location.reload()})):s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while deleting the page.")},complete:function(){s.hideProgress()}})}),(()=>{}))},activatePage:function(a){a.preventDefault();const o=e(a.target).closest("[data-page-id]").data("page-id"),n=e(a.target).closest("button");n.prop("disabled",!0).html('<span class="mds-spinner"></span>'),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_activate_page",page_id:o,nonce:this.config.nonce},success:function(e){e.success?t.show("success","Page Activated",e.data.message,null,(function(){window.location.reload()})):s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while activating the page.")},complete:function(){n.prop("disabled",!1).html('<span class="dashicons dashicons-yes"></span>')}})},deactivatePage:function(a){a.preventDefault();const o=e(a.target).closest("[data-page-id]").data("page-id"),n=e(a.target).closest("button");n.prop("disabled",!0).html('<span class="mds-spinner"></span>'),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_deactivate_page",page_id:o,nonce:this.config.nonce},success:function(e){e.success?t.show("success","Page Deactivated",e.data.message,null,(function(){window.location.reload()})):s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while deactivating the page.")},complete:function(){n.prop("disabled",!1).html('<span class="dashicons dashicons-minus"></span>')}})},removePageFromList:function(a,o,n){let i,r;"function"==typeof o?(i=null,r=o):(i=o,r=n),this.showProgress("Removing from MDS management...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_bulk_page_action",action_type:"remove_from_list",page_ids:[a],nonce:this.config.nonce},success:function(e){if(e.success){const e=i||`Page ID ${a}`;r&&"function"==typeof r?r():t.show("success","Removed from Management",`"${e}" has been removed from MDS management. The WordPress page was not deleted.`,null,(function(){window.location.reload()}))}else s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while removing the page from management.")},complete:function(){s.hideProgress()}})},configurePage:function(t){t.preventDefault();const a=e(t.target).closest("[data-page-id]").data("page-id");this.showProgress("Loading configuration...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_get_page_config",page_id:a,nonce:this.config.nonce},success:function(e){e.success?s.showConfigurationModal(e.data):s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while loading configuration.")},complete:function(){s.hideProgress()}})},handleBulkAction:function(a){a.preventDefault();const o=e(a.target).siblings("select").val(),n=e('input[name="page_ids[]"]:checked').map((function(){return this.value})).get();if(!o||0===n.length)return void this.showNotice("warning","Please select pages and an action.");const i=`Are you sure you want to ${o} ${n.length} page(s)?`;t.showConfirmation("Confirm Bulk Action",i,(()=>{this.showProgress(`Processing ${o}...`,0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_bulk_page_action",action_type:o,page_ids:n,nonce:this.config.nonce},success:function(e){if(e.success){const s="Bulk Action Complete";t.show("success",s,e.data.message),setTimeout((function(){window.location.reload()}),2e3)}else s.showNotice("error",e.data.message)},error:function(){s.showNotice("error","An error occurred while processing the bulk action.")},complete:function(){s.hideProgress()}})}),(()=>{}))},showPageDetailsModal:function(a){e("#mds-page-details-content").html(a.html),e("#mds-page-details-modal").dialog({modal:!0,width:800,maxHeight:.8*e(window).height(),resizable:!0,draggable:!0,close:function(){e("#mds-page-details-content").empty()}}),e(".mds-fix-error-btn").off("click").on("click",(function(){const a=e(this).data("page-id"),o=e(this).data("error");t.showConfirmation("Confirm Fix Error","Are you sure you want to fix this error?",(()=>{const t=e(this);t.prop("disabled",!0).text("Fixing..."),e.ajax({url:s.config.ajaxUrl,type:"POST",data:{action:"mds_fix_single_page_error",page_id:a,error:JSON.stringify(o),nonce:s.config.nonce},success:function(e){e.success?(s.showNotice("success","Error fixed successfully"),t.closest(".mds-error-item").fadeOut(),setTimeout((function(){window.location.reload()}),1e3)):s.showNotice("error","Fix failed: "+e.data)},error:function(){s.showNotice("error","An error occurred while applying the fix.")},complete:function(){t.prop("disabled",!1).text("Fix This Error")}})}),(()=>{}))}))},showConfigurationModal:function(t){const a=`\n                <form id="mds-page-config-form" data-original-implementation="${t.content_type}">\n                    <input type="hidden" name="page_id" value="${t.page_id}">\n                    <table class="form-table">\n                        <tr>\n                            <th><label for="page_type">Page Type</label></th>\n                            <td>\n                                <select name="page_type" id="page_type">\n                                    ${this.getPageTypeOptions(t.page_type)}\n                                </select>\n                            </td>\n                        </tr>\n                        <tr>\n                            <th><label for="implementation_type">Implementation</label></th>\n                            <td>\n                                <select name="implementation_type" id="implementation_type">\n                                    ${this.getImplementationOptions(t.content_type)}\n                                </select>\n                            </td>\n                        </tr>\n                        <tr>\n                            <th><label for="auto_scan">Auto Scan</label></th>\n                            <td>\n                                <input type="checkbox" name="auto_scan" id="auto_scan" ${t.auto_scan?"checked":""}>\n                                <label for="auto_scan">Automatically scan this page for changes</label>\n                            </td>\n                        </tr>\n                    </table>\n                </form>\n            `;e("#mds-page-config-modal").html(a),e("#mds-page-config-modal").dialog({modal:!0,title:"Configure Page: "+t.title,width:600,maxHeight:.8*e(window).height(),resizable:!0,draggable:!0,buttons:{Cancel:function(){e(this).dialog("close")},"Save Configuration":function(){s.savePageConfig()}},close:function(){e("#mds-page-config-modal").empty()}})},getPageTypeOptions:function(e){const t={grid:"Pixel Grid",order:"Order Page","write-ad":"Write Advertisement","confirm-order":"Order Confirmation",payment:"Payment Processing",manage:"Manage Ads","thank-you":"Thank You",list:"Advertiser List",upload:"File Upload","no-orders":"No Orders"};let s="";for(const[a,o]of Object.entries(t))s+=`<option value="${a}" ${a===e?"selected":""}>${o}</option>`;return s},getImplementationOptions:function(e){const t={shortcode:"Shortcode",block:"Block"};let s="";for(const[a,o]of Object.entries(t))s+=`<option value="${a}" ${a===e?"selected":""}>${o}</option>`;return s},savePageConfig:function(){const s=e("#mds-page-config-form").serialize(),a=e("#mds-page-config-form").data("original-implementation"),o=e("#implementation_type").val();a&&a!==o?t.showConfirmation("Confirm Implementation Change","Changing the implementation type will convert the page content. Are you sure you want to continue?",(()=>{this.performSavePageConfig(s)}),(()=>{})):this.performSavePageConfig(s)},performSavePageConfig:function(a){e.ajax({url:this.config.ajaxUrl,type:"POST",data:a+"&action=mds_save_page_config&nonce="+this.config.nonce+"&convert_implementation=1",success:function(a){if(a.success){const s="Configuration Saved";t.show("success",s,a.data.message),e("#mds-page-config-modal").dialog("close"),setTimeout((function(){window.location.reload()}),2e3)}else s.showNotice("error",a.data.message)},error:function(){s.showNotice("error","An error occurred while saving configuration.")}})},closeModal:function(){e("#mds-page-details-modal").hasClass("ui-dialog-content")&&e("#mds-page-details-modal").dialog("close"),e("#mds-page-config-modal").hasClass("ui-dialog-content")&&e("#mds-page-config-modal").dialog("close")},showProgress:function(t,s=0){if(0!==s||e("#mds-progress-indicator").length||(this.currentProgress=0),!e("#mds-progress-indicator").length){const a=e("<div>",{class:"mds-notification-modal",id:"mds-progress-indicator"}),o=e("<div>",{class:"mds-modal-overlay"}),n=e("<div>",{class:"mds-modal-content mds-progress-content"}),i=e("<div>",{class:"mds-modal-header"}).append(e("<h3>").text("Processing...")),r=e("<div>",{class:"mds-modal-body"}).append(e("<div>",{class:"mds-progress-spinner"}).append(e("<div>",{class:"mds-spinner"})),e("<div>",{class:"mds-progress"}).append(e("<div>",{class:"mds-progress-bar",id:"mds-progress-bar",style:`width: ${Math.max(s,10)}%`}).text(Math.round(s)+"%")),e("<p>",{class:"mds-progress-message",id:"mds-progress-message"}).text(t));n.append(i,r),a.append(o,n),e("body").append(a)}const a=Math.max(s,this.currentProgress);this.currentProgress=a;const o=Math.max(a,10);e("#mds-progress-message").html(t),e("#mds-progress-bar").css("width",o+"%").text(Math.round(a)+"%");const n=e("#mds-progress-indicator");n.fadeIn(300),n.find(".mds-modal-content").addClass("mds-modal-show"),0===s&&0===this.currentProgress&&this.startSimulatedProgress()},updateProgress:function(t,s){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null);const a=Math.max(s,this.currentProgress);this.currentProgress=a;const o=Math.max(a,10);e("#mds-progress-message").html(t),e("#mds-progress-bar").css("width",o+"%").text(Math.round(a)+"%")},startSimulatedProgress:function(){this.progressInterval&&clearInterval(this.progressInterval);let t=Math.max(this.currentProgress,10);this.progressInterval=setInterval((()=>{if(!this.progressInterval)return;const s=3*Math.random()+1;t=Math.min(t+s,75),this.currentProgress=t;const a=e("#mds-progress-bar");a.length&&a.css("width",t+"%").text(Math.round(t)+"%"),t>=75&&(clearInterval(this.progressInterval),this.progressInterval=null)}),300+200*Math.random())},hideProgress:function(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),this.currentProgress=0;const t=e("#mds-progress-indicator");t.length&&(t.find(".mds-modal-content").removeClass("mds-modal-show"),t.fadeOut(300,(function(){t.remove()})))},scanForErrors:function(a){a.preventDefault();const o=e(a.target),n=e("#mds-error-results"),i=e("#mds-error-progress"),r=e("#mds-error-progress-text"),d=e("#mds-fix-all-errors");o.prop("disabled",!0),i.show(),r.text("Scanning for errors..."),n.hide(),d.hide(),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_scan_errors",nonce:this.config.nonce},success:function(e){if(e.success)s.displayErrorResults(e.data),e.data.auto_fixable>0&&d.show().text(`Fix ${e.data.auto_fixable} Auto-Fixable Errors`);else{let s="Scan failed",a=[];e.data?"string"==typeof e.data?s+=": "+e.data:e.data.message?(s+=": "+e.data.message,e.data.debug_info&&(e.data.debug_info.error&&a.push("Error: "+e.data.debug_info.error),e.data.debug_info.file&&e.data.debug_info.line&&a.push("Location: "+e.data.debug_info.file+":"+e.data.debug_info.line))):e.data.error?s+=": "+e.data.error:s+=": Unable to complete scan":s+=": No specific error information available",t.show("error","Scan Error",s,a.length>0?a:null)}},error:function(e,s,a){let o=[];e.status&&o.push("HTTP Status: "+e.status),s&&"error"!==s&&o.push("Status: "+s),a&&o.push("Error: "+a),t.show("error","Connection Error","Unable to connect to server",o.length>0?o:null)},complete:function(){o.prop("disabled",!1),i.hide()}})},fixAllErrors:function(a){a.preventDefault(),t.showConfirmation("Confirm Fix All Errors","Are you sure you want to fix all auto-fixable errors? This will modify page content.",(()=>{const t=e(a.target),o=e("#mds-error-progress"),n=e("#mds-error-progress-text");t.prop("disabled",!0),o.show(),n.text("Fixing errors..."),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_fix_all_errors",nonce:this.config.nonce},success:function(t){t.success?(s.showNotice("success",t.data.message),e("#mds-scan-errors").trigger("click"),s.refreshStats()):s.showNotice("error","Error fixing failed: "+t.data)},error:function(){s.showNotice("error","An error occurred while fixing errors.")},complete:function(){t.prop("disabled",!1),o.hide()}})}),(()=>{}))},resetPageStatuses:function(a){a.preventDefault(),t.showConfirmation("Confirm Reset Page Statuses","Are you sure you want to reset all page statuses? This will re-validate all pages and update their statuses based on current validation rules.",(()=>{const t=e(a.target).closest("button"),o=e("#mds-error-progress"),n=e("#mds-error-progress-text");this.setButtonLoading(t,!0),t.prop("disabled",!0),o.show(),n.text("Resetting page statuses..."),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_reset_page_statuses",nonce:this.config.nonce},success:function(e){e.success?(s.showNotice("success",e.data.message),setTimeout((function(){window.location.reload()}),1500)):s.showNotice("error","Status reset failed: "+e.data)},error:function(){s.showNotice("error","An error occurred while resetting page statuses.")},complete:function(){s.setButtonLoading(t,!1),t.prop("disabled",!1),o.hide()}})}),(()=>{}))},displayErrorResults:function(t){const s=e("#mds-error-results"),a=s.find(".mds-error-list");if(0===t.total_errors)a.html('<div class="mds-no-errors"><p>No errors found! All pages appear to be functioning correctly.</p></div>');else{let e="";t.errors.forEach((function(t){const s=t.auto_fixable?"auto-fixable":"manual-fix",a="high"===t.severity?"critical":"";e+=`\n                        <div class="mds-error-item ${s} ${a}" data-page-id="${t.page_id}">\n                            <div class="mds-error-item-content">\n                                <div class="mds-error-item-title">\n                                    <span class="dashicons dashicons-warning"></span>\n                                    ${t.page_title} - ${t.message}\n                                </div>\n                                <div class="mds-error-item-details">\n                                    ${t.description}\n                                </div>\n                                <div class="mds-error-item-meta">\n                                    <span class="error-type">Type: ${t.type}</span>\n                                    <span class="error-severity">Severity: ${t.severity}</span>\n                                    <span class="error-fixable">${t.auto_fixable?"Auto-fixable":"Manual fix required"}</span>\n                                </div>\n                            </div>\n                            <div class="mds-error-item-actions">\n                                <button type="button" class="button button-small mds-view-error-details" data-error='${JSON.stringify(t)}'>\n                                    Details\n                                </button>\n                                ${t.auto_fixable?'<button type="button" class="button button-primary button-small mds-fix-single-error" data-error=\''+JSON.stringify(t)+"'>Fix</button>":""}\n                            </div>\n                        </div>\n                    `})),a.html(e)}s.show(),e(".mds-view-error-details").off("click").on("click",this.showErrorDetails.bind(this)),e(".mds-fix-single-error").off("click").on("click",this.fixSingleError.bind(this))},showErrorDetails:function(s){const a=JSON.parse(e(s.target).attr("data-error"));let o=`\n                <div class="mds-error-detail">\n                    <div class="mds-error-detail-label">Page:</div>\n                    <div class="mds-error-detail-value">${a.page_title} (ID: ${a.page_id})</div>\n                </div>\n                <div class="mds-error-detail">\n                    <div class="mds-error-detail-label">Error Type:</div>\n                    <div class="mds-error-detail-value">${a.type}</div>\n                </div>\n                <div class="mds-error-detail">\n                    <div class="mds-error-detail-label">Severity:</div>\n                    <div class="mds-error-detail-value">${a.severity}</div>\n                </div>\n                <div class="mds-error-detail">\n                    <div class="mds-error-detail-label">Description:</div>\n                    <div class="mds-error-detail-value">${a.description}</div>\n                </div>\n            `;if(a.suggested_fix&&(o+=`\n                    <div class="mds-suggested-fixes">\n                        <h4>Suggested Fix:</h4>\n                        <div class="mds-suggested-fix ${a.auto_fixable?"mds-auto-fixable":""}">\n                            <div class="mds-suggested-fix-title">${a.auto_fixable?"Automatic Fix Available":"Manual Fix Required"}</div>\n                            <div class="mds-suggested-fix-description">\n                                <code>${a.suggested_fix}</code>\n                            </div>\n                        </div>\n                    </div>\n                `),e("#mds-error-modal").length)e("#mds-modal-title").text("Error Details"),e("#mds-modal-body").html(o),e("#mds-modal-fix").toggle(a.auto_fixable).attr("data-error",JSON.stringify(a)),e("#mds-error-modal").show();else{const e=`\n                    <strong>Page:</strong> ${a.page_title}<br>\n                    <strong>Type:</strong> ${a.type}<br>\n                    <strong>Description:</strong> ${a.description}\n                `;t.show("info","Error Details",e)}},fixSingleError:function(a){const o=JSON.parse(e(a.target).attr("data-error")),n=e(a.target);t.showConfirmation("Confirm Fix Error",`Are you sure you want to fix this error on "${o.page_title}"?`,(()=>{n.prop("disabled",!0).text("Fixing..."),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_fix_single_error",error:JSON.stringify(o),nonce:this.config.nonce},success:function(e){e.success?(s.showNotice("success","Error fixed successfully"),n.closest(".mds-error-item").fadeOut(),s.refreshStats()):s.showNotice("error","Fix failed: "+e.data)},error:function(){s.showNotice("error","An error occurred while applying the fix.")},complete:function(){n.prop("disabled",!1).text("Fix")}})}),(()=>{}))},showPageErrorHelp:function(t){t.preventDefault();const a=e(t.target).closest("[data-page-id]").data("page-id")||e(t.target).data("page-id");a?(this.showProgress("Scanning page for specific errors...",0),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_scan_page_errors",page_id:a,nonce:this.config.nonce},success:function(e){e.success?e.data.errors&&e.data.errors.length>0?s.showPageErrorModal(e.data,a):s.showNotice("info","No specific errors found for this page. It may have resolved automatically."):s.showNotice("error","Error scanning failed: "+e.data)},error:function(){s.showNotice("error","An error occurred while scanning the page.")},complete:function(){s.hideProgress()}})):this.showNotice("error","Unable to identify page for error scanning")},showPageErrorModal:function(s,a){const o=s.errors;let n=`\n                <div class="mds-page-error-help">\n                    <h3>Errors found for: ${s.page_title||"Page ID "+a}</h3>\n                    <p>The following issues were detected on this page:</p>\n                    <div class="mds-page-errors-list">\n            `;if(o.forEach((function(e){const t=e.auto_fixable?'<span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span>':'<span class="dashicons dashicons-warning" style="color: #ffb900;"></span>';n+=`\n                    <div class="mds-page-error-item ${e.auto_fixable?"auto-fixable":"manual-fix"}">\n                        <div class="mds-error-header">\n                            ${t}\n                            <strong>${e.message}</strong>\n                            <span class="mds-error-severity mds-severity-${e.severity}">${e.severity}</span>\n                        </div>\n                        <div class="mds-error-description">${e.description}</div>\n                        ${e.suggested_fix?`<div class="mds-error-fix"><strong>Suggested Fix:</strong> <code>${e.suggested_fix}</code></div>`:""}\n                        ${e.auto_fixable?`<button type="button" class="button button-primary button-small mds-fix-page-error" data-page-id="${a}" data-error='${JSON.stringify(e)}'>Apply Fix</button>`:"<p><em>This error requires manual intervention.</em></p>"}\n                    </div>\n                `})),n+=`\n                    </div>\n                    <div class="mds-error-help-actions">\n                        <button type="button" class="button button-secondary mds-rescan-page" data-page-id="${a}">Re-scan Page</button>\n                        <button type="button" class="button mds-view-all-errors">View All Page Errors</button>\n                    </div>\n                </div>\n            `,e.fn.dialog)0===e("#mds-page-error-help-modal").length&&e("body").append('<div id="mds-page-error-help-modal" style="display: none;"></div>'),e("#mds-page-error-help-modal").html(n),e("#mds-page-error-help-modal").dialog({title:"Page Error Details & Solutions",modal:!0,width:700,maxHeight:.8*e(window).height(),resizable:!0,draggable:!0,close:function(){e(this).empty()}}),e(".mds-fix-page-error").on("click",this.fixSinglePageError.bind(this)),e(".mds-rescan-page").on("click",(function(){e("#mds-page-error-help-modal").dialog("close"),e(`.mds-status-help-link[data-page-id="${a}"]`).trigger("click")})),e(".mds-view-all-errors").on("click",(function(){e("#mds-page-error-help-modal").dialog("close"),e("#mds-scan-errors").trigger("click"),setTimeout((function(){e("html, body").animate({scrollTop:e("#mds-error-results").offset().top-50},500)}),500)}));else{const e=o.map((e=>`â€¢ ${e.message}: ${e.description}`)).join("<br>");t.show("warning","Page Errors Found",e)}},fixSinglePageError:function(a){const o=e(a.target).data("page-id"),n=JSON.parse(e(a.target).attr("data-error")),i=e(a.target);t.showConfirmation("Confirm Fix Error",`Fix this error: "${n.message}"?`,(()=>{i.prop("disabled",!0).text("Fixing..."),e.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"mds_fix_single_page_error",page_id:o,error:JSON.stringify(n),nonce:this.config.nonce},success:function(e){e.success?(s.showNotice("success","Error fixed successfully"),i.closest(".mds-page-error-item").fadeOut(),s.refreshStats(),setTimeout((function(){window.location.reload()}),1e3)):s.showNotice("error","Fix failed: "+e.data)},error:function(){s.showNotice("error","An error occurred while applying the fix.")},complete:function(){i.prop("disabled",!1).text("Apply Fix")}})}),(()=>{}))},showValidationResults:function(a){let o=`\n                <div class="mds-validation-results">\n                    <div class="mds-validation-summary">\n                        <p><strong>Validation Summary:</strong></p>\n                        <ul>\n                            <li>Pages checked: ${a.total_checked}</li>\n                            <li>Still valid: ${a.still_valid}</li>\n                            <li>Invalid pages: ${a.invalid_pages.length}</li>\n                        </ul>\n                    </div>\n            `;a.invalid_pages.length>0?(o+='\n                    <div class="mds-invalid-pages">\n                        <h4>Pages that no longer appear to be MDS pages:</h4>\n                        <div class="mds-invalid-pages-list">\n                ',a.invalid_pages.forEach((function(e){o+=`\n                        <div class="mds-invalid-page-item" data-page-id="${e.id}">\n                            <div class="mds-invalid-page-info">\n                                <strong>${e.title}</strong>\n                                <div class="mds-invalid-page-reason">${e.reason}</div>\n                            </div>\n                            <div class="mds-invalid-page-actions">\n                                <button type="button" class="button button-small mds-remove-invalid-page" data-page-id="${e.id}">\n                                    <span class="dashicons dashicons-trash"></span>\n                                    Remove from MDS Management\n                                </button>\n                            </div>\n                        </div>\n                    `})),o+='\n                        </div>\n                        <div class="mds-validation-bulk-actions">\n                            <button type="button" class="button button-primary" id="mds-remove-all-invalid">\n                                <span class="dashicons dashicons-trash"></span>\n                                Remove All Invalid Pages\n                            </button>\n                            <button type="button" class="button button-secondary" id="mds-validation-refresh">\n                                <span class="dashicons dashicons-update"></span>\n                                Refresh Page\n                            </button>\n                        </div>\n                    </div>\n                '):o+='\n                    <div class="mds-validation-no-invalid">\n                        <h4>All pages are valid!</h4>\n                        <p>All pages in MDS management still contain proper MDS content and are functioning correctly.</p>\n                    </div>\n                ',a.errors.length>0&&(o+='\n                    <div class="mds-validation-errors">\n                        <h4>Errors during validation:</h4>\n                        <ul>\n                ',a.errors.forEach((function(e){o+=`<li>Page ID ${e.page_id}: ${e.error}</li>`})),o+="\n                        </ul>\n                    </div>\n                "),o+="</div>";const n=e("<div>",{class:"mds-notification-modal",id:"mds-validation-results-modal"}),i=e("<div>",{class:"mds-modal-overlay"}),r=e("<div>",{class:"mds-modal-content mds-validation-modal"}),d=e("<div>",{class:"mds-modal-header"}).append(e("<h3>").text("Validation Results"),e("<button>",{class:"mds-modal-close",type:"button","aria-label":"Close"}).html("&times;")),c=e("<div>",{class:"mds-modal-body"}).html(o);r.append(d,c),n.append(i,r),e("body").append(n),n.fadeIn(300),n.find(".mds-modal-content").addClass("mds-modal-show"),n.find(".mds-modal-close, .mds-modal-overlay").on("click",(function(){n.fadeOut(300,(function(){n.remove(),window.location.reload()}))})),n.on("click",".mds-remove-invalid-page",(function(){const a=e(this).data("page-id"),o=e(this),i=o.closest(".mds-invalid-page-item"),r=i.find("strong").text();n.hide(),t.showConfirmation("Remove from MDS Management",`Are you sure you want to remove "${r}" from MDS management? This will not delete the WordPress page.`,(()=>{n.show(),o.prop("disabled",!0).html('<span class="dashicons dashicons-trash"></span> Removing...'),s.removePageFromList(a,(function(){i.fadeOut((function(){0===n.find(".mds-invalid-page-item:visible").length?n.fadeOut(300,(function(){n.remove(),t.show("success","All Invalid Pages Removed","All invalid pages have been removed from MDS management.",null,(function(){window.location.reload()}))})):o.prop("disabled",!1).html('<span class="dashicons dashicons-trash"></span> Remove from MDS Management')}))}))}),(()=>{n.show()}))})),n.on("click","#mds-remove-all-invalid",(function(){const o=e(this),i=a.invalid_pages.map((e=>e.id));n.hide(),t.showConfirmation("Remove All Invalid Pages",`Are you sure you want to remove all ${i.length} invalid pages from MDS management? This will not delete the WordPress pages.`,(()=>{n.show(),o.prop("disabled",!0).text("Removing...");let e=0;i.forEach((function(a){s.removePageFromList(a,(function(){e++,e===i.length&&n.fadeOut(300,(function(){n.remove(),t.show("success","Bulk Removal Complete",`${i.length} pages have been removed from MDS management.`,null,(function(){window.location.reload()}))}))}))}))}),(()=>{n.show()}))})),n.on("click","#mds-validation-refresh",(function(){n.fadeOut(300,(function(){n.remove(),window.location.reload()}))}))},showNotice:function(e,s){const a="error"===e?"Error":"success"===e?"Success":"warning"===e?"Warning":"Information";t.show(e,a,s)},setButtonLoading:function(e,t){const s=e.find(".dashicons");if(t)s.data("original-class")||s.data("original-class",s.attr("class")),s.removeClass().addClass("dashicons dashicons-update-alt").css({animation:"rotation 2s infinite linear"});else{const e=s.data("original-class");e&&(s.removeClass().attr("class",e).css("animation",""),s.removeData("original-class"))}}};e(document).ready((function(){"undefined"!=typeof mdsPageManagement&&mdsPageManagement?s.init():console.error("MDS Page Management: Localization object not found. Please ensure the page management interface is properly loaded.")})),window.MDSPageManagement=s}(jQuery);