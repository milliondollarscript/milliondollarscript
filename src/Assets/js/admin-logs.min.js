jQuery(document).ready(function($){var $logViewer=$("#mds-log-viewer");var $spinner=$("#mds-log-spinner");var $toggleLoggingCheckbox=$("#mds-toggle-logging");var $toggleLiveUpdateCheckbox=$("#mds-toggle-live-update");var $clearLogButton=$("#mds-clear-log");var liveUpdateInterval=null;var lastLogSize=0;function showSpinner(){$spinner.addClass("is-active")}function hideSpinner(){$spinner.removeClass("is-active")}function showNotice(message,type){var noticeHtml='<div class="notice notice-'+type+' is-dismissible"><p>'+message+'</p><button type="button" class="notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button></div>';$("#mds-logs-page h1").after(noticeHtml);$(document).on("click","#mds-logs-page .notice-dismiss",function(){$(this).closest(".notice").remove()})}function renderLogEntries(entries){var html="";if(!entries||entries.length===0){return""}html+='<ul class="mds-log-entries">';entries.forEach(function(entry){html+='<li class="mds-log-entry mds-log-level-'+(entry.level?entry.level.toLowerCase():"raw")+'">';html+='<span class="mds-log-timestamp">['+(entry.timestamp||"No timestamp")+"]</span> ";html+='<span class="mds-log-level">['+(entry.level||"RAW")+"]</span> ";html+='<span class="mds-log-message">'+(entry.message||"")+"</span>";if(entry.count&&entry.count>1){html+=' <span class="mds-log-count">(x'+entry.count+")</span>"}html+="</li>"});html+="</ul>";return html}function fetchLogEntries(incremental=false){var ajaxData={action:"mds_fetch_log_entries",nonce:mdsLogsData.nonce};if(incremental){ajaxData.last_size=lastLogSize}showSpinner();$.post(mdsLogsData.ajax_url,ajaxData,function(response){hideSpinner();if(response.success){lastLogSize=response.data.size;if(incremental){if(response.data.entries&&response.data.entries.length>0){var newHtml=renderLogEntries(response.data.entries);$logViewer.append(newHtml);if($toggleLiveUpdateCheckbox.is(":checked")){$logViewer.scrollTop($logViewer[0].scrollHeight)}}}else{if(response.data.entries&&response.data.entries.length>0){var fullHtml=renderLogEntries(response.data.entries);$logViewer.html(fullHtml)}else{$logViewer.html("<p>"+(response.data.message||mdsLogsData.text.log_empty)+"</p>")}}}else{showNotice(response.data.message||mdsLogsData.text.error_occurred,"error");$logViewer.html("<p>"+mdsLogsData.text.error_loading+"</p>")}}).fail(function(){hideSpinner();showNotice(mdsLogsData.text.error_occurred,"error");$logViewer.html("<p>"+mdsLogsData.text.error_loading+"</p>")})}$toggleLoggingCheckbox.on("change",function(){var isEnabled=$(this).is(":checked");showSpinner();$.post(mdsLogsData.ajax_url,{action:"mds_toggle_logging",nonce:mdsLogsData.nonce,enabled:isEnabled},function(response){hideSpinner();if(response.success){showNotice(response.data.message,"success")}else{showNotice(response.data.message||mdsLogsData.text.error_occurred,"error");$toggleLoggingCheckbox.prop("checked",!isEnabled)}}).fail(function(){hideSpinner();showNotice(mdsLogsData.text.error_occurred,"error");$toggleLoggingCheckbox.prop("checked",!isEnabled)})});$clearLogButton.on("click",function(){if(confirm(mdsLogsData.text.confirm_clear)){showSpinner();$.post(mdsLogsData.ajax_url,{action:"mds_clear_log",nonce:mdsLogsData.nonce},function(response){hideSpinner();if(response.success){showNotice(response.data.message,"success");$logViewer.html("<p>"+mdsLogsData.text.log_cleared_viewer+"</p>");lastLogSize=0}else{showNotice(response.data.message||mdsLogsData.text.error_occurred,"error")}}).fail(function(){hideSpinner();showNotice(mdsLogsData.text.error_occurred,"error")})}});$toggleLiveUpdateCheckbox.on("change",function(){if($(this).is(":checked")){fetchLogEntries(true);liveUpdateInterval=setInterval(function(){fetchLogEntries(true)},5e3);showNotice(mdsLogsData.text.live_update_enabled,"info")}else{if(liveUpdateInterval){clearInterval(liveUpdateInterval);liveUpdateInterval=null}showNotice(mdsLogsData.text.live_update_disabled,"info")}});fetchLogEntries()});