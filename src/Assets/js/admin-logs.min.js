jQuery(document).ready(function($){var $logViewer=$("#mds-log-viewer"),$spinner=$("#mds-log-spinner"),$toggleLoggingCheckbox=$("#mds-toggle-logging"),$toggleLiveUpdateCheckbox=$("#mds-toggle-live-update"),$clearLogButton=$("#mds-clear-log"),liveUpdateInterval=null,lastLogSize=0;function showSpinner(){$spinner.addClass("is-active")}function hideSpinner(){$spinner.removeClass("is-active")}function showNotice(message,type){var noticeHtml='<div class="notice notice-'+type+' is-dismissible"><p>'+message+'</p><button type="button" class="notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button></div>';$("#mds-logs-page h1").after(noticeHtml),$(document).on("click","#mds-logs-page .notice-dismiss",function(){$(this).closest(".notice").remove()})}function renderLogEntries(entries){var html="";if(!entries||entries.length===0)return"";return html+='<ul class="mds-log-entries">',entries.forEach(function(entry){if(html+='<li class="mds-log-entry mds-log-level-'+(entry.level?entry.level.toLowerCase():"raw")+'">',html+='<span class="mds-log-timestamp">['+(entry.timestamp||"No timestamp")+"]</span> ",html+='<span class="mds-log-level">['+(entry.level||"RAW")+"]</span> ",html+='<span class="mds-log-message">'+(entry.message||"")+"</span>",entry.count&&entry.count>1)html+=' <span class="mds-log-count">(x'+entry.count+")</span>";html+="</li>"}),html+="</ul>",html}function fetchLogEntries(incremental=!1){var ajaxData={action:"mds_fetch_log_entries",nonce:mdsLogsData.nonce};if(incremental)ajaxData.last_size=lastLogSize;showSpinner(),$.post(mdsLogsData.ajax_url,ajaxData,function(response){if(hideSpinner(),response.success)if(lastLogSize=response.data.size,incremental){if(response.data.entries&&response.data.entries.length>0){var newHtml=renderLogEntries(response.data.entries);if($logViewer.append(newHtml),$toggleLiveUpdateCheckbox.is(":checked"))$logViewer.scrollTop($logViewer[0].scrollHeight)}}else if(response.data.entries&&response.data.entries.length>0){var fullHtml=renderLogEntries(response.data.entries);$logViewer.html(fullHtml)}else $logViewer.html("<p>"+(response.data.message||mdsLogsData.text.log_empty)+"</p>");else showNotice(response.data.message||mdsLogsData.text.error_occurred,"error"),$logViewer.html("<p>"+mdsLogsData.text.error_loading+"</p>")}).fail(function(jqXHR,textStatus,errorThrown){hideSpinner(),showNotice(mdsLogsData.text.error_occurred,"error"),$logViewer.html("<p>"+mdsLogsData.text.error_loading+"</p>")})}$toggleLoggingCheckbox.on("change",function(){var isEnabled=$(this).is(":checked");showSpinner(),$.post(mdsLogsData.ajax_url,{action:"mds_toggle_logging",nonce:mdsLogsData.nonce,enabled:isEnabled?"yes":"no"},function(response){if(hideSpinner(),response.success);else showNotice(response.data.message||mdsLogsData.text.error_occurred,"error"),$toggleLoggingCheckbox.prop("checked",!isEnabled)}).fail(function(){hideSpinner(),showNotice(mdsLogsData.text.error_occurred,"error"),$toggleLoggingCheckbox.prop("checked",!isEnabled)})}),$clearLogButton.on("click",function(){if(confirm(mdsLogsData.text.confirm_clear))showSpinner(),$.post(mdsLogsData.ajax_url,{action:"mds_clear_log",nonce:mdsLogsData.nonce},function(response){if(hideSpinner(),response.success)$logViewer.html("<p>"+mdsLogsData.text.log_cleared_viewer+"</p>"),lastLogSize=0;else showNotice(response.data.message||mdsLogsData.text.error_occurred,"error")}).fail(function(){hideSpinner(),showNotice(mdsLogsData.text.error_occurred,"error")})}),$toggleLiveUpdateCheckbox.on("change",function(){if($(this).is(":checked"))fetchLogEntries(!0),liveUpdateInterval=setInterval(function(){fetchLogEntries(!0)},5000);else if(liveUpdateInterval)clearInterval(liveUpdateInterval),liveUpdateInterval=null}),fetchLogEntries()});
