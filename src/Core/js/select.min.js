var debug=!1,first_load=!0,ajax_queue=[],USE_AJAX=MDS_OBJECT.USE_AJAX,block_str=MDS_OBJECT.block_str,selectedBlocks=block_str!==""?block_str.split(",").map(Number):[];var ajaxing=!1,submitting=!1,grid_width=MDS_OBJECT.grid_width,grid_height=MDS_OBJECT.grid_height,BLK_WIDTH=MDS_OBJECT.BLK_WIDTH,BLK_HEIGHT=MDS_OBJECT.BLK_HEIGHT,G_MAX_BLOCKS=MDS_OBJECT.G_MAX_BLOCKS,G_MIN_BLOCKS=MDS_OBJECT.G_MIN_BLOCKS,GRD_WIDTH=BLK_WIDTH*grid_width,GRD_HEIGHT=BLK_HEIGHT*grid_height,orig={grid_width,grid_height,BLK_WIDTH,BLK_HEIGHT,GRD_WIDTH,GRD_HEIGHT},scaled_width=1,scaled_height=1,$myblocks,total_cost,grid,gridOffsetLeft,gridOffsetTop,submit_button1,pointer,pixel_container,pixel_form;function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");jQuery(container).append($ajax_loader),$ajax_loader.css("top",jQuery(container).position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}var messageout=function(message){if(debug)console.log(message);else alert(message)};jQuery.fn.rescaleStyles=function(){return this.css({width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px","line-height":BLK_HEIGHT+"px","font-size":BLK_HEIGHT+"px"}),this};jQuery.fn.repositionStyles=function(){if(this.attr("id")===void 0)return this;let id=parseInt(jQuery(this).data("blockid"),10),pos=get_block_position(id);return this.css({top:pos.y*BLK_HEIGHT+gridOffsetTop+"px",left:pos.x*BLK_WIDTH+gridOffsetLeft+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}),this};function has_touch(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function update_order(){if(selectedBlocks.length>0)pixel_form.selected_pixels.value=selectedBlocks.join(",")}function reserve_block(block_id){if(selectedBlocks.indexOf(block_id)===-1){selectedBlocks.push(parseInt(block_id,10));let index=selectedBlocks.indexOf(-1);if(index>-1)selectedBlocks.splice(index,1);update_order()}}function unreserve_block(block_id){let index=selectedBlocks.indexOf(block_id);if(index>-1)selectedBlocks.splice(index,1),update_order()}function add_block(block_id,block_x,block_y){let pos=get_block_position(block_id),block_left=pos.x*BLK_WIDTH+gridOffsetLeft,block_top=pos.y*BLK_HEIGHT+gridOffsetTop,fragment=document.createDocumentFragment(),$new_block=jQuery("<span>",{id:"block"+block_id.toString(),css:{left:block_left+"px",top:block_top+"px",lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}}).addClass("mds-block"),$new_img=jQuery("<img>",{alt:"",src:MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png",css:{lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}});$new_block.append($new_img),fragment.appendChild($new_block[0]),$myblocks.append(fragment),$new_block.data("blockid",block_id),reserve_block(block_id)}function remove_block(block_id){let myblock=document.getElementById("block"+block_id.toString());if(myblock!==null)myblock.remove();unreserve_block(block_id)}function invert_block(clicked_block){if(document.getElementById("block"+clicked_block.id.toString())!==null)remove_block(clicked_block.id);else add_block(clicked_block.id,clicked_block.x,clicked_block.y)}function is_block_selected(clicked_block){return selectedBlocks.indexOf(clicked_block)!==-1}function get_clicked_blocks(OffsetX,OffsetY,block){let clicked_blocks=[],x,y,selectedSize=parseInt(jQuery("#mds-selection-size-value").val(),10);if(selectedSize>1){for(let i=0;i<selectedSize;i++)for(let j=0;j<selectedSize;j++)if(x=OffsetX+i*BLK_WIDTH,y=OffsetY+j*BLK_HEIGHT,x>=0&&x<GRD_WIDTH&&y>=0&&y<GRD_HEIGHT)clicked_blocks.push({id:get_clicked_block(x,y),x,y})}else x=OffsetX,y=OffsetY,clicked_blocks.push({id:block,x,y});return clicked_blocks}function do_blocks(block,OffsetX,OffsetY,op){let clicked_blocks=get_clicked_blocks(OffsetX,OffsetY,block);for(let clicked_block of clicked_blocks)if(op==="add")add_block(clicked_block.id,clicked_block.x,clicked_block.y);else if(op==="remove")remove_block(clicked_block.id);else if(op==="invert")invert_block(clicked_block);if(!has_touch())$myblocks.on("mousemove",".mds-block",function(event){let offset=getOffset(event.originalEvent.pageX,event.originalEvent.pageY);if(offset==null)return!1;show_pointer(offset)})}function select_pixels(offset){return change_block_state(offset.x,offset.y),!0}function load_order(){if(MDS_OBJECT.blocks.length===0)return;for(let i=0;i<MDS_OBJECT.blocks.length;i++)add_block(parseInt(MDS_OBJECT.blocks[i].block_id,10),parseInt(MDS_OBJECT.blocks[i].x,10)*scaled_width,parseInt(MDS_OBJECT.blocks[i].y,10)*scaled_height);if(pixel_form!==null)pixel_form.addEventListener("submit",formSubmit)}function getObjCoords(obj){var rect=obj.getBoundingClientRect(),scrollLeft=window.pageXOffset||document.documentElement.scrollLeft,scrollTop=window.pageYOffset||document.documentElement.scrollTop;return{x:rect.left+scrollLeft,y:rect.top+scrollTop}}function getOffset(x,y,touch){if(grid==null)return null;let pos=getObjCoords(grid),size=get_pointer_size(),offset={},scrollLeft=0,scrollTop=0;if(touch)scrollLeft=document.documentElement.scrollLeft,scrollTop=document.documentElement.scrollTop;return offset.x=x-pos.x+scrollLeft,offset.y=y-pos.y+scrollTop,offset.x=Math.floor(offset.x/scaled_width/orig.BLK_WIDTH)*orig.BLK_WIDTH,offset.y=Math.floor(offset.y/scaled_height/orig.BLK_HEIGHT)*orig.BLK_HEIGHT,offset.x=Math.max(Math.min(offset.x,GRD_WIDTH-size.width/scaled_width),0),offset.y=Math.max(Math.min(offset.y,GRD_HEIGHT-size.height/scaled_height),0),offset.x=offset.x*scaled_width,offset.y=offset.y*scaled_height,offset}function get_pointer_size(){let size={},$mds_selection_size_slider=jQuery("#mds-selection-size-slider"),$mds_selection_size_value=jQuery("#mds-selection-size-value"),$mds_total_blocks_value=jQuery("#mds-total-blocks-value");if($mds_selection_size_slider.attr("type")==="hidden"){let selectedSize=parseInt($mds_selection_size_value.val(),10),maxBlockSize=Math.max(GRD_WIDTH,GRD_HEIGHT),blocksLeft=G_MAX_BLOCKS-selectedBlocks.length,sqrtBlocksLeft=Math.floor(Math.sqrt(blocksLeft));if(selectedSize===0)selectedSize=Math.floor(Math.sqrt(G_MAX_BLOCKS));let cappedSize=Math.min(selectedSize,maxBlockSize,sqrtBlocksLeft);if(blocksLeft===0)cappedSize=1;while((cappedSize+1)*(cappedSize+1)<=blocksLeft)cappedSize++,blocksLeft=blocksLeft-cappedSize*cappedSize;size.width=BLK_WIDTH*cappedSize,size.height=BLK_HEIGHT*cappedSize,$mds_selection_size_slider.val(cappedSize),$mds_selection_size_value.val(cappedSize),$mds_total_blocks_value.val(cappedSize*cappedSize)}else{let selectedSize=parseInt(jQuery("#mds-selection-size-value").val(),10),maxBlockSize=Math.max(GRD_WIDTH,GRD_HEIGHT),cappedSize=Math.min(selectedSize,maxBlockSize);size.width=BLK_WIDTH*cappedSize,size.height=BLK_HEIGHT*cappedSize}return size}function update_pointer_size(){let size=get_pointer_size();pointer.style.width=size.width+"px",pointer.style.height=size.height+"px"}function show_pointer(offset){return pointer.style.visibility="visible",pointer.style.display="block",pointer.style.top=offset.y+"px",pointer.style.left=offset.x+"px",pointer.map_x=offset.x,pointer.map_y=offset.y,update_pointer_size(),!0}function formSubmit(event){if(event.preventDefault(),event.stopPropagation(),$myblocks.html().trim()==="")return messageout(MDS_OBJECT.no_blocks_selected),!1;if(submitting===!1){submitting=!0,submit_button1.disabled=!0;let submit1_lang=submit_button1.value;submit_button1.value=MDS_OBJECT.WAIT;let waitInterval=setInterval(function(){if(ajax_queue.length===0){if(clearInterval(waitInterval),pixel_form!==null){let selectedPixelsInput=document.getElementById("selected_pixels");if(selectedPixelsInput)selectedPixelsInput.value=selectedBlocks.join(",");mds_update_package(jQuery(pixel_form)),pixel_form.submit()}submit_button1.disabled=!1,submit_button1.value=submit1_lang,submitting=!1}},1000)}}function reset_pixels(){ajax_queue=[],add_ajax_loader(".mds-pixel-wrapper"),jQuery.ajax({type:"POST",url:MDS_OBJECT.UPDATE_ORDER,data:{reset:!0,action:"reset",_wpnonce:MDS_OBJECT.NONCE},success:function(data){if(data.success===!0&&data.data&&data.data.type==="removed")$myblocks.children().each(function(){remove_block(jQuery(this).data("blockid"))})},complete:function(){remove_ajax_loader()}})}function rescale_grid(){if(grid==null)return;let origWidth=parseInt(jQuery(grid).attr("data-original-width"),10)||orig.GRD_WIDTH,origHeight=parseInt(jQuery(grid).attr("data-original-height"),10)||orig.GRD_HEIGHT;if(grid_width=jQuery(grid).width(),grid_height=jQuery(grid).height(),scaled_width=grid_width/origWidth,scaled_height=grid_height/origHeight,typeof scaleImageMap==="function")scaleImageMap();BLK_WIDTH=orig.BLK_WIDTH*scaled_width,BLK_HEIGHT=orig.BLK_HEIGHT*scaled_height,gridOffsetLeft=grid.offsetLeft,gridOffsetTop=grid.offsetTop,jQuery(pointer).rescaleStyles();let currentBlocks=selectedBlocks.slice();if($myblocks.empty(),currentBlocks.length>0)currentBlocks.forEach(function(blockId){add_block(blockId)});if(window.scaleImageMap&&typeof window.scaleImageMap==="function")window.scaleImageMap()}function center_block(coords){let size=get_pointer_size();return coords.x-=size.width/2-BLK_WIDTH/2,coords.y-=size.height/2-BLK_HEIGHT/2,coords}function handle_click_events(){let clickValid=!0,startX,startY,threshold=Math.min(BLK_WIDTH,BLK_HEIGHT)/2;jQuery(pixel_container).on("mousedown",function(event){clickValid=!0,startX=event.originalEvent.pageX,startY=event.originalEvent.pageY}),jQuery(pixel_container).on("mousemove",function(event){if(clickValid){let currentX=event.originalEvent.pageX,currentY=event.originalEvent.pageY;if(Math.abs(startX-currentX)>threshold||Math.abs(startY-currentY)>threshold)clickValid=!1}let coords=center_block({x:event.originalEvent.pageX,y:event.originalEvent.pageY}),offset=getOffset(coords.x,coords.y);if(offset==null)return!1;show_pointer(offset)}),jQuery(pixel_container).on("click",function(event){if(event.preventDefault(),clickValid){let coords=center_block({x:event.originalEvent.pageX,y:event.originalEvent.pageY}),offset=getOffset(coords.x,coords.y);if(offset==null)return!1;show_pointer(offset),select_pixels(offset)}return clickValid=!0,!1})}function handle_touch_events(){if(window.mds_zoom===void 0)window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0;let options={supportedGestures:[Tap,Pinch,Pan]},pointerListener=new PointerListener(pixel_container,options);pixel_container.addEventListener("tap",function(event){let offset=getOffset(event.detail.live.center.x,event.detail.live.center.y,!0);if(offset==null)return!0;show_pointer(offset),select_pixels(offset)}),pixel_container.addEventListener("pinch",function(event){event.preventDefault&&event.preventDefault();let newScale=event.detail.live.scale;if(!newScale||newScale<=0)return;applyZoom(newScale,event.detail.live.center.x,event.detail.live.center.y)}),pixel_container.addEventListener("pan",function(event){if(window.mds_zoom<=1)return;window.mds_pan_x+=event.detail.live.deltaX,window.mds_pan_y+=event.detail.live.deltaY,applyTransform()})}function get_block_position(block_id){let grid_width_in_blocks=Math.floor(orig.GRD_WIDTH/orig.BLK_WIDTH),x_blocks=block_id%grid_width_in_blocks,y_blocks=Math.floor(block_id/grid_width_in_blocks);return{x:x_blocks,y:y_blocks}}function get_clicked_block(OffsetX,OffsetY){OffsetX/=scaled_width,OffsetY/=scaled_height;let X=OffsetX/orig.BLK_WIDTH,Y=OffsetY/orig.BLK_HEIGHT*(orig.GRD_WIDTH/orig.BLK_WIDTH);return Math.round(X+Y)}function change_block_state(OffsetX,OffsetY){let clicked_block=get_clicked_block(OffsetX,OffsetY),erasing=jQuery("#erase").is(":checked"),selection_size=parseInt(pixel_form.elements.selection_size.value,10),data={erasing,clicked_block,OffsetX,OffsetY,url:(()=>{let url=new URL(MDS_OBJECT.UPDATE_ORDER,window.location.origin);return url.searchParams.set("selection_size",selection_size),url.searchParams.set("user_id",MDS_OBJECT.user_id),url.searchParams.set("block_id",clicked_block.toString()),url.searchParams.set("BID",MDS_OBJECT.BID),url.searchParams.set("t",MDS_OBJECT.time),url.searchParams.set("erase",erasing),url.searchParams.set("_wpnonce",MDS_OBJECT.NONCE),url.toString()})()};if(is_block_selected(clicked_block))if(erasing)data.action="remove",do_blocks(clicked_block,OffsetX,OffsetY,"remove");else if(MDS_OBJECT.INVERT_PIXELS==="YES")data.action="invert",do_blocks(clicked_block,OffsetX,OffsetY,"invert");else data.action="add",do_blocks(clicked_block,OffsetX,OffsetY,"add");else if(erasing)data.action="remove",do_blocks(clicked_block,OffsetX,OffsetY,"remove");else if(MDS_OBJECT.INVERT_PIXELS==="YES")data.action="invert",do_blocks(clicked_block,OffsetX,OffsetY,"invert");else data.action="add",do_blocks(clicked_block,OffsetX,OffsetY,"add");ajax_queue.push(data)}var resizeTimer;window.addEventListener("resize",function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){rescale_grid()},100)});jQuery(document).on("ajaxComplete",function(event,xhr,settings){if(console.log("ajaxComplete"),new URLSearchParams(settings.data).get("type")!=="order")return;if(first_load)first_load=!1;else return;grid=document.getElementById("pixelimg");let $grid=jQuery(grid);if($myblocks=jQuery("#blocks"),total_cost=document.getElementById("total_cost"),submit_button1=document.getElementById("submit_button1"),pointer=document.getElementById("block_pointer"),pixel_container=document.getElementById("pixel_container"),pixel_form=document.getElementById("pixel_form"),rescale_grid(),$grid.length===0)remove_ajax_loader();if(has_touch())handle_touch_events();else handle_click_events();jQuery(grid).oncontextmenu=(e)=>{e.preventDefault()};let ajax_queue_interval=setInterval(function(){if(ajax_queue.length===0||ajaxing)return;ajaxing=!0,add_ajax_loader2(".mds-pixel-wrapper");let data=ajax_queue.shift();jQuery.ajax({type:"POST",url:data.url,data:{_wpnonce:MDS_OBJECT.NONCE,erasing:data.erasing},success:function(response){if(response.success!==!0||response.data&&response.data.error==="true"){switch(data.action){case"invert":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"invert");break;case"remove":if(!data.erasing)do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"add");break;case"add":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"remove");break}messageout(response.data.data.value)}if(response.data&&response.data.type==="order_id"){if(pixel_form!==null)pixel_form.order_id.value=parseInt(response.data.data.value,10)}},fail:function(){switch(data.action){case"invert":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"invert");break;case"remove":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"add");break;case"add":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"remove");break}if(jQuery.isPlainObject(data))messageout("Error: "+JSON.stringify(data));else messageout("Error: "+data)},complete:function(){ajaxing=!1,remove_ajax_loader()}})},100);document.querySelectorAll('.mds-select-input input[type="checkbox"]').forEach(function(radio){radio.addEventListener("hover",function(){this.style.cursor="pointer"}),radio.addEventListener("change",function(){let label=this.nextElementSibling,iconErase=label.querySelector(".icon-erase"),iconSelect=label.querySelector(".icon-select");if(iconErase&&iconSelect)if(this.checked)iconErase.setAttribute("stroke","#FFFFFF"),iconSelect.setAttribute("stroke","none");else iconErase.setAttribute("stroke","none"),iconSelect.setAttribute("stroke","#008000")})});let $pixelimg=jQuery("#pixelimg");$pixelimg.one("load",function(){rescale_grid(),load_order(),jQuery(".ajax-loader").remove()}).each(function(){if(this.complete)jQuery(this).trigger("load")}),$pixelimg.on("loadstart",function(){add_ajax_loader2(".mds-pixel-wrapper")});function add_ajax_loader2(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>"),$container=jQuery(container);if($container.length>0)$container.append($ajax_loader),$ajax_loader.css("z-index","10000").css("top",$container.position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}add_ajax_loader2(".mds-pixel-wrapper");let $mds_selection_size_slider=jQuery("#mds-selection-size-slider"),$mds_selection_size_value=jQuery("#mds-selection-size-value"),$mds_total_blocks_value=jQuery("#mds-total-blocks-value");if($mds_selection_size_slider.length>0){$mds_selection_size_slider.on("input",function(){let blockSize=parseInt(jQuery(this).val());console.log("blockSize",blockSize);let adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_value.val(adjustedBlockSize),$mds_total_blocks_value.val(Math.pow(adjustedBlockSize,2)),update_pointer_size()}),$mds_selection_size_value.on("input",function(){let blockSize=parseInt(jQuery(this).val()),adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_slider.val(adjustedBlockSize),$mds_total_blocks_value.val(Math.pow(adjustedBlockSize,2)),update_pointer_size()});let previousTotalBlocks=parseInt($mds_total_blocks_value.val()),updateTimer;$mds_total_blocks_value.on("input",function(){let totalBlocks=parseInt(jQuery(this).val()),isIncreasing=totalBlocks>previousTotalBlocks,blockSize;if(isIncreasing)blockSize=Math.ceil(Math.sqrt(totalBlocks));else blockSize=Math.floor(Math.sqrt(totalBlocks));let adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_slider.val(adjustedBlockSize),$mds_selection_size_value.val(adjustedBlockSize),clearTimeout(updateTimer),updateTimer=setTimeout(()=>{totalBlocks=Math.pow(adjustedBlockSize,2),$mds_total_blocks_value.val(totalBlocks),previousTotalBlocks=totalBlocks,update_pointer_size()},1000)})}if(jQuery(submit_button1).on("click",function(e){return e.preventDefault(),e.stopPropagation(),formSubmit(e),!1}),jQuery("#reset_button").on("click",function(e){return e.preventDefault(),e.stopPropagation(),reset_pixels(),!1}),jQuery("#reset_zoom_button").length===0){let resetZoomButton=jQuery("<button>",{id:"reset_zoom_button",class:"mds-reset-zoom",text:"Reset Zoom",css:{position:"absolute",right:"10px",top:"10px","z-index":"1000",padding:"5px 10px",background:"rgba(0,0,0,0.5)",color:"white",border:"none","border-radius":"4px",display:"none",cursor:"pointer"}});jQuery(".mds-pixel-wrapper").append(resetZoomButton),resetZoomButton.on("click",function(){resetZoom()})}});function applyZoom(scaleChange,centerX,centerY){let oldZoom=window.mds_zoom||1,newZoom=Math.min(3,oldZoom*scaleChange);if(newZoom<1){resetZoom();return}if(window.mds_zoom=newZoom,newZoom>1)jQuery("#reset_zoom_button").show();else jQuery("#reset_zoom_button").hide();applyTransform()}function applyTransform(){let wrapper=jQuery(".mds-pixel-wrapper");if(!wrapper.length)return;let transform=`scale(${window.mds_zoom}) translate(${window.mds_pan_x/window.mds_zoom}px, ${window.mds_pan_y/window.mds_zoom}px)`;wrapper.css({transform,"transform-origin":"center center",transition:"transform 0.1s"}),rescale_grid()}function resetZoom(){window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0,jQuery(".mds-pixel-wrapper").css({transform:"none",transition:"transform 0.3s"}),jQuery("#reset_zoom_button").hide(),rescale_grid()}function scaleImageMap(){var img=document.getElementById("pixelimg");if(!img)return;var origWidth=parseInt(img.getAttribute("data-original-width"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_width_px||MDS_OBJECT.grid_width*MDS_OBJECT.BLK_WIDTH,origHeight=parseInt(img.getAttribute("data-original-height"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_height_px||MDS_OBJECT.grid_height*MDS_OBJECT.BLK_HEIGHT,currentWidth=img.clientWidth||img.offsetWidth,currentHeight=img.clientHeight||img.offsetHeight,scaleX=currentWidth/origWidth,scaleY=currentHeight/origHeight,blocks=document.querySelectorAll(".gridblock");if(blocks&&blocks.length>0)for(var i=0;i<blocks.length;i++){var block=blocks[i],x=parseInt(block.getAttribute("data-x"),10)||0,y=parseInt(block.getAttribute("data-y"),10)||0;if(x&&y){var scaledX=Math.round(x*scaleX),scaledY=Math.round(y*scaleY);block.style.left=scaledX+"px",block.style.top=scaledY+"px"}}if(window.mds_pointer_x!==void 0&&window.mds_pointer_y!==void 0){var scaledX=Math.round(window.mds_pointer_x*scaleX),scaledY=Math.round(window.mds_pointer_y*scaleY),pointer2=document.getElementById("block_pointer");if(pointer2)pointer2.style.left=scaledX+"px",pointer2.style.top=scaledY+"px"}}window.scaleImageMap=scaleImageMap;
