let debug=!1,first_load=!0,ajax_queue=[],USE_AJAX=MDS_OBJECT.USE_AJAX,block_str=MDS_OBJECT.block_str,selectedBlocks=""!==block_str?block_str.split(",").map(Number):[],selecting=!1,ajaxing=!1,submitting=!1,grid_width=MDS_OBJECT.grid_width,grid_height=MDS_OBJECT.grid_height,BLK_WIDTH=MDS_OBJECT.BLK_WIDTH,BLK_HEIGHT=MDS_OBJECT.BLK_HEIGHT,G_MAX_BLOCKS=MDS_OBJECT.G_MAX_BLOCKS,G_MIN_BLOCKS=MDS_OBJECT.G_MIN_BLOCKS,GRD_WIDTH=BLK_WIDTH*grid_width,GRD_HEIGHT=BLK_HEIGHT*grid_height,orig={grid_width:grid_width,grid_height:grid_height,BLK_WIDTH:BLK_WIDTH,BLK_HEIGHT:BLK_HEIGHT,GRD_WIDTH:GRD_WIDTH,GRD_HEIGHT:GRD_HEIGHT},scaled_width=1,scaled_height=1,$myblocks,total_cost,grid,gridOffsetLeft,gridOffsetTop,submit_button1,pointer,pixel_container,pixel_form;function add_ajax_loader(e){var t=jQuery("<div class='ajax-loader'></div>");jQuery(e).append(t),t.css("top",jQuery(e).position().top).css("left",jQuery(e).width()/2-t.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}let messageout=function(e){debug?console.log(e):alert(e)};function has_touch(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function update_order(){0<selectedBlocks.length&&(pixel_form.selected_pixels.value=selectedBlocks.join(","))}function reserve_block(e){-1===selectedBlocks.indexOf(e)&&(selectedBlocks.push(parseInt(e,10)),-1<(e=selectedBlocks.indexOf(-1))&&selectedBlocks.splice(e,1),update_order())}function unreserve_block(e){e=selectedBlocks.indexOf(e);-1<e&&(selectedBlocks.splice(e,1),update_order())}function add_block(e,t,i){var o=get_block_position(e),n=o.x*BLK_WIDTH+gridOffsetLeft,o=o.y*BLK_HEIGHT+gridOffsetTop,r=document.createDocumentFragment(),n=jQuery("<span>",{id:"block"+e.toString(),css:{left:n+"px",top:o+"px",lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}}).addClass("mds-block"),o=jQuery("<img>",{alt:"",src:MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png",css:{lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}});n.append(o),r.appendChild(n[0]),$myblocks.append(r),n.data("blockid",e),reserve_block(e)}function remove_block(e){var t=document.getElementById("block"+e.toString());null!==t&&t.remove(),unreserve_block(e)}function invert_block(e){null!==document.getElementById("block"+e.id.toString())?remove_block(e.id):add_block(e.id,e.x,e.y)}function is_block_selected(e){return-1!==selectedBlocks.indexOf(e)}function get_clicked_blocks(i,o,e){var n=[];let r,a;var s=parseInt(jQuery("#mds-selection-size-value").val(),10);if(1<s)for(let t=0;t<s;t++)for(let e=0;e<s;e++)r=i+t*BLK_WIDTH,a=o+e*BLK_HEIGHT,0<=r&&r<GRD_WIDTH&&0<=a&&a<GRD_HEIGHT&&n.push({id:get_clicked_block(r,a),x:r,y:a});else r=i,a=o,n.push({id:e,x:r,y:a});return n}function do_blocks(e,t,i,o){var n;for(n of get_clicked_blocks(t,i,e))"add"===o?add_block(n.id,n.x,n.y):"remove"===o?remove_block(n.id):"invert"===o&&invert_block(n);has_touch()||$myblocks.on("mousemove",".mds-block",function(e){e=getOffset(e.originalEvent.pageX,e.originalEvent.pageY);if(null==e)return!1;show_pointer(e)})}function select_pixels(e){return change_block_state(e.x,e.y),!0}function load_order(){if(0!==MDS_OBJECT.blocks.length){for(let e=0;e<MDS_OBJECT.blocks.length;e++)add_block(parseInt(MDS_OBJECT.blocks[e].block_id,10),parseInt(MDS_OBJECT.blocks[e].x,10)*scaled_width,parseInt(MDS_OBJECT.blocks[e].y,10)*scaled_height);null!==pixel_form&&pixel_form.addEventListener("submit",formSubmit)}}function getObjCoords(e){var e=e.getBoundingClientRect(),t=window.pageXOffset||document.documentElement.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop;return{x:e.left+t,y:e.top+i}}function getOffset(e,t,i){if(null==grid)return null;var o=getObjCoords(grid),n=get_pointer_size(),r={};let a=0,s=0;return i&&(a=document.documentElement.scrollLeft,s=document.documentElement.scrollTop),r.x=e-o.x+a,r.y=t-o.y+s,r.x=Math.floor(r.x/scaled_width/orig.BLK_WIDTH)*orig.BLK_WIDTH,r.y=Math.floor(r.y/scaled_height/orig.BLK_HEIGHT)*orig.BLK_HEIGHT,r.x=Math.max(Math.min(r.x,GRD_WIDTH-n.width/scaled_width),0),r.y=Math.max(Math.min(r.y,GRD_HEIGHT-n.height/scaled_height),0),r.x=r.x*scaled_width,r.y=r.y*scaled_height,r}function get_pointer_size(){var o={},n=jQuery("#mds-selection-size-slider"),r=jQuery("#mds-selection-size-value"),a=jQuery("#mds-total-blocks-value");if("hidden"===n.attr("type")){let e=parseInt(r.val(),10);var s=Math.max(GRD_WIDTH,GRD_HEIGHT);let t=G_MAX_BLOCKS-selectedBlocks.length;var l=Math.floor(Math.sqrt(t));0===e&&(e=Math.floor(Math.sqrt(G_MAX_BLOCKS)));let i=Math.min(e,s,l);for(0===t&&(i=1);(i+1)*(i+1)<=t;)i++,t-=i*i;o.width=BLK_WIDTH*i,o.height=BLK_HEIGHT*i,n.val(i),r.val(i),a.val(i*i)}else{s=parseInt(jQuery("#mds-selection-size-value").val(),10),l=Math.max(GRD_WIDTH,GRD_HEIGHT),n=Math.min(s,l);o.width=BLK_WIDTH*n,o.height=BLK_HEIGHT*n}return o}function update_pointer_size(){var e=get_pointer_size();pointer.style.width=e.width+"px",pointer.style.height=e.height+"px"}function show_pointer(e){return pointer.style.visibility="visible",pointer.style.display="block",pointer.style.top=e.y+"px",pointer.style.left=e.x+"px",pointer.map_x=e.x,pointer.map_y=e.y,update_pointer_size(),!0}function formSubmit(e){if(e.preventDefault(),e.stopPropagation(),""===$myblocks.html().trim())return messageout(MDS_OBJECT.no_blocks_selected),!1;if(!1===submitting){submitting=!0,submit_button1.disabled=!0;submit_button1.value;submit_button1.value=MDS_OBJECT.WAIT;let t=setInterval(function(){var e;0===ajax_queue.length&&(clearInterval(t),null!==pixel_form)&&((e=document.getElementById("selected_pixels"))&&(e.value=selectedBlocks.join(",")),mds_update_package(jQuery(pixel_form)),pixel_form.submit())},1e3)}}function reset_pixels(){ajax_queue=[],add_ajax_loader(".mds-pixel-wrapper"),jQuery.ajax({type:"POST",url:MDS_OBJECT.UPDATE_ORDER,data:{reset:"true",action:"reset",_wpnonce:MDS_OBJECT.NONCE,BID:MDS_OBJECT.BID},success:function(e){!0===e.success&&e.data&&"removed"===e.data.type&&$myblocks.children().each(function(){remove_block(jQuery(this).data("blockid"))})},complete:function(){remove_ajax_loader()}})}function rescale_grid(){var e,t;null!=grid&&(t=parseInt(jQuery(grid).attr("data-original-width"),10)||orig.GRD_WIDTH,e=parseInt(jQuery(grid).attr("data-original-height"),10)||orig.GRD_HEIGHT,grid_width=jQuery(grid).width(),grid_height=jQuery(grid).height(),scaled_width=grid_width/t,scaled_height=grid_height/e,"function"==typeof scaleImageMap&&scaleImageMap(),BLK_WIDTH=orig.BLK_WIDTH*scaled_width,BLK_HEIGHT=orig.BLK_HEIGHT*scaled_height,gridOffsetLeft=grid.offsetLeft,gridOffsetTop=grid.offsetTop,jQuery(pointer).rescaleStyles(),t=selectedBlocks.slice(),$myblocks.empty(),0<t.length&&t.forEach(function(e){add_block(e)}),window.scaleImageMap)&&"function"==typeof window.scaleImageMap&&window.scaleImageMap()}function center_block(e){var t=get_pointer_size();return e.x-=t.width/2-BLK_WIDTH/2,e.y-=t.height/2-BLK_HEIGHT/2,e}function handle_click_events(){let o=!0,n,r,a=Math.min(BLK_WIDTH,BLK_HEIGHT)/2;jQuery(pixel_container).on("mousedown",function(e){o=!0,n=e.originalEvent.pageX,r=e.originalEvent.pageY}),jQuery(pixel_container).on("mousemove",function(e){o&&(t=e.originalEvent.pageX,i=e.originalEvent.pageY,Math.abs(n-t)>a||Math.abs(r-i)>a)&&(o=!1);var t=center_block({x:e.originalEvent.pageX,y:e.originalEvent.pageY}),i=getOffset(t.x,t.y);if(null==i)return!1;show_pointer(i)}),jQuery(pixel_container).on("click",function(e){if(e.preventDefault(),o){e=center_block({x:e.originalEvent.pageX,y:e.originalEvent.pageY}),e=getOffset(e.x,e.y);if(null==e)return!1;show_pointer(e),select_pixels(e)}return!(o=!0)})}function handle_touch_events(){void 0===window.mds_zoom&&(window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0);var e={supportedGestures:[Tap,Pinch,Pan]};new PointerListener(pixel_container,e);pixel_container.addEventListener("tap",function(e){e=getOffset(e.detail.live.center.x,e.detail.live.center.y,!0);if(null==e)return!0;show_pointer(e),select_pixels(e)}),pixel_container.addEventListener("pinch",function(e){e.preventDefault&&e.preventDefault();var t=e.detail.live.scale;!t||t<=0||applyZoom(t,e.detail.live.center.x,e.detail.live.center.y)}),pixel_container.addEventListener("pan",function(e){window.mds_zoom<=1||(window.mds_pan_x+=e.detail.live.deltaX,window.mds_pan_y+=e.detail.live.deltaY,applyTransform())})}function IsNumeric(t){var i;let o=!0;for(let e=0;e<t.length&&!0===o;e++)i=t.charAt(e),-1==="0123456789".indexOf(i)&&(o=!1);return o}function get_block_position(e){var t=Math.floor(orig.GRD_WIDTH/orig.BLK_WIDTH);return{x:e%t,y:Math.floor(e/t)}}function get_clicked_block(e,t){e/=scaled_width,t/=scaled_height;e/=orig.BLK_WIDTH,t=t/orig.BLK_HEIGHT*(orig.GRD_WIDTH/orig.BLK_WIDTH);return Math.round(e+t)}function change_block_state(e,t){let i=get_clicked_block(e,t),o=jQuery("#erase").is(":checked"),n=parseInt(pixel_form.elements.selection_size.value,10);var r={erasing:o,clicked_block:i,OffsetX:e,OffsetY:t,url:((r=new URL(MDS_OBJECT.UPDATE_ORDER,window.location.origin)).searchParams.set("selection_size",n),r.searchParams.set("user_id",MDS_OBJECT.user_id),r.searchParams.set("block_id",i.toString()),r.searchParams.set("BID",MDS_OBJECT.BID),r.searchParams.set("t",MDS_OBJECT.time),r.searchParams.set("erase",o),r.searchParams.set("_wpnonce",MDS_OBJECT.NONCE),r.toString())};is_block_selected(i),o?(r.action="remove",do_blocks(i,e,t,"remove")):"YES"===MDS_OBJECT.INVERT_PIXELS?(r.action="invert",do_blocks(i,e,t,"invert")):(r.action="add",do_blocks(i,e,t,"add")),ajax_queue.push(r)}function implode(e){let t="",i="";for(var o in e)e.hasOwnProperty(o)&&(t=t+i+e[o]),i=",";return t}jQuery.fn.rescaleStyles=function(){return this.css({width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px","line-height":BLK_HEIGHT+"px","font-size":BLK_HEIGHT+"px"}),this},jQuery.fn.repositionStyles=function(){var e;return void 0!==this.attr("id")&&(e=get_block_position(parseInt(jQuery(this).data("blockid"),10)),this.css({top:e.y*BLK_HEIGHT+gridOffsetTop+"px",left:e.x*BLK_WIDTH+gridOffsetLeft+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"})),this};let resizeTimer;function applyZoom(e,t,i){var o=window.mds_zoom||1,o=Math.min(3,o*e);(o<1?resetZoom:(1<(window.mds_zoom=o)?jQuery("#reset_zoom_button").show():jQuery("#reset_zoom_button").hide(),applyTransform))()}function applyTransform(){var e,t=jQuery(".mds-pixel-wrapper");t.length&&(e=`scale(${window.mds_zoom}) translate(${window.mds_pan_x/window.mds_zoom}px, ${window.mds_pan_y/window.mds_zoom}px)`,t.css({transform:e,"transform-origin":"center center",transition:"transform 0.1s"}),rescale_grid())}function resetZoom(){window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0,jQuery(".mds-pixel-wrapper").css({transform:"none",transition:"transform 0.3s"}),jQuery("#reset_zoom_button").hide(),rescale_grid()}function scaleImageMap(){var e=document.getElementById("pixelimg");if(e){var t=parseInt(e.getAttribute("data-original-width"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_width_px||MDS_OBJECT.grid_width*MDS_OBJECT.BLK_WIDTH,i=parseInt(e.getAttribute("data-original-height"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_height_px||MDS_OBJECT.grid_height*MDS_OBJECT.BLK_HEIGHT,o=(e.clientWidth||e.offsetWidth)/t,n=(e.clientHeight||e.offsetHeight)/i,r=document.querySelectorAll(".gridblock");if(r&&0<r.length)for(var a=0;a<r.length;a++){var s,l,d=r[a],c=parseInt(d.getAttribute("data-x"),10)||0,_=parseInt(d.getAttribute("data-y"),10)||0;c&&_&&(s=Math.round(c*o),l=Math.round(_*n),d.style.left=s+"px",d.style.top=l+"px")}void 0!==window.mds_pointer_x&&void 0!==window.mds_pointer_y&&(s=Math.round(window.mds_pointer_x*o),l=Math.round(window.mds_pointer_y*n),t=document.getElementById("block_pointer"))&&(t.style.left=s+"px",t.style.top=l+"px")}}window.addEventListener("resize",function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){rescale_grid()},100)}),jQuery(document).on("ajaxComplete",function(e,t,i){console.log("ajaxComplete");i=new URLSearchParams(i.data).get("type");if("order"===i&&first_load){first_load=!1,grid=document.getElementById("pixelimg");var i=jQuery(grid),i=($myblocks=jQuery("#blocks"),total_cost=document.getElementById("total_cost"),submit_button1=document.getElementById("submit_button1"),pointer=document.getElementById("block_pointer"),pixel_container=document.getElementById("pixel_container"),pixel_form=document.getElementById("pixel_form"),rescale_grid(),0===i.length&&remove_ajax_loader(),(has_touch()?handle_touch_events:handle_click_events)(),jQuery(grid).oncontextmenu=e=>{e.preventDefault()},setInterval(function(){if(0!==ajax_queue.length&&!ajaxing){ajaxing=!0,o(".mds-pixel-wrapper");let t=ajax_queue.shift();jQuery.ajax({type:"POST",url:t.url,data:{_wpnonce:MDS_OBJECT.NONCE,erasing:t.erasing,block_id:t.clicked_block,selection_size:parseInt(jQuery("#mds-selection-size-value").val(),10)||1,BID:MDS_OBJECT.BID},success:function(e){if(!0!==e.success||e.data&&"true"===e.data.error){switch(t.action){case"invert":do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"invert");break;case"remove":t.erasing||do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"add");break;case"add":do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"remove")}messageout(e.data.data.value)}e.data&&"order_id"===e.data.type&&null!==pixel_form&&(pixel_form.order_id.value=parseInt(e.data.data.value,10))},fail:function(){switch(t.action){case"invert":do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"invert");break;case"remove":do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"add");break;case"add":do_blocks(t.clicked_block,t.OffsetX,t.OffsetY,"remove")}jQuery.isPlainObject(t)?messageout("Error: "+JSON.stringify(t)):messageout("Error: "+t)},complete:function(){ajaxing=!1,remove_ajax_loader()}})}},100),document.querySelectorAll('.mds-select-input input[type="checkbox"]').forEach(function(e){e.addEventListener("hover",function(){this.style.cursor="pointer"}),e.addEventListener("change",function(){var e=this.nextElementSibling,t=e.querySelector(".icon-erase"),e=e.querySelector(".icon-select");t&&e&&(this.checked?(t.setAttribute("stroke","#FFFFFF"),e.setAttribute("stroke","none")):(t.setAttribute("stroke","none"),e.setAttribute("stroke","#008000")))})}),jQuery("#pixelimg"));i.one("load",function(){rescale_grid(),load_order(),jQuery(".ajax-loader").remove()}).each(function(){this.complete&&jQuery(this).trigger("load")}),i.on("loadstart",function(){o(".mds-pixel-wrapper")}),o(".mds-pixel-wrapper");let a=jQuery("#mds-selection-size-slider"),s=jQuery("#mds-selection-size-value"),l=jQuery("#mds-total-blocks-value");if(0<a.length){a.on("input",function(){var e=parseInt(jQuery(this).val()),e=(console.log("blockSize",e),Math.min(e,Math.min(GRD_WIDTH,GRD_HEIGHT)));s.val(e),l.val(Math.pow(e,2)),update_pointer_size()}),s.on("input",function(){var e=parseInt(jQuery(this).val()),e=Math.min(e,Math.min(GRD_WIDTH,GRD_HEIGHT));a.val(e),l.val(Math.pow(e,2)),update_pointer_size()});let n=parseInt(l.val()),r;l.on("input",function(){let e=parseInt(jQuery(this).val());var t=e>n;let i,o=(i=t?Math.ceil(Math.sqrt(e)):Math.floor(Math.sqrt(e)),Math.min(i,Math.min(GRD_WIDTH,GRD_HEIGHT)));a.val(o),s.val(o),clearTimeout(r),r=setTimeout(()=>{e=Math.pow(o,2),l.val(e),n=e,update_pointer_size()},1e3)})}function o(e){var t=jQuery("<div class='ajax-loader'></div>"),i=jQuery(e);0<i.length&&(i.append(t),t.css("z-index","10000").css("top",i.position().top).css("left",jQuery(e).width()/2-t.width()/2))}jQuery(submit_button1).on("click",function(e){return e.preventDefault(),e.stopPropagation(),formSubmit(e),!1}),jQuery("#reset_button").on("click",function(e){return e.preventDefault(),e.stopPropagation(),reset_pixels(),!1}),0===jQuery("#reset_zoom_button").length&&(i=jQuery("<button>",{id:"reset_zoom_button",class:"mds-reset-zoom",text:"Reset Zoom",css:{position:"absolute",right:"10px",top:"10px","z-index":"1000",padding:"5px 10px",background:"rgba(0,0,0,0.5)",color:"white",border:"none","border-radius":"4px",display:"none",cursor:"pointer"}}),jQuery(".mds-pixel-wrapper").append(i),i.on("click",function(){resetZoom()}))}}),window.scaleImageMap=scaleImageMap;