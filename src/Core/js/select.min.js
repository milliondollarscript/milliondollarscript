/*
 * Million Dollar Script Two
 *
 * @author      Ryan Rhode
 * @copyright   (C) 2025, Ryan Rhode
 * @license     https://opensource.org/licenses/GPL-3.0 GNU General Public License, version 3
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 *
 *    Million Dollar Script
 *    Pixels to Profit: Ignite Your Revolution
 *    https://milliondollarscript.com/
 *
 */
let debug=!1;function mds_show_modal(e){const t=document.getElementById("mds-modal-overlay"),o=document.getElementById("mds-modal-message");if(!t||!o)return alert(String(e));o.textContent=String(e),t.style.display="flex",setTimeout((()=>{const e=document.getElementById("mds-modal-ok");e&&e.focus()}),0)}!function(){if(document.getElementById("mds-modal-style"))return;const e=document.createElement("style");e.id="mds-modal-style",e.textContent="\n    #mds-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 100000; display: none; align-items: center; justify-content: center; padding: 16px; }\n    #mds-modal { max-width: 520px; width: 100%; border-radius: 8px; box-shadow: 0 8px 28px rgba(0,0,0,0.35); background: var(--mds-bg-secondary, #333); color: var(--mds-text-primary, #fff); border: 1px solid var(--mds-border-color, rgba(255,255,255,0.1)); }\n    #mds-modal .mds-modal-body { padding: 18px 20px; font-size: 15px; line-height: 1.45; }\n    #mds-modal .mds-modal-actions { padding: 12px 16px 16px; display: flex; justify-content: flex-end; gap: 10px; }\n    #mds-modal .mds-btn { cursor: pointer; padding: 8px 14px; border-radius: 6px; border: none; font-size: 14px; }\n    #mds-modal .mds-btn-ok { background: var(--mds-btn-primary-bg, #0073aa); color: var(--mds-btn-primary-text, #ffffff); }\n    #mds-modal .mds-btn-ok:focus { outline: 2px solid var(--mds-border-color, rgba(255,255,255,0.4)); outline-offset: 2px; }\n    ",document.head.appendChild(e);const t=document.createElement("div");t.id="mds-modal-overlay",t.innerHTML='\n      <div id="mds-modal" role="dialog" aria-modal="true" aria-labelledby="mds-modal-title">\n        <div class="mds-modal-body" id="mds-modal-message"></div>\n        <div class="mds-modal-actions">\n          <button type="button" class="mds-btn mds-btn-ok" id="mds-modal-ok">OK</button>\n        </div>\n      </div>',document.body.appendChild(t),t.addEventListener("click",(e=>{e.target.id})),document.getElementById("mds-modal-ok").addEventListener("click",(()=>{t.style.display="none";const e=document.getElementById("mds-modal-ok");e&&e.blur()}))}();let $myblocks,total_cost,grid,gridOffsetLeft,gridOffsetTop,submit_button1,pointer,pixel_container,pixel_form,blocksCanvas,blocksCtx,first_load=!0,ajax_queue=[],USE_AJAX=MDS_OBJECT.USE_AJAX,block_str=MDS_OBJECT.block_str,selectedBlocks=""!==block_str?block_str.split(",").map(Number):[],selecting=!1,ajaxing=!1,submitting=!1,grid_width=MDS_OBJECT.grid_width,grid_height=MDS_OBJECT.grid_height,BLK_WIDTH=MDS_OBJECT.BLK_WIDTH,BLK_HEIGHT=MDS_OBJECT.BLK_HEIGHT,G_MAX_BLOCKS=MDS_OBJECT.G_MAX_BLOCKS,G_MIN_BLOCKS=MDS_OBJECT.G_MIN_BLOCKS,GRD_WIDTH=BLK_WIDTH*grid_width,GRD_HEIGHT=BLK_HEIGHT*grid_height,orig={grid_width:grid_width,grid_height:grid_height,BLK_WIDTH:BLK_WIDTH,BLK_HEIGHT:BLK_HEIGHT,GRD_WIDTH:GRD_WIDTH,GRD_HEIGHT:GRD_HEIGHT},scaled_width=1,scaled_height=1;function add_ajax_loader(e){let t=jQuery("<div class='ajax-loader'></div>");jQuery(e).append(t),t.css("top",jQuery(e).position().top).css("left",jQuery(e).width()/2-t.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}function setupBlocksCanvas(){if(blocksCanvas=document.getElementById("blocks_canvas"),!blocksCanvas||!grid)return;const e=window.MDS_GRID_PARTITION;if(!e)return;const t=window.devicePixelRatio||1;blocksCanvas.style.width=e.preW+"px",blocksCanvas.style.height=e.preH+"px",blocksCanvas.width=Math.round(e.preW*t),blocksCanvas.height=Math.round(e.preH*t),blocksCtx=blocksCanvas.getContext("2d"),blocksCtx.setTransform(t,0,0,t,0,0),blocksCtx.imageSmoothingEnabled=!1}let MDS_SEL_IMG=null;function preloadSelectionImage(e,t){MDS_SEL_IMG=new Image,MDS_SEL_IMG.onload=()=>t&&t(),MDS_SEL_IMG.onerror=()=>{MDS_SEL_IMG=null,t&&t()},MDS_SEL_IMG.src=e}function renderSelectionCanvas(){if(!blocksCanvas||!blocksCtx)return;const e=window.MDS_GRID_PARTITION;if(!e)return;blocksCtx.clearRect(0,0,e.preW,e.preH);const t=!!MDS_SEL_IMG;t||(blocksCtx.fillStyle="rgba(0, 192, 0, 0.35)");for(let o=0;o<selectedBlocks.length;o++){const n=selectedBlocks[o],i=n%e.cols,r=Math.floor(n/e.cols);if(i<0||i>=e.cols||r<0||r>=e.rows)continue;const s=e.colLefts[i],d=e.rowTops[r],l=e.colWidths[i],a=e.rowHeights[r];t?blocksCtx.drawImage(MDS_SEL_IMG,s,d,l,a):blocksCtx.fillRect(s,d,l,a)}}const messageout=function(e){mds_show_modal(String(e))};function has_touch(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function update_order(){selectedBlocks.length>0&&(pixel_form.selected_pixels.value=selectedBlocks.join(","))}function reserve_block(e){if(-1===selectedBlocks.indexOf(e)){selectedBlocks.push(parseInt(e,10));let t=selectedBlocks.indexOf(-1);t>-1&&selectedBlocks.splice(t,1),update_order()}}function unreserve_block(e){let t=selectedBlocks.indexOf(e);t>-1&&(selectedBlocks.splice(t,1),update_order())}function add_block(e,t,o){if(document.getElementById("blocks_canvas"))return void(selectedBlocks.includes(e)||(reserve_block(e),renderSelectionCanvas()));if(document.getElementById("block"+e.toString()))return;let n=get_block_position(e);const i=window.MDS_GRID_PARTITION;let r=i?i.colLefts[n.x]:n.x*BLK_WIDTH+gridOffsetLeft,s=i?i.rowTops[n.y]:n.y*BLK_HEIGHT+gridOffsetTop,d=i?i.colWidths[n.x]:BLK_WIDTH,l=i?i.rowHeights[n.y]:BLK_HEIGHT,a=document.createDocumentFragment(),c=jQuery("<span>",{id:"block"+e.toString(),css:{left:r+"px",top:s+"px",lineHeight:l+"px",fontSize:l+"px",width:d+"px",height:l+"px"}}).addClass("mds-block"),_=jQuery("<img>",{alt:"",src:MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png",css:{lineHeight:l+"px",fontSize:l+"px",width:d+"px",height:l+"px"}});c.append(_),a.appendChild(c[0]),$myblocks.append(a),c.data("blockid",e),reserve_block(e)}function remove_block(e){if(document.getElementById("blocks_canvas"))return unreserve_block(e),void renderSelectionCanvas();let t=document.getElementById("block"+e.toString());null!==t&&t.remove(),unreserve_block(e)}function invert_block(e){null!==document.getElementById("block"+e.id.toString())?remove_block(e.id):add_block(e.id,e.x,e.y)}function is_block_selected(e){return Array.isArray(e)||(e=[{id:e}]),e.some((e=>selectedBlocks.includes(e.id)))}function get_clicked_blocks(e,t,o){const n=window.MDS_GRID_PARTITION;let i=[];const r=mds_getSelectionSize(),s=get_block_position(o);let d=s.x,l=s.y;d=Math.max(0,Math.min(d,n.cols-r)),l=Math.max(0,Math.min(l,n.rows-r));for(let e=0;e<r;e++)for(let t=0;t<r;t++){const o=d+t,r=l+e;if(o>=0&&o<n.cols&&r>=0&&r<n.rows){const e=r*n.cols+o;i.push({id:e,x:n.colLefts[o],y:n.rowTops[r]})}}return i}function do_blocks(e,t){if(Array.isArray(e)||(e=[e]),document.getElementById("blocks_canvas")){if("add"===t){for(const t of e){const e="object"==typeof t?t.id:t;selectedBlocks.includes(e)||selectedBlocks.push(e)}return void renderSelectionCanvas()}if("remove"===t){const t=new Set(e.map((e=>"object"==typeof e?e.id:e)));return selectedBlocks=selectedBlocks.filter((e=>!t.has(e))),void renderSelectionCanvas()}if("invert"===t){for(const t of e){const e="object"==typeof t?t.id:t,o=selectedBlocks.indexOf(e);-1===o?selectedBlocks.push(e):selectedBlocks.splice(o,1)}return void renderSelectionCanvas()}}for(const o of e){const e="object"==typeof o?o.id:o,n="object"==typeof o?o.x:null,i="object"==typeof o?o.y:null;"add"===t?add_block(e,n,i):"remove"===t?remove_block(e):"invert"===t&&invert_block({id:e,x:n,y:i})}has_touch()||$myblocks.on("mousemove",".mds-block",(function(e){let t=getOffset(e.originalEvent.pageX,e.originalEvent.pageY);if(null==t)return!1;show_pointer(t)}))}function select_pixels(e){return!(!pointer&&(pointer=document.getElementById("block_pointer"),!pointer))&&(change_block_state(e.x,e.y),!0)}function load_order(){0!==MDS_OBJECT.blocks.length&&(MDS_OBJECT.blocks.forEach((function(e){add_block(parseInt(e.block_id,10))})),document.getElementById("blocks_canvas")&&renderSelectionCanvas(),null!==pixel_form&&pixel_form.addEventListener("submit",formSubmit))}function getObjCoords(e){var t=e.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,n=window.pageYOffset||document.documentElement.scrollTop;return{x:t.left+o,y:t.top+n}}function mds_partition(e,t){const o=Math.floor(e/t),n=e%t,i=new Array(t).fill(o);for(let e=0;e<n;e++)i[e]+=1;const r=new Array(t+1);r[0]=0;for(let e=0;e<t;e++)r[e+1]=r[e]+i[e];return{widths:i,edges:r}}function computeGridPartitions(){if(!grid)return;const e=parseInt(MDS_OBJECT.grid_width,10)||1,t=parseInt(MDS_OBJECT.grid_height,10)||1,o=jQuery(grid).width(),n=jQuery(grid).height(),i=mds_partition(o,e),r=mds_partition(n,t);window.MDS_GRID_PARTITION={cols:e,rows:t,preW:o,preH:n,colWidths:i.widths,colLefts:i.edges,rowHeights:r.widths,rowTops:r.edges}}function mds_pageToPre(e,t){const o=grid.getBoundingClientRect(),n=window.pageXOffset||document.documentElement.scrollLeft||0,i=window.pageYOffset||document.documentElement.scrollTop||0,r=e-(o.left+n),s=t-(o.top+i),d=window.MDS_GRID_PARTITION;return{preX:r*(d?d.preW/o.width:1),preY:s*(d?d.preH/o.height:1)}}function mds_findIndexFromPre(e,t,o){let n=0,i=o;for(;n+1<i;){const o=n+i>>1;e>=t[o]?n=o:i=o}return n<0?0:n>=o?o-1:n}function mds_sumRange(e,t,o){let n=0;for(let i=0;i<o;i++)n+=e[t+i]||0;return n}function mds_getSelectionSize(){const e=parseInt(jQuery("#mds-selection-size-value").val(),10)||1,t=window.MDS_GRID_PARTITION;return t?Math.max(1,Math.min(e,Math.min(t.cols,t.rows))):e}function getOffset(e,t,o){if(null==grid)return null;window.MDS_GRID_PARTITION||computeGridPartitions();const n=window.MDS_GRID_PARTITION,i=(grid.getBoundingClientRect(),mds_pageToPre(e,t));let r=mds_findIndexFromPre(i.preX,n.colLefts,n.cols),s=mds_findIndexFromPre(i.preY,n.rowTops,n.rows),d=mds_getSelectionSize();return r=Math.max(0,Math.min(r,n.cols-d)),s=Math.max(0,Math.min(s,n.rows-d)),{x:n.colLefts[r],y:n.rowTops[s]}}function get_pointer_size(){let e={};const t=jQuery("#mds-selection-size-slider"),o=jQuery("#mds-selection-size-value"),n=jQuery("#mds-total-blocks-value");if("hidden"===t.attr("type")){let i=parseInt(o.val(),10);const r=Math.max(GRD_WIDTH,GRD_HEIGHT);let s=G_MAX_BLOCKS-selectedBlocks.length,d=Math.floor(Math.sqrt(s));0===i&&(i=Math.floor(Math.sqrt(G_MAX_BLOCKS)));let l=Math.min(i,r,d);for(0===s&&(l=1);(l+1)*(l+1)<=s;)l++,s-=l*l;e.width=BLK_WIDTH*l,e.height=BLK_HEIGHT*l,t.val(l),o.val(l),n.val(l*l)}else{const t=parseInt(jQuery("#mds-selection-size-value").val(),10),o=Math.max(GRD_WIDTH,GRD_HEIGHT),n=Math.min(t,o);e.width=BLK_WIDTH*n,e.height=BLK_HEIGHT*n}return e}function update_pointer_size(){const e=window.MDS_GRID_PARTITION;if(!e||!pointer)return;const t=mds_getSelectionSize();let o=mds_findIndexFromPre(pointer.map_x||0,e.colLefts,e.cols),n=mds_findIndexFromPre(pointer.map_y||0,e.rowTops,e.rows);o=Math.max(0,Math.min(o,e.cols-t)),n=Math.max(0,Math.min(n,e.rows-t));const i=mds_sumRange(e.colWidths,o,t),r=mds_sumRange(e.rowHeights,n,t);pointer.style.width=i+"px",pointer.style.height=r+"px"}function show_pointer(e){return!(!pointer&&(pointer=document.getElementById("block_pointer"),!pointer))&&("visible"!==pointer.style.visibility&&(pointer.style.visibility="visible"),"block"!==pointer.style.display&&(pointer.style.display="block"),pointer.style.top=e.y+"px",pointer.style.left=e.x+"px",pointer.map_x=e.x,pointer.map_y=e.y,update_pointer_size(),!0)}function jsCheckRectangle(e){if(!Array.isArray(e)||e.length<=1)return!0;const t=parseInt(MDS_OBJECT.grid_width,10)||1,o=new Set(e.map((e=>parseInt(e,10)))),n=new Set,i=new Set;for(const e of o){const o=e%t,r=Math.floor(e/t);n.add(o),i.add(r)}const r=Array.from(n).sort(((e,t)=>e-t)),s=Array.from(i).sort(((e,t)=>e-t));for(let e=1;e<r.length;e++)if(r[e]!==r[e-1]+1)return!1;for(let e=1;e<s.length;e++)if(s[e]!==s[e-1]+1)return!1;if(r.length*s.length!==o.size)return!1;for(const e of s)for(const n of r){const i=e*t+n;if(!o.has(i))return!1}return!0}function formSubmit(e){if(e.preventDefault(),e.stopPropagation(),!Array.isArray(selectedBlocks)||0===selectedBlocks.length)return messageout(MDS_OBJECT.no_blocks_selected),!1;if(!1===submitting){submitting=!0,submit_button1.disabled=!0;let e=submit_button1.value;submit_button1.value=MDS_OBJECT.WAIT;const t=parseInt(MDS_OBJECT.G_MIN_BLOCKS,10)||0,o=MDS_OBJECT.selection_adjacency_mode||"ADJACENT";if(t>0&&selectedBlocks.length<t)return messageout("You must select at least "+t+" blocks."),submitting=!1,submit_button1.disabled=!1,submit_button1.value=e,!1;if("RECTANGLE"===o&&!jsCheckRectangle(selectedBlocks))return messageout(MDS_OBJECT.rectangle_required||"Selection must form a rectangle or square."),submitting=!1,submit_button1.disabled=!1,submit_button1.value=e,!1;let n=setInterval((function(){if(0===ajax_queue.length&&(clearInterval(n),null!==pixel_form)){let e=document.getElementById("selected_pixels");e&&(e.value=selectedBlocks.join(",")),mds_update_package(jQuery(pixel_form)),pixel_form.submit()}}),1e3)}}function reset_pixels(){ajax_queue=[],add_ajax_loader(".mds-pixel-wrapper"),jQuery.ajax({type:"POST",url:MDS_OBJECT.UPDATE_ORDER,data:{reset:"true",action:"reset",_wpnonce:MDS_OBJECT.NONCE,BID:MDS_OBJECT.BID},success:function(e){if(!0===e.success&&e.data&&"removed"===e.data.type){selectedBlocks=[];const e=document.getElementById("selected_pixels");e&&(e.value=""),renderSelectionCanvas()}},error:function(e,t,o){},complete:function(){remove_ajax_loader()}})}function rescale_grid(){if(null==grid)return;grid.getBoundingClientRect();let e=parseInt(jQuery(grid).attr("data-original-width"),10)||orig.GRD_WIDTH,t=parseInt(jQuery(grid).attr("data-original-height"),10)||orig.GRD_HEIGHT;const o=jQuery(grid).width(),n=jQuery(grid).height();grid_width=o,grid_height=n,scaled_width=o/e,scaled_height=n/t,computeGridPartitions(),"function"==typeof scaleImageMap&&scaleImageMap(),setupBlocksCanvas(),renderSelectionCanvas(),BLK_WIDTH=orig.BLK_WIDTH*scaled_width,BLK_HEIGHT=orig.BLK_HEIGHT*scaled_height,gridOffsetLeft=0,gridOffsetTop=0,jQuery(pointer).rescaleStyles();let i=selectedBlocks.slice();$myblocks.empty(),i.length>0&&i.forEach((function(e){add_block(e)})),window.scaleImageMap&&"function"==typeof window.scaleImageMap&&window.scaleImageMap()}function center_block(e){let t=get_pointer_size();return e.x-=t.width/2-BLK_WIDTH/2,e.y-=t.height/2-BLK_HEIGHT/2,e}function IsNumeric(e){let t,o=!0;for(let n=0;n<e.length&&!0===o;n++)t=e.charAt(n),-1==="0123456789".indexOf(t)&&(o=!1);return o}function get_block_position(e){const t=Math.floor(orig.GRD_WIDTH/orig.BLK_WIDTH);return{x:e%t,y:Math.floor(e/t)}}function get_clicked_block(e,t){window.MDS_GRID_PARTITION||computeGridPartitions();const o=window.MDS_GRID_PARTITION,n=mds_findIndexFromPre(e,o.colLefts,o.cols);return mds_findIndexFromPre(t,o.rowTops,o.rows)*o.cols+n}function change_block_state(e,t){const o=get_clicked_block(e,t),n=parseInt(jQuery("#mds-selection-size-value").val(),10)||1,i=get_clicked_blocks(e,t,o),r=jQuery("#erase").is(":checked");let s=[],d=[],l="add";if(r?(l="remove",i.forEach((e=>{selectedBlocks.includes(e.id)&&d.push(e.id)}))):"YES"===MDS_OBJECT.INVERT_PIXELS?(l="invert",i.forEach((e=>{selectedBlocks.includes(e.id)?d.push(e.id):s.push(e.id)}))):(l="add",i.forEach((e=>{selectedBlocks.includes(e.id)||s.push(e.id)}))),s.forEach((e=>{add_block(e)})),d.forEach((e=>{remove_block(e)})),0===s.length&&0===d.length)return;const a=new URL(MDS_OBJECT.UPDATE_ORDER,window.location.origin);a.searchParams.set("selection_size",n),a.searchParams.set("user_id",MDS_OBJECT.user_id),a.searchParams.set("block_id",o.toString()),a.searchParams.set("BID",MDS_OBJECT.BID),a.searchParams.set("t",MDS_OBJECT.time),a.searchParams.set("_wpnonce",MDS_OBJECT.NONCE),a.searchParams.set("action",l);let c={action:l,clicked_block:o,OffsetX:e,OffsetY:t,blocks_to_add:s,blocks_to_remove:d,original_add:s,original_remove:d,url:a.toString()};ajax_queue.push(c)}function implode(e){let t="",o="";for(let n in e)e.hasOwnProperty(n)&&(t=t+o+e[n]),o=",";return t}let resizeTimer;function initializeGrid(){if(grid=document.getElementById("pixelimg"),$myblocks=jQuery("#blocks"),total_cost=document.getElementById("total_cost"),submit_button1=document.getElementById("submit_button1"),pointer=document.getElementById("block_pointer"),pixel_container=document.getElementById("pixel_container"),pixel_form=document.getElementById("pixel_form"),blocksCanvas=document.getElementById("blocks_canvas"),!grid||!pixel_container||!pointer)return;rescale_grid(),setupBlocksCanvas(),preloadSelectionImage(MDS_OBJECT&&MDS_OBJECT.MDS_CORE_URL?MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png":"",(function(){renderSelectionCanvas()})),load_order();let e,t,o=!0;const n=Math.min(BLK_WIDTH,BLK_HEIGHT)/2;if(jQuery(pixel_container).on("mousedown",(function(n){o=!0,e=n.originalEvent.pageX,t=n.originalEvent.pageY,window.mds_loader_shown||(i(jQuery(".mds-pixel-wrapper")),window.mds_loader_shown=!0)})).on("mousemove",(function(i){if(o){let r=i.originalEvent.pageX,s=i.originalEvent.pageY;(Math.abs(e-r)>n||Math.abs(t-s)>n)&&(o=!1)}let r=center_block({x:i.originalEvent.pageX,y:i.originalEvent.pageY}),s=getOffset(r.x,r.y);if(null==s)return!1;show_pointer(s)})).on("click",(function(e){if(e.preventDefault(),o){let t=center_block({x:e.originalEvent.pageX,y:e.originalEvent.pageY}),o=getOffset(t.x,t.y);if(null==o)return!1;show_pointer(o),select_pixels(o)}return o=!0,!1})),has_touch()){new PointerListener(pixel_container,{supportedGestures:[Tap,Pinch,Pan]});pixel_container.addEventListener("tap",(function(e){window.mds_loader_shown||(i(jQuery(".mds-pixel-wrapper")),window.mds_loader_shown=!0);let t=getOffset(e.detail.live.center.x,e.detail.live.center.y,!0);if(null==t)return!0;show_pointer(t),select_pixels(t)})),pixel_container.addEventListener("pinch",(function(e){e.preventDefault&&e.preventDefault();const t=e.detail.live.scale;!t||t<=0||applyZoom(t,e.detail.live.center.x,e.detail.live.center.y)})),pixel_container.addEventListener("pan",(function(e){window.mds_zoom<=1||(window.mds_pan_x+=e.detail.live.deltaX,window.mds_pan_y+=e.detail.live.deltaY,applyTransform())}))}function i(e){let t=jQuery("<div class='ajax-loader'></div>"),o=jQuery(e);o.length>0&&(o.append(t),t.css("z-index","10050").css("top",o.position().top).css("left",jQuery(e).width()/2-t.width()/2))}jQuery(grid).on("contextmenu",(e=>{e.preventDefault()})),submit_button1&&jQuery(submit_button1).on("click",formSubmit),jQuery("#reset_button").on("click",reset_pixels),setInterval((function(){if(0===ajax_queue.length||ajaxing)return;ajaxing=!0,window.mds_loader_shown||(i(jQuery(".mds-pixel-wrapper")),window.mds_loader_shown=!0);let e=ajax_queue.shift();jQuery.ajax({type:"POST",url:e.url,data:{_wpnonce:MDS_OBJECT.NONCE,action:e.action,block_id:e.clicked_block,selection_size:parseInt(jQuery("#mds-selection-size-value").val(),10)||1,BID:MDS_OBJECT.BID,blocks_to_add:e.blocks_to_add.join(","),blocks_to_remove:e.blocks_to_remove.join(",")},success:function(t){if(!0===t.success){if(t.data&&t.data.data){const o=t.data.data;if(o.added&&Array.isArray(o.added)&&o.added.length>0){const t=o.added.filter((t=>!(e.original_add||[]).includes(t)));t.length&&do_blocks(t,"add")}if(o.removed&&Array.isArray(o.removed)&&o.removed.length>0){const t=o.removed.filter((t=>!(e.original_remove||[]).includes(t)));t.length&&do_blocks(t,"remove")}"order_id"===o.type&&pixel_form&&(pixel_form.order_id.value=parseInt(o.value,10))}}else"invert"===e.action?(do_blocks(e.original_add,"remove"),do_blocks(e.original_remove,"add")):do_blocks(e.original_add,"remove"),t.data&&t.data.data&&t.data.data.value?messageout(t.data.data.value):messageout("An unknown error occurred.")},error:function(t,o,n){"invert"===e.action?(do_blocks(e.original_add,"remove"),do_blocks(e.original_remove,"add")):do_blocks(e.original_add,"remove");let i=null;t&&t.responseJSON&&t.responseJSON.data&&(t.responseJSON.data.data&&t.responseJSON.data.data.value?i=t.responseJSON.data.data.value:t.responseJSON.data.value&&(i=t.responseJSON.data.value)),messageout(i||"Request failed: "+o)},complete:function(){ajaxing=!1,0===ajax_queue.length&&(remove_ajax_loader(),window.mds_loader_shown=!1)}})}),100),i(jQuery(".mds-pixel-wrapper"));const r=jQuery("#mds-selection-size-slider"),s=jQuery("#mds-selection-size-value"),d=jQuery("#mds-total-blocks-value");if(r.length>0){r.on("input",(function(){const e=parseInt(jQuery(this).val()),t=Math.min(e,Math.min(GRD_WIDTH,GRD_HEIGHT));s.val(t),d.val(Math.pow(t,2)),update_pointer_size()})),s.on("input",(function(){const e=parseInt(jQuery(this).val()),t=Math.min(e,Math.min(GRD_WIDTH,GRD_HEIGHT));r.val(t),d.val(Math.pow(t,2)),update_pointer_size()}));let e,t=parseInt(d.val());d.on("input",(function(){let o=parseInt(jQuery(this).val());let n=o>t?Math.ceil(Math.sqrt(o)):Math.floor(Math.sqrt(o));const i=Math.min(n,Math.min(GRD_WIDTH,GRD_HEIGHT));r.val(i),s.val(i),clearTimeout(e),e=setTimeout((()=>{o=Math.pow(i,2),d.val(o),t=o,update_pointer_size()}),1e3)}))}if(0===jQuery("#reset_zoom_button").length){const e=jQuery("<button>",{id:"reset_zoom_button",class:"mds-reset-zoom",text:"Reset Zoom",css:{position:"absolute",right:"10px",top:"10px","z-index":"1000",padding:"5px 10px",background:"rgba(0,0,0,0.5)",color:"white",border:"none","border-radius":"4px",display:"none",cursor:"pointer"}});jQuery(".mds-pixel-wrapper").append(e),e.on("click",resetZoom)}}jQuery.fn.rescaleStyles=function(){return this.css({width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px","line-height":BLK_HEIGHT+"px","font-size":BLK_HEIGHT+"px"}),this},jQuery.fn.repositionStyles=function(){if(void 0===this.attr("id"))return this;const e=window.MDS_GRID_PARTITION;let t=get_block_position(parseInt(jQuery(this).data("blockid"),10));return e?(this.css({top:e.rowTops[t.y]+"px",left:e.colLefts[t.x]+"px",width:e.colWidths[t.x]+"px",height:e.rowHeights[t.y]+"px"}),this.find("img").css({width:e.colWidths[t.x]+"px",height:e.rowHeights[t.y]+"px"})):this.css({top:t.y*BLK_HEIGHT+gridOffsetTop+"px",left:t.x*BLK_WIDTH+gridOffsetLeft+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}),this},window.addEventListener("resize",(function(){clearTimeout(resizeTimer),resizeTimer=setTimeout((function(){rescale_grid()}),100)}));var gridInitialized=!1;const observerTarget=document.body,observerConfig={childList:!0,subtree:!0},mutationObserver=new MutationObserver(((e,t)=>{if(!gridInitialized)for(const o of e)if("childList"===o.type){const e=document.getElementById("pixelimg");if(e){const o=()=>{gridInitialized||(gridInitialized=!0,initializeGrid(),t.disconnect(),jQuery(".ajax-loader").remove())};e.complete?o():e.addEventListener("load",o);break}}}));function applyZoom(e,t,o){const n=window.mds_zoom||1,i=Math.min(3,n*e);i<1?resetZoom():(window.mds_zoom=i,i>1?jQuery("#reset_zoom_button").show():jQuery("#reset_zoom_button").hide(),applyTransform())}function applyTransform(){const e=jQuery(".mds-pixel-wrapper");if(!e.length)return;const t=`scale(${window.mds_zoom}) translate(${window.mds_pan_x/window.mds_zoom}px, ${window.mds_pan_y/window.mds_zoom}px)`;e.css({transform:t,"transform-origin":"top left",transition:"transform 0.1s"}),rescale_grid()}function resetZoom(){window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0;jQuery(".mds-pixel-wrapper").css({transform:"none",transition:"transform 0.3s"}),jQuery("#reset_zoom_button").hide(),rescale_grid()}function scaleImageMap(){var e=document.getElementById("pixelimg");if(e){var t=parseInt(e.getAttribute("data-original-width"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_width_px||MDS_OBJECT.grid_width*MDS_OBJECT.BLK_WIDTH,o=parseInt(e.getAttribute("data-original-height"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_height_px||MDS_OBJECT.grid_height*MDS_OBJECT.BLK_HEIGHT,n=(e.clientWidth||e.offsetWidth)/t,i=(e.clientHeight||e.offsetHeight)/o,r=document.querySelectorAll(".gridblock");if(r&&r.length>0)for(var s=0;s<r.length;s++){var d=r[s],l=parseInt(d.getAttribute("data-x"),10)||0,a=parseInt(d.getAttribute("data-y"),10)||0;if(l&&a){var c=Math.round(l*n),_=Math.round(a*i);d.style.left=c+"px",d.style.top=_+"px"}}if(void 0!==window.mds_pointer_x&&void 0!==window.mds_pointer_y){c=Math.round(window.mds_pointer_x*n),_=Math.round(window.mds_pointer_y*i);var u=document.getElementById("block_pointer");u&&(u.style.left=c+"px",u.style.top=_+"px")}}}mutationObserver.observe(observerTarget,observerConfig),window.scaleImageMap=scaleImageMap;