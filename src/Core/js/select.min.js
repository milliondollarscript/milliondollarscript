var AF=!1,s=!0,z=[],SF=MDS_OBJECT.USE_AJAX,t=MDS_OBJECT.block_str,Y=t!==""?t.split(",").map(Number):[];var f=!1,r=!1,u=MDS_OBJECT.grid_width,m=MDS_OBJECT.grid_height,w=MDS_OBJECT.BLK_WIDTH,R=MDS_OBJECT.BLK_HEIGHT,o=MDS_OBJECT.G_MAX_BLOCKS,LF=MDS_OBJECT.G_MIN_BLOCKS,S=w*u,L=R*m,W={grid_width:u,grid_height:m,BLK_WIDTH:w,BLK_HEIGHT:R,GRD_WIDTH:S,GRD_HEIGHT:L},T=1,O=1,x,CF,E,a,i,I,X,G,y;function ZF(F){let J=jQuery("<div class='ajax-loader'></div>");jQuery(F).append(J),J.css("top",jQuery(F).position().top).css("left",jQuery(F).width()/2-J.width()/2)}function _(){jQuery(".ajax-loader").remove()}var B=function(F){if(AF)console.log(F);else alert(F)};jQuery.fn.rescaleStyles=function(){return this.css({width:w+"px",height:R+"px","line-height":R+"px","font-size":R+"px"}),this};jQuery.fn.repositionStyles=function(){if(this.attr("id")===void 0)return this;let F=parseInt(jQuery(this).data("blockid"),10),J=NF(F);return this.css({top:J.y*R+i+"px",left:J.x*w+a+"px",width:w+"px",height:R+"px"}),this};function JF(){try{return document.createEvent("TouchEvent"),!0}catch(F){return!1}}function QF(){if(Y.length>0)y.selected_pixels.value=Y.join(",")}function RF(F){if(Y.indexOf(F)===-1){Y.push(parseInt(F,10));let J=Y.indexOf(-1);if(J>-1)Y.splice(J,1);QF()}}function WF(F){let J=Y.indexOf(F);if(J>-1)Y.splice(J,1),QF()}function b(F,J,P){let N=NF(F),M=N.x*w+a,Q=N.y*R+i,q=document.createDocumentFragment(),C=jQuery("<span>",{id:"block"+F.toString(),css:{left:M+"px",top:Q+"px",lineHeight:R+"px",fontSize:R+"px",width:w+"px",height:R+"px"}}).addClass("mds-block"),V=jQuery("<img>",{alt:"",src:MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png",css:{lineHeight:R+"px",fontSize:R+"px",width:w+"px",height:R+"px"}});C.append(V),q.appendChild(C[0]),x.append(q),C.data("blockid",F),RF(F)}function c(F){let J=document.getElementById("block"+F.toString());if(J!==null)J.remove();WF(F)}function wF(F){if(document.getElementById("block"+F.id.toString())!==null)c(F.id);else b(F.id,F.x,F.y)}function EF(F){return Y.indexOf(F)!==-1}function jF(F,J,P){let N=[],M,Q,q=parseInt(jQuery("#mds-selection-size-value").val(),10);if(q>1){for(let C=0;C<q;C++)for(let V=0;V<q;V++)if(M=F+C*w,Q=J+V*R,M>=0&&M<S&&Q>=0&&Q<L)N.push({id:qF(M,Q),x:M,y:Q})}else M=F,Q=J,N.push({id:P,x:M,y:Q});return N}function j(F,J,P,N){let M=jF(J,P,F);for(let Q of M)if(N==="add")b(Q.id,Q.x,Q.y);else if(N==="remove")c(Q.id);else if(N==="invert")wF(Q);if(!JF())x.on("mousemove",".mds-block",function(Q){let q=g(Q.originalEvent.pageX,Q.originalEvent.pageY);if(q==null)return!1;p(q)})}function UF(F){return $F(F.x,F.y),!0}function YF(){if(MDS_OBJECT.blocks.length===0)return;for(let F=0;F<MDS_OBJECT.blocks.length;F++)b(parseInt(MDS_OBJECT.blocks[F].block_id,10),parseInt(MDS_OBJECT.blocks[F].x,10)*T,parseInt(MDS_OBJECT.blocks[F].y,10)*O);if(y!==null)y.addEventListener("submit",PF)}function KF(F){var J=F.getBoundingClientRect(),P=window.pageXOffset||document.documentElement.scrollLeft,N=window.pageYOffset||document.documentElement.scrollTop;return{x:J.left+P,y:J.top+N}}function g(F,J,P){if(E==null)return null;let N=KF(E),M=l(),Q={},q=0,C=0;if(P)q=document.documentElement.scrollLeft,C=document.documentElement.scrollTop;return Q.x=F-N.x+q,Q.y=J-N.y+C,Q.x=Math.floor(Q.x/T/W.BLK_WIDTH)*W.BLK_WIDTH,Q.y=Math.floor(Q.y/O/W.BLK_HEIGHT)*W.BLK_HEIGHT,Q.x=Math.max(Math.min(Q.x,S-M.width/T),0),Q.y=Math.max(Math.min(Q.y,L-M.height/O),0),Q.x=Q.x*T,Q.y=Q.y*O,Q}function l(){let F={},J=jQuery("#mds-selection-size-slider"),P=jQuery("#mds-selection-size-value"),N=jQuery("#mds-total-blocks-value");if(J.attr("type")==="hidden"){let M=parseInt(P.val(),10),Q=Math.max(S,L),q=o-Y.length,C=Math.floor(Math.sqrt(q));if(M===0)M=Math.floor(Math.sqrt(o));let V=Math.min(M,Q,C);if(q===0)V=1;while((V+1)*(V+1)<=q)V++,q=q-V*V;F.width=w*V,F.height=R*V,J.val(V),P.val(V),N.val(V*V)}else{let M=parseInt(jQuery("#mds-selection-size-value").val(),10),Q=Math.max(S,L),q=Math.min(M,Q);F.width=w*q,F.height=R*q}return F}function H(){let F=l();X.style.width=F.width+"px",X.style.height=F.height+"px"}function p(F){return X.style.visibility="visible",X.style.display="block",X.style.top=F.y+"px",X.style.left=F.x+"px",X.map_x=F.x,X.map_y=F.y,H(),!0}function PF(F){if(F.preventDefault(),F.stopPropagation(),x.html().trim()==="")return B(MDS_OBJECT.no_blocks_selected),!1;if(r===!1){r=!0,I.disabled=!0;let J=I.value;I.value=MDS_OBJECT.WAIT;let P=setInterval(function(){if(z.length===0){if(clearInterval(P),y!==null){let N=document.getElementById("selected_pixels");if(N)N.value=Y.join(",");mds_update_package(jQuery(y)),y.submit()}I.disabled=!1,I.value=J,r=!1}},1000)}}function XF(){z=[],ZF(".mds-pixel-wrapper"),jQuery.ajax({type:"POST",url:MDS_OBJECT.UPDATE_ORDER,data:{reset:!0,action:"reset",_wpnonce:MDS_OBJECT.NONCE},success:function(F){if(F.success===!0&&F.data&&F.data.type==="removed")x.children().each(function(){c(jQuery(this).data("blockid"))})},complete:function(){_()}})}function v(){if(E==null)return;let F=parseInt(jQuery(E).attr("data-original-width"),10)||W.GRD_WIDTH,J=parseInt(jQuery(E).attr("data-original-height"),10)||W.GRD_HEIGHT;if(u=jQuery(E).width(),m=jQuery(E).height(),T=u/F,O=m/J,typeof d==="function")d();w=W.BLK_WIDTH*T,R=W.BLK_HEIGHT*O,a=E.offsetLeft,i=E.offsetTop,jQuery(X).rescaleStyles();let P=Y.slice();if(x.empty(),P.length>0)P.forEach(function(N){b(N)});if(window.scaleImageMap&&typeof window.scaleImageMap==="function")window.scaleImageMap()}function e(F){let J=l();return F.x-=J.width/2-w/2,F.y-=J.height/2-R/2,F}function yF(){let F=!0,J,P,N=Math.min(w,R)/2;jQuery(G).on("mousedown",function(M){F=!0,J=M.originalEvent.pageX,P=M.originalEvent.pageY}),jQuery(G).on("mousemove",function(M){if(F){let C=M.originalEvent.pageX,V=M.originalEvent.pageY;if(Math.abs(J-C)>N||Math.abs(P-V)>N)F=!1}let Q=e({x:M.originalEvent.pageX,y:M.originalEvent.pageY}),q=g(Q.x,Q.y);if(q==null)return!1;p(q)}),jQuery(G).on("click",function(M){if(M.preventDefault(),F){let Q=e({x:M.originalEvent.pageX,y:M.originalEvent.pageY}),q=g(Q.x,Q.y);if(q==null)return!1;p(q),UF(q)}return F=!0,!1})}function DF(){if(window.mds_zoom===void 0)window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0;let F={supportedGestures:[Tap,Pinch,Pan]},J=new PointerListener(G,F);G.addEventListener("tap",function(P){let N=g(P.detail.live.center.x,P.detail.live.center.y,!0);if(N==null)return!0;p(N),UF(N)}),G.addEventListener("pinch",function(P){P.preventDefault&&P.preventDefault();let N=P.detail.live.scale;if(!N||N<=0)return;GF(N,P.detail.live.center.x,P.detail.live.center.y)}),G.addEventListener("pan",function(P){if(window.mds_zoom<=1)return;window.mds_pan_x+=P.detail.live.deltaX,window.mds_pan_y+=P.detail.live.deltaY,MF()})}function NF(F){let J=Math.floor(W.GRD_WIDTH/W.BLK_WIDTH),P=F%J,N=Math.floor(F/J);return{x:P,y:N}}function qF(F,J){F/=T,J/=O;let P=F/W.BLK_WIDTH,N=J/W.BLK_HEIGHT*(W.GRD_WIDTH/W.BLK_WIDTH);return Math.round(P+N)}function $F(F,J){let P=qF(F,J),N=jQuery("#erase").is(":checked"),M=parseInt(y.elements.selection_size.value,10),Q={erasing:N,clicked_block:P,OffsetX:F,OffsetY:J,url:(()=>{let q=new URL(MDS_OBJECT.UPDATE_ORDER,window.location.origin);return q.searchParams.set("selection_size",M),q.searchParams.set("user_id",MDS_OBJECT.user_id),q.searchParams.set("block_id",P.toString()),q.searchParams.set("BID",MDS_OBJECT.BID),q.searchParams.set("t",MDS_OBJECT.time),q.searchParams.set("erase",N),q.searchParams.set("_wpnonce",MDS_OBJECT.NONCE),q.toString()})()};if(EF(P))if(N)Q.action="remove",j(P,F,J,"remove");else if(MDS_OBJECT.INVERT_PIXELS==="YES")Q.action="invert",j(P,F,J,"invert");else Q.action="add",j(P,F,J,"add");else if(N)Q.action="remove",j(P,F,J,"remove");else if(MDS_OBJECT.INVERT_PIXELS==="YES")Q.action="invert",j(P,F,J,"invert");else Q.action="add",j(P,F,J,"add");z.push(Q)}var FF;window.addEventListener("resize",function(){clearTimeout(FF),FF=setTimeout(function(){v()},100)});jQuery(document).on("ajaxComplete",function(F,J,P){if(console.log("ajaxComplete"),new URLSearchParams(P.data).get("type")!=="order")return;if(s)s=!1;else return;E=document.getElementById("pixelimg");let Q=jQuery(E);if(x=jQuery("#blocks"),CF=document.getElementById("total_cost"),I=document.getElementById("submit_button1"),X=document.getElementById("block_pointer"),G=document.getElementById("pixel_container"),y=document.getElementById("pixel_form"),v(),Q.length===0)_();if(JF())DF();else yF();jQuery(E).oncontextmenu=(U)=>{U.preventDefault()};let q=setInterval(function(){if(z.length===0||f)return;f=!0,V(".mds-pixel-wrapper");let U=z.shift();jQuery.ajax({type:"POST",url:U.url,data:{_wpnonce:MDS_OBJECT.NONCE,erasing:U.erasing},success:function(Z){if(Z.success!==!0||Z.data&&Z.data.error==="true"){switch(U.action){case"invert":j(U.clicked_block,U.OffsetX,U.OffsetY,"invert");break;case"remove":if(!U.erasing)j(U.clicked_block,U.OffsetX,U.OffsetY,"add");break;case"add":j(U.clicked_block,U.OffsetX,U.OffsetY,"remove");break}B(Z.data.data.value)}if(Z.data&&Z.data.type==="order_id"){if(y!==null)y.order_id.value=parseInt(Z.data.data.value,10)}},fail:function(){switch(U.action){case"invert":j(U.clicked_block,U.OffsetX,U.OffsetY,"invert");break;case"remove":j(U.clicked_block,U.OffsetX,U.OffsetY,"add");break;case"add":j(U.clicked_block,U.OffsetX,U.OffsetY,"remove");break}if(jQuery.isPlainObject(U))B("Error: "+JSON.stringify(U));else B("Error: "+U)},complete:function(){f=!1,_()}})},100);document.querySelectorAll('.mds-select-input input[type="checkbox"]').forEach(function(U){U.addEventListener("hover",function(){this.style.cursor="pointer"}),U.addEventListener("change",function(){let Z=this.nextElementSibling,A=Z.querySelector(".icon-erase"),K=Z.querySelector(".icon-select");if(A&&K)if(this.checked)A.setAttribute("stroke","#FFFFFF"),K.setAttribute("stroke","none");else A.setAttribute("stroke","none"),K.setAttribute("stroke","#008000")})});let C=jQuery("#pixelimg");C.one("load",function(){v(),YF(),jQuery(".ajax-loader").remove()}).each(function(){if(this.complete)jQuery(this).trigger("load")}),C.on("loadstart",function(){V(".mds-pixel-wrapper")});function V(U){let Z=jQuery("<div class='ajax-loader'></div>"),A=jQuery(U);if(A.length>0)A.append(Z),Z.css("z-index","10000").css("top",A.position().top).css("left",jQuery(U).width()/2-Z.width()/2)}V(".mds-pixel-wrapper");let D=jQuery("#mds-selection-size-slider"),h=jQuery("#mds-selection-size-value"),$=jQuery("#mds-total-blocks-value");if(D.length>0){D.on("input",function(){let A=parseInt(jQuery(this).val());console.log("blockSize",A);let K=Math.min(A,Math.min(S,L));h.val(K),$.val(Math.pow(K,2)),H()}),h.on("input",function(){let A=parseInt(jQuery(this).val()),K=Math.min(A,Math.min(S,L));D.val(K),$.val(Math.pow(K,2)),H()});let U=parseInt($.val()),Z;$.on("input",function(){let A=parseInt(jQuery(this).val()),K=A>U,k;if(K)k=Math.ceil(Math.sqrt(A));else k=Math.floor(Math.sqrt(A));let n=Math.min(k,Math.min(S,L));D.val(n),h.val(n),clearTimeout(Z),Z=setTimeout(()=>{A=Math.pow(n,2),$.val(A),U=A,H()},1000)})}if(jQuery(I).on("click",function(U){return U.preventDefault(),U.stopPropagation(),PF(U),!1}),jQuery("#reset_button").on("click",function(U){return U.preventDefault(),U.stopPropagation(),XF(),!1}),jQuery("#reset_zoom_button").length===0){let U=jQuery("<button>",{id:"reset_zoom_button",class:"mds-reset-zoom",text:"Reset Zoom",css:{position:"absolute",right:"10px",top:"10px","z-index":"1000",padding:"5px 10px",background:"rgba(0,0,0,0.5)",color:"white",border:"none","border-radius":"4px",display:"none",cursor:"pointer"}});jQuery(".mds-pixel-wrapper").append(U),U.on("click",function(){VF()})}});function GF(F,J,P){let M=window.mds_zoom||1,Q=Math.min(3,M*F);if(Q<1){VF();return}if(window.mds_zoom=Q,Q>1)jQuery("#reset_zoom_button").show();else jQuery("#reset_zoom_button").hide();MF()}function MF(){let F=jQuery(".mds-pixel-wrapper");if(!F.length)return;let J=`scale(${window.mds_zoom}) translate(${window.mds_pan_x/window.mds_zoom}px, ${window.mds_pan_y/window.mds_zoom}px)`;F.css({transform:J,"transform-origin":"center center",transition:"transform 0.1s"}),v()}function VF(){window.mds_zoom=1,window.mds_pan_x=0,window.mds_pan_y=0,jQuery(".mds-pixel-wrapper").css({transform:"none",transition:"transform 0.3s"}),jQuery("#reset_zoom_button").hide(),v()}function d(){var F=document.getElementById("pixelimg");if(!F)return;var J=parseInt(F.getAttribute("data-original-width"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_width_px||MDS_OBJECT.grid_width*MDS_OBJECT.BLK_WIDTH,P=parseInt(F.getAttribute("data-original-height"),10)||MDS_OBJECT.grid_data&&MDS_OBJECT.grid_data.orig_height_px||MDS_OBJECT.grid_height*MDS_OBJECT.BLK_HEIGHT,N=F.clientWidth||F.offsetWidth,M=F.clientHeight||F.offsetHeight,Q=N/J,q=M/P,C=document.querySelectorAll(".gridblock");if(C&&C.length>0)for(var V=0;V<C.length;V++){var D=C[V],h=parseInt(D.getAttribute("data-x"),10)||0,$=parseInt(D.getAttribute("data-y"),10)||0;if(h&&$){var U=Math.round(h*Q),Z=Math.round($*q);D.style.left=U+"px",D.style.top=Z+"px"}}if(window.mds_pointer_x!==void 0&&window.mds_pointer_y!==void 0){var U=Math.round(window.mds_pointer_x*Q),Z=Math.round(window.mds_pointer_y*q),A=document.getElementById("block_pointer");if(A)A.style.left=U+"px",A.style.top=Z+"px"}}window.scaleImageMap=d;
