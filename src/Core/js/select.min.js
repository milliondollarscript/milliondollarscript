let debug=false;let first_load=true;let ajax_queue=[];let USE_AJAX=MDS_OBJECT.USE_AJAX;let block_str=MDS_OBJECT.block_str;let selectedBlocks=block_str!==""?block_str.split(",").map(Number):[];let selecting=false;let ajaxing=false;let submitting=false;let grid_width=MDS_OBJECT.grid_width;let grid_height=MDS_OBJECT.grid_height;let BLK_WIDTH=MDS_OBJECT.BLK_WIDTH;let BLK_HEIGHT=MDS_OBJECT.BLK_HEIGHT;let G_MAX_BLOCKS=MDS_OBJECT.G_MAX_BLOCKS;let G_MIN_BLOCKS=MDS_OBJECT.G_MIN_BLOCKS;let GRD_WIDTH=BLK_WIDTH*grid_width;let GRD_HEIGHT=BLK_HEIGHT*grid_height;let orig={grid_width:grid_width,grid_height:grid_height,BLK_WIDTH:BLK_WIDTH,BLK_HEIGHT:BLK_HEIGHT,GRD_WIDTH:GRD_WIDTH,GRD_HEIGHT:GRD_HEIGHT};let scaled_width=1;let scaled_height=1;let $myblocks;let total_cost;let grid;let gridOffsetLeft;let gridOffsetTop;let submit_button1;let pointer;let pixel_container;let pixel_form;function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");jQuery(container).append($ajax_loader);$ajax_loader.css("top",jQuery(container).position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}const messageout=function(message){if(debug){console.log(message)}else{alert(message)}};jQuery.fn.rescaleStyles=function(){this.css({width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px","line-height":BLK_HEIGHT+"px","font-size":BLK_HEIGHT+"px"});return this};jQuery.fn.repositionStyles=function(){if(this.attr("id")===undefined){return this}let id=parseInt(jQuery(this).data("blockid"),10);let pos=get_block_position(id);this.css({top:pos.y*BLK_HEIGHT+gridOffsetTop+"px",left:pos.x*BLK_WIDTH+gridOffsetLeft+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"});return this};function has_touch(){try{document.createEvent("TouchEvent");return true}catch(e){return false}}function update_order(){if(selectedBlocks.length>0){pixel_form.selected_pixels.value=selectedBlocks.join(",")}}function reserve_block(block_id){if(selectedBlocks.indexOf(block_id)===-1){selectedBlocks.push(parseInt(block_id,10));let index=selectedBlocks.indexOf(-1);if(index>-1){selectedBlocks.splice(index,1)}update_order()}}function unreserve_block(block_id){let index=selectedBlocks.indexOf(block_id);if(index>-1){selectedBlocks.splice(index,1);update_order()}}function add_block(block_id,block_x,block_y){let pos=get_block_position(block_id);let block_left=pos.x*BLK_WIDTH+gridOffsetLeft;let block_top=pos.y*BLK_HEIGHT+gridOffsetTop;let fragment=document.createDocumentFragment();let $new_block=jQuery("<span>",{id:"block"+block_id.toString(),css:{left:block_left+"px",top:block_top+"px",lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}}).addClass("mds-block");let $new_img=jQuery("<img>",{alt:"",src:MDS_OBJECT.MDS_CORE_URL+"images/selected_block.png",css:{lineHeight:BLK_HEIGHT+"px",fontSize:BLK_HEIGHT+"px",width:BLK_WIDTH+"px",height:BLK_HEIGHT+"px"}});$new_block.append($new_img);fragment.appendChild($new_block[0]);$myblocks.append(fragment);$new_block.data("blockid",block_id);reserve_block(block_id)}function remove_block(block_id){let myblock=document.getElementById("block"+block_id.toString());if(myblock!==null){myblock.remove()}unreserve_block(block_id)}function invert_block(clicked_block){let myblock=document.getElementById("block"+clicked_block.id.toString());if(myblock!==null){remove_block(clicked_block.id)}else{add_block(clicked_block.id,clicked_block.x,clicked_block.y)}}function is_block_selected(clicked_block){return selectedBlocks.indexOf(clicked_block)!==-1}function get_clicked_blocks(OffsetX,OffsetY,block){let clicked_blocks=[];let x;let y;const selectedSize=parseInt(jQuery("#mds-selection-size-value").val(),10);if(selectedSize>1){for(let i=0;i<selectedSize;i++){for(let j=0;j<selectedSize;j++){x=OffsetX+i*BLK_WIDTH;y=OffsetY+j*BLK_HEIGHT;if(x>=0&&x<GRD_WIDTH&&y>=0&&y<GRD_HEIGHT){clicked_blocks.push({id:get_clicked_block(x,y),x:x,y:y})}}}}else{x=OffsetX;y=OffsetY;clicked_blocks.push({id:block,x:x,y:y})}return clicked_blocks}function do_blocks(block,OffsetX,OffsetY,op){let clicked_blocks=get_clicked_blocks(OffsetX,OffsetY,block);for(const clicked_block of clicked_blocks){if(op==="add"){add_block(clicked_block.id,clicked_block.x,clicked_block.y)}else if(op==="remove"){remove_block(clicked_block.id)}else if(op==="invert"){invert_block(clicked_block)}}if(!has_touch()){$myblocks.on("mousemove",".mds-block",function(event){let offset=getOffset(event.originalEvent.pageX,event.originalEvent.pageY);if(offset==null){return false}show_pointer(offset)})}}function select_pixels(offset){change_block_state(offset.x,offset.y);return true}function load_order(){if(MDS_OBJECT.blocks.length===0){return}for(let i=0;i<MDS_OBJECT.blocks.length;i++){add_block(parseInt(MDS_OBJECT.blocks[i].block_id,10),parseInt(MDS_OBJECT.blocks[i].x,10)*scaled_width,parseInt(MDS_OBJECT.blocks[i].y,10)*scaled_height)}if(pixel_form!==null){pixel_form.addEventListener("submit",formSubmit)}}function getObjCoords(obj){var rect=obj.getBoundingClientRect();var scrollLeft=window.pageXOffset||document.documentElement.scrollLeft;var scrollTop=window.pageYOffset||document.documentElement.scrollTop;return{x:rect.left+scrollLeft,y:rect.top+scrollTop}}function getOffset(x,y,touch){if(grid==null){return null}let pos=getObjCoords(grid);let size=get_pointer_size();let offset={};let scrollLeft=0;let scrollTop=0;if(touch){scrollLeft=document.documentElement.scrollLeft;scrollTop=document.documentElement.scrollTop}offset.x=x-pos.x+scrollLeft;offset.y=y-pos.y+scrollTop;offset.x=Math.floor(offset.x/scaled_width/orig.BLK_WIDTH)*orig.BLK_WIDTH;offset.y=Math.floor(offset.y/scaled_height/orig.BLK_HEIGHT)*orig.BLK_HEIGHT;offset.x=Math.max(Math.min(offset.x,GRD_WIDTH-size.width/scaled_width),0);offset.y=Math.max(Math.min(offset.y,GRD_HEIGHT-size.height/scaled_height),0);offset.x=offset.x*scaled_width;offset.y=offset.y*scaled_height;return offset}function get_pointer_size(){let size={};const $mds_selection_size_slider=jQuery("#mds-selection-size-slider");const $mds_selection_size_value=jQuery("#mds-selection-size-value");const $mds_total_blocks_value=jQuery("#mds-total-blocks-value");if($mds_selection_size_slider.attr("type")==="hidden"){let selectedSize=parseInt($mds_selection_size_value.val(),10);const maxBlockSize=Math.max(GRD_WIDTH,GRD_HEIGHT);let blocksLeft=G_MAX_BLOCKS-selectedBlocks.length;let sqrtBlocksLeft=Math.floor(Math.sqrt(blocksLeft));if(selectedSize===0){selectedSize=Math.floor(Math.sqrt(G_MAX_BLOCKS))}let cappedSize=Math.min(selectedSize,maxBlockSize,sqrtBlocksLeft);if(blocksLeft===0){cappedSize=1}while((cappedSize+1)*(cappedSize+1)<=blocksLeft){cappedSize++;blocksLeft=blocksLeft-cappedSize*cappedSize}size.width=BLK_WIDTH*cappedSize;size.height=BLK_HEIGHT*cappedSize;$mds_selection_size_slider.val(cappedSize);$mds_selection_size_value.val(cappedSize);$mds_total_blocks_value.val(cappedSize*cappedSize)}else{const selectedSize=parseInt(jQuery("#mds-selection-size-value").val(),10);const maxBlockSize=Math.max(GRD_WIDTH,GRD_HEIGHT);const cappedSize=Math.min(selectedSize,maxBlockSize);size.width=BLK_WIDTH*cappedSize;size.height=BLK_HEIGHT*cappedSize}return size}function update_pointer_size(){let size=get_pointer_size();pointer.style.width=size.width+"px";pointer.style.height=size.height+"px"}function show_pointer(offset){pointer.style.visibility="visible";pointer.style.display="block";pointer.style.top=offset.y+"px";pointer.style.left=offset.x+"px";pointer.map_x=offset.x;pointer.map_y=offset.y;update_pointer_size();return true}function formSubmit(event){event.preventDefault();event.stopPropagation();if($myblocks.html().trim()===""){messageout(MDS_OBJECT.no_blocks_selected);return false}else{if(submitting===false){submit_button1.disabled=true;let submit1_lang=submit_button1.value;submit_button1.value=MDS_OBJECT.WAIT;let waitInterval=setInterval(function(){if(ajax_queue.length===0){clearInterval(waitInterval);if(pixel_form!==null){mds_update_package(jQuery(pixel_form));pixel_form.submit()}submit_button1.disabled=false;submit_button1.value=submit1_lang;submitting=false}},1e3)}}}function reset_pixels(){ajax_queue=[];add_ajax_loader(".mds-pixel-wrapper");jQuery.ajax({type:"POST",url:MDS_OBJECT.UPDATE_ORDER,data:{reset:true,action:"reset",_wpnonce:MDS_OBJECT.NONCE},success:function(data){if(data.success===true&&data.data&&data.data.type==="removed"){$myblocks.children().each(function(){remove_block(jQuery(this).data("blockid"))})}},complete:function(){remove_ajax_loader()}})}function rescale_grid(){if(grid==null){return}let origWidth=parseInt(jQuery(grid).attr("data-original-width"),10)||orig.GRD_WIDTH;let origHeight=parseInt(jQuery(grid).attr("data-original-height"),10)||orig.GRD_HEIGHT;grid_width=jQuery(grid).width();grid_height=jQuery(grid).height();scaled_width=grid_width/origWidth;scaled_height=grid_height/origHeight;BLK_WIDTH=orig.BLK_WIDTH*scaled_width;BLK_HEIGHT=orig.BLK_HEIGHT*scaled_height;gridOffsetLeft=grid.offsetLeft;gridOffsetTop=grid.offsetTop;jQuery(pointer).rescaleStyles();let currentBlocks=selectedBlocks.slice();$myblocks.empty();if(currentBlocks.length>0){currentBlocks.forEach(function(blockId){add_block(blockId)})}if(window.scaleImageMap&&typeof window.scaleImageMap==="function"){window.scaleImageMap()}}function center_block(coords){let size=get_pointer_size();coords.x-=size.width/2-BLK_WIDTH/2;coords.y-=size.height/2-BLK_HEIGHT/2;return coords}function handle_click_events(){let clickValid=true;let startX,startY;const threshold=Math.min(BLK_WIDTH,BLK_HEIGHT)/2;jQuery(pixel_container).on("mousedown",function(event){clickValid=true;startX=event.originalEvent.pageX;startY=event.originalEvent.pageY});jQuery(pixel_container).on("mousemove",function(event){if(clickValid){let currentX=event.originalEvent.pageX;let currentY=event.originalEvent.pageY;if(Math.abs(startX-currentX)>threshold||Math.abs(startY-currentY)>threshold){clickValid=false}}let coords=center_block({x:event.originalEvent.pageX,y:event.originalEvent.pageY});let offset=getOffset(coords.x,coords.y);if(offset==null){return false}show_pointer(offset)});jQuery(pixel_container).on("click",function(event){event.preventDefault();if(clickValid){let coords=center_block({x:event.originalEvent.pageX,y:event.originalEvent.pageY});let offset=getOffset(coords.x,coords.y);if(offset==null){return false}show_pointer(offset);select_pixels(offset)}clickValid=true;return false})}function handle_touch_events(){if(window.mds_zoom===undefined){window.mds_zoom=1;window.mds_pan_x=0;window.mds_pan_y=0}let options={supportedGestures:[Tap,Pinch,Pan]};let pointerListener=new PointerListener(pixel_container,options);pixel_container.addEventListener("tap",function(event){let offset=getOffset(event.detail.live.center.x,event.detail.live.center.y,true);if(offset==null){return true}show_pointer(offset);select_pixels(offset)});pixel_container.addEventListener("pinch",function(event){event.preventDefault&&event.preventDefault();const newScale=event.detail.live.scale;if(!newScale||newScale<=0)return;applyZoom(newScale,event.detail.live.center.x,event.detail.live.center.y)});pixel_container.addEventListener("pan",function(event){if(window.mds_zoom<=1)return;window.mds_pan_x+=event.detail.live.deltaX;window.mds_pan_y+=event.detail.live.deltaY;applyTransform()})}function IsNumeric(str){let ValidChars="0123456789";let IsNumber=true;let Char;for(let i=0;i<str.length&&IsNumber===true;i++){Char=str.charAt(i);if(ValidChars.indexOf(Char)===-1){IsNumber=false}}return IsNumber}function get_block_position(block_id){const grid_width_in_blocks=Math.floor(orig.GRD_WIDTH/orig.BLK_WIDTH);const x_blocks=block_id%grid_width_in_blocks;const y_blocks=Math.floor(block_id/grid_width_in_blocks);return{x:x_blocks,y:y_blocks}}function get_clicked_block(OffsetX,OffsetY){OffsetX/=scaled_width;OffsetY/=scaled_height;let X=OffsetX/orig.BLK_WIDTH;let Y=OffsetY/orig.BLK_HEIGHT*(orig.GRD_WIDTH/orig.BLK_WIDTH);return Math.round(X+Y)}function change_block_state(OffsetX,OffsetY){let clicked_block=get_clicked_block(OffsetX,OffsetY);let erasing=jQuery("#erase").is(":checked");let selection_size=parseInt(pixel_form.elements.selection_size.value,10);let data={erasing:erasing,clicked_block:clicked_block,OffsetX:OffsetX,OffsetY:OffsetY,url:(()=>{const url=new URL(MDS_OBJECT.UPDATE_ORDER,window.location.origin);url.searchParams.set("selection_size",selection_size);url.searchParams.set("user_id",MDS_OBJECT.user_id);url.searchParams.set("block_id",clicked_block.toString());url.searchParams.set("BID",MDS_OBJECT.BID);url.searchParams.set("t",MDS_OBJECT.time);url.searchParams.set("erase",erasing);url.searchParams.set("_wpnonce",MDS_OBJECT.NONCE);return url.toString()})()};if(is_block_selected(clicked_block)){if(erasing){data.action="remove";do_blocks(clicked_block,OffsetX,OffsetY,"remove")}else{if(MDS_OBJECT.INVERT_PIXELS==="YES"){data.action="invert";do_blocks(clicked_block,OffsetX,OffsetY,"invert")}else{data.action="add";do_blocks(clicked_block,OffsetX,OffsetY,"add")}}}else{if(erasing){data.action="remove";do_blocks(clicked_block,OffsetX,OffsetY,"remove")}else{if(MDS_OBJECT.INVERT_PIXELS==="YES"){data.action="invert";do_blocks(clicked_block,OffsetX,OffsetY,"invert")}else{data.action="add";do_blocks(clicked_block,OffsetX,OffsetY,"add")}}}ajax_queue.push(data)}function implode(myArray){let str="";let comma="";for(let i in myArray){if(myArray.hasOwnProperty(i)){str=str+comma+myArray[i]}comma=","}return str}let resizeTimer;window.addEventListener("resize",function(){clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){rescale_grid()},100)});jQuery(document).on("ajaxComplete",function(event,xhr,settings){const params=new URLSearchParams(settings.data);const type=params.get("type");if(type!=="order"){return}if(first_load){first_load=false}else{return}grid=document.getElementById("pixelimg");let $grid=jQuery(grid);$myblocks=jQuery("#blocks");total_cost=document.getElementById("total_cost");submit_button1=document.getElementById("submit_button1");pointer=document.getElementById("block_pointer");pixel_container=document.getElementById("pixel_container");pixel_form=document.getElementById("pixel_form");rescale_grid();if($grid.length===0){remove_ajax_loader()}if(has_touch()){handle_touch_events()}else{handle_click_events()}jQuery(grid).oncontextmenu=e=>{e.preventDefault()};let ajax_queue_interval=setInterval(function(){if(ajax_queue.length===0||ajaxing){return}ajaxing=true;add_ajax_loader(".mds-pixel-wrapper");let data=ajax_queue.shift();jQuery.ajax({type:"POST",url:data.url,data:{_wpnonce:MDS_OBJECT.NONCE,erasing:data.erasing},success:function(response){if(response.success!==true||response.data&&response.data.error==="true"){switch(data.action){case"invert":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"invert");break;case"remove":if(!data.erasing){do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"add")}break;case"add":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"remove");break}messageout(response.data.data.value)}if(response.data&&response.data.type==="order_id"){if(pixel_form!==null){pixel_form.order_id.value=parseInt(response.data.data.value,10)}}},fail:function(){switch(data.action){case"invert":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"invert");break;case"remove":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"add");break;case"add":do_blocks(data.clicked_block,data.OffsetX,data.OffsetY,"remove");break}if(jQuery.isPlainObject(data)){messageout("Error: "+JSON.stringify(data))}else{messageout("Error: "+data)}},complete:function(){ajaxing=false;remove_ajax_loader()}})},100);document.querySelectorAll('.mds-select-input input[type="checkbox"]').forEach(function(radio){radio.addEventListener("hover",function(){this.style.cursor="pointer"});radio.addEventListener("change",function(){const label=this.nextElementSibling;const iconErase=label.querySelector(".icon-erase");const iconSelect=label.querySelector(".icon-select");if(iconErase&&iconSelect){if(this.checked){iconErase.setAttribute("stroke","#FFFFFF");iconSelect.setAttribute("stroke","none")}else{iconErase.setAttribute("stroke","none");iconSelect.setAttribute("stroke","#008000")}}})});const $pixelimg=jQuery("#pixelimg");$pixelimg.one("load",function(){rescale_grid();load_order();jQuery(".ajax-loader").remove()}).each(function(){if(this.complete){jQuery(this).trigger("load")}});$pixelimg.on("loadstart",function(){add_ajax_loader(".mds-pixel-wrapper")});function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");let $container=jQuery(container);if($container.length>0){$container.append($ajax_loader);$ajax_loader.css("z-index","10000").css("top",$container.position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}}add_ajax_loader(".mds-pixel-wrapper");const $mds_selection_size_slider=jQuery("#mds-selection-size-slider");const $mds_selection_size_value=jQuery("#mds-selection-size-value");const $mds_total_blocks_value=jQuery("#mds-total-blocks-value");if($mds_selection_size_slider.length>0){$mds_selection_size_slider.on("input",function(){const blockSize=parseInt(jQuery(this).val());const adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_value.val(adjustedBlockSize);$mds_total_blocks_value.val(Math.pow(adjustedBlockSize,2));update_pointer_size()});$mds_selection_size_value.on("input",function(){const blockSize=parseInt(jQuery(this).val());const adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_slider.val(adjustedBlockSize);$mds_total_blocks_value.val(Math.pow(adjustedBlockSize,2));update_pointer_size()});let previousTotalBlocks=parseInt($mds_total_blocks_value.val());let updateTimer;$mds_total_blocks_value.on("input",function(){let totalBlocks=parseInt(jQuery(this).val());const isIncreasing=totalBlocks>previousTotalBlocks;let blockSize;if(isIncreasing){blockSize=Math.ceil(Math.sqrt(totalBlocks))}else{blockSize=Math.floor(Math.sqrt(totalBlocks))}const adjustedBlockSize=Math.min(blockSize,Math.min(GRD_WIDTH,GRD_HEIGHT));$mds_selection_size_slider.val(adjustedBlockSize);$mds_selection_size_value.val(adjustedBlockSize);clearTimeout(updateTimer);updateTimer=setTimeout(()=>{totalBlocks=Math.pow(adjustedBlockSize,2);$mds_total_blocks_value.val(totalBlocks);previousTotalBlocks=totalBlocks;update_pointer_size()},1e3)})}jQuery(submit_button1).on("click",function(e){e.preventDefault();e.stopPropagation();formSubmit(e);return false});jQuery("#reset_button").on("click",function(e){e.preventDefault();e.stopPropagation();reset_pixels();return false});if(jQuery("#reset_zoom_button").length===0){const resetZoomButton=jQuery("<button>",{id:"reset_zoom_button",class:"mds-reset-zoom",text:"Reset Zoom",css:{position:"absolute",right:"10px",top:"10px","z-index":"1000",padding:"5px 10px",background:"rgba(0,0,0,0.5)",color:"white",border:"none","border-radius":"4px",display:"none",cursor:"pointer"}});jQuery(".mds-pixel-wrapper").append(resetZoomButton);resetZoomButton.on("click",function(){resetZoom()})}});function applyZoom(scaleChange,centerX,centerY){const maxZoom=3;const oldZoom=window.mds_zoom||1;const newZoom=Math.min(maxZoom,oldZoom*scaleChange);if(newZoom<1){resetZoom();return}window.mds_zoom=newZoom;if(newZoom>1){jQuery("#reset_zoom_button").show()}else{jQuery("#reset_zoom_button").hide()}applyTransform()}function applyTransform(){const wrapper=jQuery(".mds-pixel-wrapper");if(!wrapper.length)return;const transform=`scale(${window.mds_zoom}) translate(${window.mds_pan_x/window.mds_zoom}px, ${window.mds_pan_y/window.mds_zoom}px)`;wrapper.css({transform:transform,"transform-origin":"center center",transition:"transform 0.1s"});rescale_grid()}function resetZoom(){window.mds_zoom=1;window.mds_pan_x=0;window.mds_pan_y=0;const wrapper=jQuery(".mds-pixel-wrapper");wrapper.css({transform:"none",transition:"transform 0.3s"});jQuery("#reset_zoom_button").hide();rescale_grid()}