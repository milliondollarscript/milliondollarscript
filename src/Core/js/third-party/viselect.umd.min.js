((e,t)=>{"object"==typeof exports&&typeof module<"u"?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=typeof globalThis<"u"?globalThis:e||self).SelectionArea=t()})(this,function(){let o=(e,t="px")=>"number"==typeof e?e+t:e,a=({style:e},t,i)=>{if("object"==typeof t)for(var[s,l]of Object.entries(t))void 0!==l&&(e[s]=o(l));else void 0!==i&&(e[t]=o(i))},p=(e=0,t=0,i=0,s=0)=>{let l={x:e,y:t,width:i,height:s,top:t,left:e,right:e+i,bottom:t+s};return{...l,toJSON:()=>JSON.stringify(l)}},m=(e,t,i="touch")=>{switch(i){case"center":var s=t.left+t.width/2,l=t.top+t.height/2;return s>=e.left&&s<=e.right&&l>=e.top&&l<=e.bottom;case"cover":return t.left>=e.left&&t.top>=e.top&&t.right<=e.right&&t.bottom<=e.bottom;case"touch":return e.right>=t.left&&e.left<=t.right&&e.bottom>=t.top&&e.top<=t.bottom}},n=e=>Array.isArray(e)?e:[e],e=r=>(e,t,i,s={})=>{(e instanceof HTMLCollection||e instanceof NodeList)&&(e=Array.from(e)),t=n(t);for(var l of e=n(e))if(l)for(var o of t)l[r](o,i,{capture:!1,...s})},v=e("addEventListener"),h=e("removeEventListener"),g=e=>{var{clientX:t,clientY:e,target:i}=(null==(t=e.touches)?void 0:t[0])??e;return{x:t,y:e,target:i}},f=(e,t=document)=>n(e).map(e=>"string"==typeof e?Array.from(t.querySelectorAll(e)):e instanceof Element?e:null).flat().filter(Boolean),{abs:y,max:b,min:S,ceil:c}=Math,r=(e=[])=>({stored:e,selected:[],touched:[],changed:{added:[],removed:[]}}),t=class extends class{constructor(){this._listeners=new Map,this.on=this.addEventListener,this.off=this.removeEventListener,this.emit=this.dispatchEvent}addEventListener(e,t){var i=this._listeners.get(e)??new Set;return this._listeners.set(e,i),i.add(t),this}removeEventListener(e,t){return null!=(e=this._listeners.get(e))&&e.delete(t),this}dispatchEvent(e,...t){let i=!0;for(var s of this._listeners.get(e)??[])i=!1!==s(...t)&&i;return i}unbindAllListeners(){this._listeners.clear()}}{constructor(e){var t;super(),this._selection=r(),this._targetBoundaryScrolled=!0,this._selectables=[],this._areaLocation={y1:0,x2:0,y2:0,x1:0},this._areaRect=p(),this._singleClick=!0,this._scrollAvailable=!0,this._scrollingActive=!1,this._scrollSpeed={x:0,y:0},this._scrollDelta={x:0,y:0},this._lastMousePosition={x:0,y:0},this.enable=this._toggleStartEvents,this.disable=this._toggleStartEvents.bind(this,!1),this._options={selectionAreaClass:"selection-area",selectionContainerClass:void 0,selectables:[],document:window.document,startAreas:["html"],boundaries:["html"],container:"body",...e,behaviour:{overlap:"invert",intersect:"touch",triggers:[0],...e.behaviour,startThreshold:null!=(i=e.behaviour)&&i.startThreshold?"number"==typeof e.behaviour.startThreshold?e.behaviour.startThreshold:{x:10,y:10,...e.behaviour.startThreshold}:{x:10,y:10},scrolling:{speedDivider:10,manualSpeed:750,...null==(i=e.behaviour)?void 0:i.scrolling,startScrollMargins:{x:0,y:0,...null==(i=null==(i=e.behaviour)?void 0:i.scrolling)?void 0:i.startScrollMargins}}},features:{range:!0,touch:!0,deselectOnBlur:!1,...e.features,singleTap:{allow:!0,intersect:"native",...null==(i=e.features)?void 0:i.singleTap}}};for(t of Object.getOwnPropertyNames(Object.getPrototypeOf(this)))"function"==typeof this[t]&&(this[t]=this[t].bind(this));var{document:e,selectionAreaClass:i,selectionContainerClass:s}=this._options;this._area=e.createElement("div"),this._clippingElement=e.createElement("div"),this._clippingElement.appendChild(this._area),this._area.classList.add(i),s&&this._clippingElement.classList.add(s),a(this._area,{willChange:"top, left, bottom, right, width, height",top:0,left:0,position:"fixed"}),a(this._clippingElement,{overflow:"hidden",position:"fixed",transform:"translate3d(0, 0, 0)",pointerEvents:"none",zIndex:"1"}),this._frame=(t=>{let i,s=-1,l=!1;return{next:(...e)=>{i=e,l||(l=!0,s=requestAnimationFrame(()=>{t(...i),l=!1}))},cancel:()=>{cancelAnimationFrame(s),l=!1}}})(e=>{this._recalculateSelectionAreaRect(),this._updateElementSelection(),this._emitEvent("move",e),this._redrawSelectionArea()}),this.enable()}_toggleStartEvents(e=!0){var{document:t,features:i}=this._options,e=e?v:h;e(t,"mousedown",this._onTapStart),i.touch&&e(t,"touchstart",this._onTapStart,{passive:!1})}_onTapStart(i,s=!1){let{x:l,y:o,target:e}=g(i),{document:r,startAreas:n,boundaries:a,features:h,behaviour:t}=this._options,c=e.getBoundingClientRect();if(!(i instanceof MouseEvent)||(d=i,t.triggers.some(e=>"number"==typeof e?d.button===e:"object"==typeof e&&e.button===d.button&&e.modifiers.every(e=>{switch(e){case"alt":return d.altKey;case"ctrl":return d.ctrlKey||d.metaKey;case"shift":return d.shiftKey}})))){var d,_=f(n,r),u=f(a,r);this._targetElement=u.find(e=>m(e.getBoundingClientRect(),c));let t=i.composedPath(),e=_.find(e=>t.includes(e));this._targetBoundary=u.find(e=>t.includes(e)),this._targetElement&&e&&this._targetBoundary&&(s||!1!==this._emitEvent("beforestart",i))&&(this._areaLocation={x1:l,y1:o,x2:0,y2:0},_=r.scrollingElement??r.body,this._scrollDelta={x:_.scrollLeft,y:_.scrollTop},this._singleClick=!0,this.clearSelection(!1,!0),v(r,["touchmove","mousemove"],this._delayedTapMove,{passive:!1}),v(r,["mouseup","touchcancel","touchend"],this._onTapStop),v(r,"scroll",this._onScroll),h.deselectOnBlur)&&(this._targetBoundaryScrolled=!1,v(this._targetBoundary,"scroll",this._onStartAreaScroll))}}_onSingleTap(e){var{singleTap:{intersect:t},range:i}=this._options.features,s=g(e);let r;if("native"===t)r=s.target;else if("touch"===t){this.resolveSelectables();let{x:l,y:o}=s;r=this._selectables.find(e=>{var{right:e,left:t,top:i,bottom:s}=e.getBoundingClientRect();return l<e&&l>t&&o<s&&o>i})}if(r){for(this.resolveSelectables();!this._selectables.includes(r);){if(!r.parentElement)return void(this._targetBoundaryScrolled||this.clearSelection());r=r.parentElement}t=this._selection.stored;if(this._emitEvent("start",e),e.shiftKey&&i&&this._latestElement){let e=this._latestElement,[t,i]=4&e.compareDocumentPosition(r)?[r,e]:[e,r],s=[...this._selectables.filter(e=>4&e.compareDocumentPosition(t)&&2&e.compareDocumentPosition(i)),t,i];this.select(s),this._latestElement=e}else t.includes(r)&&(1===t.length||e.ctrlKey||t.every(e=>this._selection.stored.includes(e)))?this.deselect(r):(this.select(r),this._latestElement=r)}}_delayedTapMove(e){var{container:t,document:i,behaviour:{startThreshold:s}}=this._options,{x1:l,y1:o}=this._areaLocation,{x:r,y:n}=g(e);if("number"==typeof s&&y(r+n-(l+o))>=s||"object"==typeof s&&y(r-l)>=s.x||y(n-o)>=s.y){if(h(i,["mousemove","touchmove"],this._delayedTapMove,{passive:!1}),!1===this._emitEvent("beforedrag",e))return void h(i,["mouseup","touchcancel","touchend"],this._onTapStop);v(i,["mousemove","touchmove"],this._onTapMove,{passive:!1}),a(this._area,"display","block"),f(t,i)[0].appendChild(this._clippingElement),this.resolveSelectables(),this._singleClick=!1,this._targetRect=this._targetElement.getBoundingClientRect(),this._scrollAvailable=this._targetElement.scrollHeight!==this._targetElement.clientHeight||this._targetElement.scrollWidth!==this._targetElement.clientWidth,this._scrollAvailable&&(v(this._targetElement,"wheel",this._wheelScroll,{passive:!1}),v(this._options.document,"keydown",this._keyboardScroll,{passive:!1}),this._selectables=this._selectables.filter(e=>this._targetElement.contains(e))),this._setupSelectionArea(),this._emitEvent("start",e),this._onTapMove(e)}this._handleMoveEvent(e)}_setupSelectionArea(){var{_clippingElement:e,_targetElement:t,_area:i}=this,t=this._targetRect=t.getBoundingClientRect();this._scrollAvailable?(a(e,{top:t.top,left:t.left,width:t.width,height:t.height}),a(i,{marginTop:-t.top,marginLeft:-t.left})):(a(e,{top:0,left:0,width:"100%",height:"100%"}),a(i,{marginTop:0,marginLeft:0}))}_onTapMove(s){let{_scrollSpeed:l,_areaLocation:o,_options:e,_frame:r}=this,n=e.behaviour.scrolling.speedDivider,a=this._targetElement,{x:t,y:i}=g(s);if(o.x2=t,o.y2=i,this._lastMousePosition.x=t,this._lastMousePosition.y=i,this._scrollAvailable&&!this._scrollingActive&&(l.y||l.x)){this._scrollingActive=!0;let i=()=>{var e,t;l.x||l.y?({scrollTop:e,scrollLeft:t}=a,l.y&&(a.scrollTop+=c(l.y/n),o.y1-=a.scrollTop-e),l.x&&(a.scrollLeft+=c(l.x/n),o.x1-=a.scrollLeft-t),r.next(s),requestAnimationFrame(i)):this._scrollingActive=!1};requestAnimationFrame(i)}else r.next(s);this._handleMoveEvent(s)}_handleMoveEvent(e){var t=this._options.features;(t.touch&&matchMedia("(hover: none), (pointer: coarse)").matches||this._scrollAvailable&&"safari"in window)&&e.preventDefault()}_onScroll(){var{_scrollDelta:e,_options:{document:t}}=this,{scrollTop:t,scrollLeft:i}=t.scrollingElement??t.body;this._areaLocation.x1+=e.x-i,this._areaLocation.y1+=e.y-t,e.x=i,e.y=t,this._setupSelectionArea(),this._frame.next(null)}_onStartAreaScroll(){this._targetBoundaryScrolled=!0,h(this._targetElement,"scroll",this._onStartAreaScroll)}_wheelScroll(e){var t=this._options.behaviour.scrolling.manualSpeed,i=e.deltaY?0<e.deltaY?1:-1:0,s=e.deltaX?0<e.deltaX?1:-1:0;this._scrollSpeed.y+=i*t,this._scrollSpeed.x+=s*t,this._onTapMove(e),e.preventDefault()}_keyboardScroll(e){var t=this._options.behaviour.scrolling.manualSpeed,i="ArrowLeft"===e.key?-1:"ArrowRight"===e.key?1:0,s="ArrowUp"===e.key?-1:"ArrowDown"===e.key?1:0;this._scrollSpeed.x+=Math.sign(i)*t,this._scrollSpeed.y+=Math.sign(s)*t,e.preventDefault(),this._onTapMove({clientX:this._lastMousePosition.x,clientY:this._lastMousePosition.y,preventDefault:()=>{}})}_recalculateSelectionAreaRect(){var{_scrollSpeed:e,_areaLocation:t,_targetElement:i,_options:s}=this,{scrollTop:i,scrollHeight:l,clientHeight:o,scrollLeft:r,scrollWidth:n,clientWidth:a}=i,h=this._targetRect,{x1:c,y1:d}=t;let{x2:_,y2:u}=t;var{startScrollMargins:t}=s.behaviour.scrolling,s=(_<h.left+t.x?(e.x=r?-y(h.left-_+t.x):0,_=_<h.left?h.left:_):_>h.right-t.x?(e.x=n-r-a?y(h.left+h.width-_-t.x):0,_=_>h.right?h.right:_):e.x=0,u<h.top+t.y?(e.y=i?-y(h.top-u+t.y):0,u=u<h.top?h.top:u):u>h.bottom-t.y?(e.y=l-i-o?y(h.top+h.height-u-t.y):0,u=u>h.bottom?h.bottom:u):e.y=0,S(c,_)),n=S(d,u),r=b(c,_),a=b(d,u);this._areaRect=p(s,n,r-s,a-n)}_redrawSelectionArea(){var{x:e,y:t,width:i,height:s}=this._areaRect,l=this._area.style;l.left=e+"px",l.top=t+"px",l.width=i+"px",l.height=s+"px"}_onTapStop(e,t){var{document:i,features:s}=this._options,l=this._singleClick;h(this._targetElement,"scroll",this._onStartAreaScroll),h(i,["mousemove","touchmove"],this._delayedTapMove),h(i,["touchmove","mousemove"],this._onTapMove),h(i,["mouseup","touchcancel","touchend"],this._onTapStop),h(i,"scroll",this._onScroll),this._keepSelection(),e&&l&&s.singleTap.allow?this._onSingleTap(e):l||t||(this._updateElementSelection(),this._emitEvent("stop",e)),this._scrollSpeed.x=0,this._scrollSpeed.y=0,h(this._targetElement,"wheel",this._wheelScroll,{passive:!0}),h(this._options.document,"keydown",this._keyboardScroll,{passive:!0}),this._clippingElement.remove(),null!=(i=this._frame)&&i.cancel(),a(this._area,"display","none")}_updateElementSelection(){let{_selectables:t,_options:e,_selection:i,_areaRect:s}=this,{stored:l,selected:o,touched:r}=i,{intersect:n,overlap:a}=e.behaviour,h="invert"===a,c=[],d=[],_=[];for(let e=0;e<t.length;e++){var u=t[e];if(m(s,u.getBoundingClientRect(),n)){if(o.includes(u))l.includes(u)&&!r.includes(u)&&r.push(u);else{if(h&&l.includes(u)){_.push(u);continue}d.push(u)}c.push(u)}}h&&d.push(...l.filter(e=>!o.includes(e)));var p="keep"===a;for(let e=0;e<o.length;e++){var v=o[e];c.includes(v)||p&&l.includes(v)||_.push(v)}i.selected=c,i.changed={added:d,removed:_},this._latestElement=void 0}_emitEvent(e,t){return this.emit(e,{event:t,store:this._selection,selection:this})}_keepSelection(){let{_options:e,_selection:t}=this,{selected:i,changed:s,touched:l,stored:o}=t,r=i.filter(e=>!o.includes(e));switch(e.behaviour.overlap){case"drop":t.stored=[...r,...o.filter(e=>!l.includes(e))];break;case"invert":t.stored=[...r,...o.filter(e=>!s.removed.includes(e))];break;case"keep":t.stored=[...o,...i.filter(e=>!o.includes(e))]}}trigger(e,t=!0){this._onTapStart(e,t)}resolveSelectables(){this._selectables=f(this._options.selectables,this._options.document)}clearSelection(e=!0,t=!1){var{selected:i,stored:s,changed:l}=this._selection;l.added=[],l.removed.push(...i,...e?s:[]),t||(this._emitEvent("move",null),this._emitEvent("stop",null)),this._selection=r(e?[]:s)}getSelection(){return this._selection.stored}getSelectionArea(){return this._area}getSelectables(){return this._selectables}setAreaLocation(e){Object.assign(this._areaLocation,e),this._redrawSelectionArea()}getAreaLocation(){return this._areaLocation}cancel(e=!1){this._onTapStop(null,!e)}destroy(){this.cancel(),this.disable(),this._clippingElement.remove(),super.unbindAllListeners()}select(e,t=!1){let{changed:i,selected:s,stored:l}=this._selection,o=f(e,this._options.document).filter(e=>!s.includes(e)&&!l.includes(e));return l.push(...o),s.push(...o),i.added.push(...o),i.removed=[],this._latestElement=void 0,t||(this._emitEvent("move",null),this._emitEvent("stop",null)),o}deselect(e,t=!1){let{selected:i,stored:s,changed:l}=this._selection,o=f(e,this._options.document).filter(e=>i.includes(e)||s.includes(e));this._selection.stored=s.filter(e=>!o.includes(e)),this._selection.selected=i.filter(e=>!o.includes(e)),this._selection.changed.added=[],this._selection.changed.removed.push(...o.filter(e=>!l.removed.includes(e))),this._latestElement=void 0,t||(this._emitEvent("move",null),this._emitEvent("stop",null))}};return t.version="3.9.0",t});