let first_load=true;jQuery(document).on("ajaxComplete",function(event,xhr,settings){const params=new URLSearchParams(settings.data);const type=params.get("type");if(type!=="order"){return}if(first_load){first_load=false}else{return}window.$block_pointer=jQuery("#block_pointer");window.$pixelimg=jQuery("#pixelimg");if(window.$block_pointer.length===0||window.$pixelimg.length===0){return}if(window.MDS_OBJECT&&window.MDS_OBJECT.grid_data){const gridData=window.MDS_OBJECT.grid_data;window.$block_pointer.attr("data-original-width",gridData.pointer_width);window.$block_pointer.attr("data-original-height",gridData.pointer_height);window.$block_pointer.css({width:gridData.pointer_width+"px",height:gridData.pointer_height+"px"});if(gridData.debug_mode){console.log("Grid dimensions:",{width_px:gridData.orig_width_px,height_px:gridData.orig_height_px,width_blocks:gridData.grid_width_blocks,height_blocks:gridData.grid_height_blocks,block_width:gridData.block_width,block_height:gridData.block_height})}}let trip_count=0;const block_str=MDS_OBJECT.block_str;let low_x=parseInt(MDS_OBJECT.low_x,10);let low_y=parseInt(MDS_OBJECT.low_y,10);let is_moving=MDS_OBJECT.is_moving;window.blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10);window.blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10);window.grid_width=parseInt(MDS_OBJECT.grid_width,10)*window.blk_width;window.grid_height=parseInt(MDS_OBJECT.grid_height,10)*window.blk_height;window.pointer_width=window.blk_width;window.pointer_height=window.blk_height;const user_id=parseInt(MDS_OBJECT.user_id,10);const BID=parseInt(MDS_OBJECT.BID,10);let submit1=document.getElementById("submit_button1");let submit2=document.getElementById("submit_button2");document.form1.selected_pixels.value=block_str;function check_selection(){const pointerOffset=window.$block_pointer.position();const blockId=get_clicked_block();const gridData=MDS_OBJECT.grid_data||{};const gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks);const currentImgWidth=window.$pixelimg.width();const originalImgWidth=parseInt(gridData.orig_width_px||gridWidthBlocks*gridData.block_width);const scaleFactor=originalImgWidth/currentImgWidth;const scaledX=Math.round(pointerOffset.left*scaleFactor);const scaledY=Math.round(pointerOffset.top*scaleFactor);const blockY=Math.floor(blockId/gridWidthBlocks);const blockX=blockId%gridWidthBlocks;let ajax_data={_wpnonce:MDS_OBJECT.NONCE,user_id:user_id,map_x:scaledX,map_y:scaledY,block_id:blockId,BID:BID,t:MDS_OBJECT.time};jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:ajax_data,dataType:"json"}).done(function(response){if(response){if(response.type==="unavailable"||response.type==="no_orders"||response.type==="no_permission"){alert(response.data.value);is_moving=true}else if(response.type==="available"){console.log("Blocks are available for selection")}}}).fail(function(jqXHR,textStatus,errorThrown){console.error("Selection check failed:",textStatus,errorThrown)}).always(function(){submit1.disabled=false;submit2.disabled=false;window.$block_pointer.css("cursor","pointer");window.$pixelimg.css("cursor","pointer")});if(trip_count!==0){submit1.disabled=true;submit2.disabled=true;window.$block_pointer.css("cursor","wait");window.$pixelimg.css("cursor","wait")}}function make_selection(event){event.stopPropagation();event.preventDefault();window.reserving=true;window.$block_pointer.css("cursor","wait");window.$pixelimg.css("cursor","wait");document.body.style.cursor="wait";submit1.disabled=true;submit2.disabled=true;submit1.value=MDS_OBJECT.WAIT;submit2.value=MDS_OBJECT.WAIT;submit1.style.cursor="wait";submit2.style.cursor="wait";const pointerOffset=window.$block_pointer.position();const gridData=MDS_OBJECT.grid_data||{};const gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks);const currentImgWidth=window.$pixelimg.width();const originalImgWidth=parseInt(gridData.orig_width_px||gridWidthBlocks*gridData.block_width);const scaleFactor=originalImgWidth/currentImgWidth;const scaledX=Math.round(pointerOffset.left*scaleFactor);const scaledY=Math.round(pointerOffset.top*scaleFactor);let ajax_data={mds_nonce:MDS_OBJECT.mds_nonce,action:"mds_ajax",type:"make-selection",user_id:user_id,map_x:scaledX,map_y:scaledY,block_id:get_clicked_block(),BID:BID,t:MDS_OBJECT.time,package:get_selected_package()};jQuery.ajax({method:"POST",url:MDS_OBJECT.ajaxurl,data:ajax_data,dataType:"json"}).done(function(response){if(response){if(response.type==="unavailable"||response.type==="max_orders"){alert(response.data.value);window.$block_pointer.css("cursor","pointer");window.$pixelimg.css("cursor","pointer");document.body.style.cursor="pointer";submit1.disabled=false;submit2.disabled=false;submit1.value=MDS_OBJECT.WRITE;submit2.value=MDS_OBJECT.WRITE;submit1.style.cursor="pointer";submit2.style.cursor="pointer";window.reserving=false;is_moving=true}else if(response.redirect){window.location.href=response.redirect}else{mds_update_package(jQuery(document.form1));document.form1.submit()}}}).fail(function(jqXHR,textStatus,errorThrown){console.error("Selection request failed:",textStatus,errorThrown);window.$block_pointer.css("cursor","pointer");window.$pixelimg.css("cursor","pointer");document.body.style.cursor="pointer";submit1.disabled=false;submit2.disabled=false;submit1.value=MDS_OBJECT.WRITE;submit2.value=MDS_OBJECT.WRITE;submit1.style.cursor="pointer";submit2.style.cursor="pointer";window.reserving=false})}function getObjCoords(obj){const offset=obj.offset();const x=offset.left;const y=offset.top;return{x:x,y:y}}function scaleImageMap(){const img=jQuery("#pixelimg");if(!img.length)return;const gridData=MDS_OBJECT.grid_data||{};const gridWidthBlocks=parseInt(gridData.grid_width_blocks||MDS_OBJECT.grid_width);const gridHeightBlocks=parseInt(gridData.grid_height_blocks||MDS_OBJECT.grid_height);if(!gridWidthBlocks||!gridHeightBlocks){console.error("Invalid grid dimensions in scaleImageMap");return}const currentWidth=img.width();const currentHeight=img.height();const blockWidth=currentWidth/gridWidthBlocks;const blockHeight=currentHeight/gridHeightBlocks;window.blk_width=blockWidth;window.blk_height=blockHeight;window.grid_width=currentWidth;window.grid_height=currentHeight;window.grid_width_in_blocks=gridWidthBlocks;window.grid_height_in_blocks=gridHeightBlocks;if(window.$block_pointer){const origWidth=parseInt(window.$block_pointer.attr("data-original-width"))||gridData.pointer_width||blockWidth*4;const origHeight=parseInt(window.$block_pointer.attr("data-original-height"))||gridData.pointer_height||blockHeight*4;if(!window.$block_pointer.data("orig-width")){window.$block_pointer.data({"orig-width":origWidth,"orig-height":origHeight})}const origGridWidth=gridData.orig_width_px||gridWidthBlocks*gridData.block_width;const scaleFactor=currentWidth/origGridWidth;const scaledWidth=origWidth*scaleFactor;const scaledHeight=origHeight*scaleFactor;window.$block_pointer.css({width:scaledWidth+"px",height:scaledHeight+"px"});window.pointer_width=scaledWidth;window.pointer_height=scaledHeight;if(window.$block_pointer.data("block_x")!==undefined){const blockX=parseInt(window.$block_pointer.data("block_x"));const blockY=parseInt(window.$block_pointer.data("block_y"));const pointerWidth=window.$block_pointer.outerWidth(true);const pointerHeight=window.$block_pointer.outerHeight(true);let pixelX=blockX*blockWidth;let pixelY=blockY*blockHeight;const maxX=currentWidth-pointerWidth;const maxY=currentHeight-pointerHeight;pixelX=Math.min(Math.max(0,pixelX),maxX);pixelY=Math.min(Math.max(0,pixelY),maxY);window.$block_pointer.css({left:pixelX+"px",top:pixelY+"px"});const safeBlockX=Math.round(pixelX/blockWidth);const safeBlockY=Math.round(pixelY/blockHeight);window.$block_pointer.data({map_x:pixelX,map_y:pixelY,block_x:safeBlockX,block_y:safeBlockY});window.mds_x=pixelX;window.mds_y=pixelY;if(gridData.debug_mode){console.log("ScaleImageMap:",{grid:{blocks:gridWidthBlocks+"x"+gridHeightBlocks,pixels:currentWidth+"x"+currentHeight},block:{width:blockWidth,height:blockHeight},pointer:{original:origWidth+"x"+origHeight,actual:pointerWidth+"x"+pointerHeight},position:{pixel:pixelX+","+pixelY,block:safeBlockX+","+safeBlockY,max:maxX+","+maxY}})}}}}let resizeTimer;window.addEventListener("resize",function(){clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){scaleImageMap()},100)});jQuery(document).ready(function(){const pixelimg=document.getElementById("pixelimg");if(pixelimg){pixelimg.addEventListener("load",function(){scaleImageMap()})}setTimeout(function(){scaleImageMap()},100)});function show_pointer(e){if(!is_moving)return;const img=jQuery("#pixelimg");if(!img.length)return;const gridData=MDS_OBJECT.grid_data||{};const gridWidthBlocks=parseInt(gridData.grid_width_blocks||MDS_OBJECT.grid_width);const gridHeightBlocks=parseInt(gridData.grid_height_blocks||MDS_OBJECT.grid_height);if(!gridWidthBlocks||!gridHeightBlocks){console.error("Invalid grid dimensions");return false}const imgWidth=img.width();const imgHeight=img.height();const imgOffset=img.offset();const pointer=window.$block_pointer;const blockWidth=imgWidth/gridWidthBlocks;const blockHeight=imgHeight/gridHeightBlocks;window.grid_width=imgWidth;window.grid_height=imgHeight;window.grid_width_in_blocks=gridWidthBlocks;window.grid_height_in_blocks=gridHeightBlocks;window.blk_width=blockWidth;window.blk_height=blockHeight;const mouseX=e.pageX-imgOffset.left;const mouseY=e.pageY-imgOffset.top;const boundedMouseX=Math.max(0,Math.min(mouseX,imgWidth-1));const boundedMouseY=Math.max(0,Math.min(mouseY,imgHeight-1));const pointerWidth=pointer.outerWidth(true);const pointerHeight=pointer.outerHeight(true);let blockX=Math.floor(boundedMouseX/blockWidth);let blockY=Math.floor(boundedMouseY/blockHeight);let pixelX=blockX*blockWidth;let pixelY=blockY*blockHeight;const maxX=imgWidth-pointerWidth;const maxY=imgHeight-pointerHeight;pixelX=Math.min(pixelX,maxX);pixelY=Math.min(pixelY,maxY);pointer.css({left:pixelX+"px",top:pixelY+"px"});blockX=Math.round(pixelX/blockWidth);blockY=Math.round(pixelY/blockHeight);pointer.data({map_x:pixelX,map_y:pixelY,block_x:blockX,block_y:blockY});window.mds_x=pixelX;window.mds_y=pixelY;if(gridData.debug_mode){console.log("Pointer:",{grid:{blocks:gridWidthBlocks+"x"+gridHeightBlocks,pixels:imgWidth+"x"+imgHeight},block:{width:blockWidth,height:blockHeight},pointer:{size:pointerWidth+"x"+pointerHeight},position:{pixel:pixelX+","+pixelY,block:blockX+","+blockY,max:maxX+","+maxY}})}return true}function get_clicked_block(){const gridData=MDS_OBJECT.grid_data||{};const gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks);const gridHeightBlocks=parseInt(MDS_OBJECT.grid_height||gridData.grid_height_blocks);if(!gridWidthBlocks||!gridHeightBlocks){console.error("Grid dimensions not available");return-1}if(window.$block_pointer){const pointerOffset=window.$block_pointer.offset();const imgOffset=window.$pixelimg.offset();const pointerWidth=window.$block_pointer.outerWidth();const pointerHeight=window.$block_pointer.outerHeight();const centerX=pointerOffset.left-imgOffset.left+pointerWidth/2;const centerY=pointerOffset.top-imgOffset.top+pointerHeight/2;const imgWidth=window.$pixelimg.width();const imgHeight=window.$pixelimg.height();const blockWidth=imgWidth/gridWidthBlocks;const blockHeight=imgHeight/gridHeightBlocks;const blockX=Math.floor(centerX/blockWidth);const blockY=Math.floor(centerY/blockHeight);if(blockX<0||blockY<0||blockX>=gridWidthBlocks||blockY>=gridHeightBlocks){console.error("Invalid block coordinates:",blockX,blockY);return-1}if(gridData.debug_mode){console.log("Selection:",{pointer:{left:pointerOffset.left,top:pointerOffset.top,width:pointerWidth,height:pointerHeight},center:{x:centerX,y:centerY},block:{x:blockX,y:blockY,width:blockWidth,height:blockHeight},grid:{width:gridWidthBlocks,height:gridHeightBlocks}})}return blockY*gridWidthBlocks+blockX}return-1}function do_block_click(){if(window.reserving){return}trip_count=1;check_selection();low_x=window.$block_pointer.position().left;low_y=window.$block_pointer.position().top;is_moving=!is_moving}function move_image_to_selection(){window.$block_pointer.css({top:low_y+"px",left:low_x+"px",visibility:"visible"});window.$block_pointer.data({map_y:low_y,map_x:low_x})}function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");jQuery(container).append($ajax_loader);$ajax_loader.css("top",jQuery(container).position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}jQuery(document).off("click","#pixelimg").on("click","#pixelimg",function(){event.preventDefault();event.stopPropagation();do_block_click()});let isOverBlockPointer=false;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",function(){isOverBlockPointer=true});jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",function(){isOverBlockPointer=false});jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",function(event){if(!isOverBlockPointer){show_pointer(event)}});jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",function(event){show_pointer(event)});window.$pixelimg.off("load").on("load",function(){move_image_to_selection();remove_ajax_loader()}).each(function(){if(this.complete)jQuery(this).trigger("load")});jQuery(window).on("resize",move_image_to_selection);jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",function(event){let $el=jQuery(this);$el.prop("disabled",true);$el.attr("value",MDS_OBJECT.WAIT);make_selection(event);return false});jQuery(".mds_pointer_graphic").off("load").on("load",function(){jQuery(".mds_upload_image").prop("disabled",false);jQuery(this).attr("value","Upload")});add_ajax_loader(window.$pixelimg.parent())});