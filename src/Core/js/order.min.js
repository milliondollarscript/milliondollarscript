let first_load=true;jQuery(document).off("ajaxComplete").on("ajaxComplete",function(event,xhr,settings){const params=new URLSearchParams(settings.data);const type=params.get("type");if(type!=="order"){return}if(first_load){first_load=false}else{return}window.$block_pointer=jQuery("#block_pointer");window.$pixelimg=jQuery("#pixelimg");if(window.$block_pointer.length===0||window.$pixelimg.length===0){return}let trip_count=0;const block_str=MDS_OBJECT.block_str;let low_x=parseInt(MDS_OBJECT.low_x,10);let low_y=parseInt(MDS_OBJECT.low_y,10);let is_moving=MDS_OBJECT.is_moving;const blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10);const blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10);const grid_width=parseInt(MDS_OBJECT.grid_width,10)*blk_width;const grid_height=parseInt(MDS_OBJECT.grid_height,10)*blk_height;const user_id=parseInt(MDS_OBJECT.user_id,10);const BID=parseInt(MDS_OBJECT.BID,10);let submit1=document.getElementById("submit_button1");let submit2=document.getElementById("submit_button2");document.form1.selected_pixels.value=block_str;function check_selection(){let ajax_data={_wpnonce:MDS_OBJECT.NONCE,user_id:user_id,map_x:window.$block_pointer.data("map_x"),map_y:window.$block_pointer.data("map_y"),block_id:get_clicked_block(),BID:BID,t:MDS_OBJECT.time};jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:ajax_data,dataType:"json"}).done(function(response){if(response&&(response.type==="unavailable"||response.type==="no_orders"||response.type==="no_permission")){alert(response.data.value);is_moving=true}}).fail(function(jqXHR,textStatus,errorThrown){}).always(function(){submit1.disabled=false;submit2.disabled=false;window.$block_pointer.css("cursor","pointer");window.$pixelimg.css("cursor","pointer")});if(trip_count!==0){submit1.disabled=true;submit2.disabled=true;window.$block_pointer.css("cursor","wait");window.$pixelimg.css("cursor","wait")}}function make_selection(event){event.stopPropagation();event.preventDefault();window.reserving=true;window.$block_pointer.css("cursor","wait");window.$pixelimg.css("cursor","wait");document.body.style.cursor="wait";submit1.disabled=true;submit2.disabled=true;submit1.value=MDS_OBJECT.WAIT;submit2.value=MDS_OBJECT.WAIT;submit1.style.cursor="wait";submit2.style.cursor="wait";let ajax_data={_wpnonce:MDS_OBJECT.NONCE,user_id:user_id,map_x:window.$block_pointer.data("map_x"),map_y:window.$block_pointer.data("map_y"),block_id:get_clicked_block(),BID:BID,t:MDS_OBJECT.time};jQuery.ajax({method:"POST",url:MDS_OBJECT.MAKE_SELECTION,data:ajax_data,dataType:"json"}).done(function(response){if(response&&response.type==="unavailable"){alert(response.data.value);window.$block_pointer.css("cursor","pointer");window.$pixelimg.css("cursor","pointer");document.body.style.cursor="pointer";submit1.disabled=false;submit2.disabled=false;submit1.value=MDS_OBJECT.WRITE;submit2.value=MDS_OBJECT.WRITE;submit1.style.cursor="pointer";submit2.style.cursor="pointer";window.reserving=false;is_moving=true}else{document.form1.submit()}}).fail(function(jqXHR,textStatus,errorThrown){}).always(function(){})}function getObjCoords(obj){const offset=obj.offset();const x=offset.left;const y=offset.top;return{x:x,y:y}}function show_pointer(e){if(!is_moving)return;const pixelimgPos=jQuery("#pixelimg").offset();let OffsetX=e.pageX-pixelimgPos.left;let OffsetY=e.pageY-pixelimgPos.top;OffsetX-=window.pointer_width/2;OffsetY-=window.pointer_height/2;OffsetX=Math.floor(OffsetX/blk_width)*blk_width;OffsetY=Math.floor(OffsetY/blk_height)*blk_height;if(isNaN(OffsetX)||isNaN(OffsetY)||OffsetX<0||OffsetY<0){return}if(OffsetY+window.pointer_height>grid_height){OffsetY=grid_height-window.pointer_height}if(OffsetX+window.pointer_width>grid_width){OffsetX=grid_width-window.pointer_width}window.$block_pointer.css("top",OffsetY+"px");window.$block_pointer.css("left",OffsetX+"px");window.$block_pointer.data({map_y:OffsetY,map_x:OffsetX});return true}function get_clicked_block(){let map_x=window.$block_pointer.data("map_x")/blk_width;let map_y=window.$block_pointer.data("map_y")/blk_height;return map_y*(grid_width/blk_width)+map_x}function do_block_click(){if(window.reserving){return}trip_count=1;check_selection();low_x=window.$block_pointer.position().left;low_y=window.$block_pointer.position().top;is_moving=!is_moving}function move_image_to_selection(){window.$block_pointer.css({top:low_y+"px",left:low_x+"px",visibility:"visible"});window.$block_pointer.data({map_y:low_y,map_x:low_x})}function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");jQuery(container).append($ajax_loader);$ajax_loader.css("top",jQuery(container).position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}jQuery(document).off("click","#pixelimg").on("click","#pixelimg",function(){event.preventDefault();event.stopPropagation();do_block_click()});let isOverBlockPointer=false;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",function(){isOverBlockPointer=true});jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",function(){isOverBlockPointer=false});jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",function(event){if(!isOverBlockPointer){show_pointer(event)}});jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",function(event){show_pointer(event)});window.$pixelimg.off("load").on("load",function(){move_image_to_selection();remove_ajax_loader()}).each(function(){if(this.complete)jQuery(this).trigger("load")});jQuery(window).on("resize",move_image_to_selection);jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",function(event){make_selection(event);return false});add_ajax_loader(window.$pixelimg.parent())});