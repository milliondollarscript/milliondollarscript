let first_load=!0;function setupOrderGridImageFeedback(){const e=document.getElementById("pixelimg");if(!e||"1"===e.dataset.mdsFeedbackAttached)return;e.dataset.mdsFeedbackAttached="1";const i=e.closest(".mds-grid-frame");if(!i)return;const t=i.querySelector(".mds-grid-feedback"),o=i.querySelector(".mds-grid-preloader"),n=i.querySelector("#block_pointer")||document.getElementById("block_pointer");if(!t||!o)return;const d=t.querySelector(".mds-grid-feedback__retry"),r=e.getAttribute("data-grid-src")||e.getAttribute("src")||"",l=()=>{n&&(n.style.visibility="hidden")},a=()=>{n&&(n.style.visibility="visible")},s=()=>{e.classList.add("mds-grid-image--hidden")},c=()=>{e.classList.remove("mds-grid-image--hidden")},_=()=>{t.setAttribute("hidden","hidden"),t.classList.remove("is-visible")},w=(e={})=>{o&&((()=>{if(o&&0===o.children.length){const e=o.getAttribute("data-loader-src"),i=e?"<img class='mds-grid-preloader__spinner' src='"+e+"' alt='' aria-hidden='true' width='32' height='32'/>":"<span class='mds-grid-preloader__spinner' aria-hidden='true'></span>";o.setAttribute("data-loader-src",e||""),o.innerHTML=i}})(),o.removeAttribute("hidden"),o.dataset.mdsPreloaderActive="1",!1!==e.hideImage&&s(),!1!==e.hidePointer&&l())},p=()=>{o&&(o.setAttribute("hidden","hidden"),o.innerHTML="",delete o.dataset.mdsPreloaderActive)},h=()=>{p(),t.removeAttribute("hidden"),t.classList.add("is-visible"),l(),s()},u=()=>{0!==e.naturalWidth&&0!==e.naturalHeight?(p(),c(),a(),_()):h()},g=()=>{h()};e.mdsGridControls={showPreloader:w,hidePreloader:p,showFeedback:h,hideFeedback:_,hidePointer:l,showPointer:a,hideImage:s,showImage:c},e.addEventListener("load",u),e.addEventListener("error",g),e.addEventListener("abort",g),d&&d.addEventListener("click",(function(i){i.preventDefault(),_(),w();const t=-1===r.indexOf("?")?"?":"&";e.src=r+t+"_mds_retry="+Date.now()})),e.complete?0===e.naturalWidth||0===e.naturalHeight?g():u():(_(),w())}jQuery((function(){setupOrderGridImageFeedback()})),jQuery(document).on("ajaxComplete",(function(e,i,t){if("order"!==new URLSearchParams(t.data).get("type"))return;if(!first_load)return;if(first_load=!1,window.$block_pointer=jQuery("#block_pointer"),window.$pixelimg=jQuery("#pixelimg"),0===window.$block_pointer.length||0===window.$pixelimg.length)return;if(setupOrderGridImageFeedback(),window.MDS_OBJECT&&window.MDS_OBJECT.grid_data){const e=window.MDS_OBJECT.grid_data;window.$block_pointer.attr("data-original-width",e.pointer_width),window.$block_pointer.attr("data-original-height",e.pointer_height),window.$block_pointer.css({width:e.pointer_width+"px",height:e.pointer_height+"px"}),e.debug_mode&&console.log("Grid dimensions:",{width_px:e.orig_width_px,height_px:e.orig_height_px,width_blocks:e.grid_width_blocks,height_blocks:e.grid_height_blocks,block_width:e.block_width,block_height:e.block_height})}let o=0;const n=MDS_OBJECT.block_str;let d=parseInt(MDS_OBJECT.low_x,10),r=parseInt(MDS_OBJECT.low_y,10),l=MDS_OBJECT.is_moving;window.blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10),window.blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10),window.grid_width=parseInt(MDS_OBJECT.grid_width,10)*window.blk_width,window.grid_height=parseInt(MDS_OBJECT.grid_height,10)*window.blk_height,window.pointer_width=window.blk_width,window.pointer_height=window.blk_height;const a=parseInt(MDS_OBJECT.user_id,10),s=parseInt(MDS_OBJECT.BID,10);let c,_=document.getElementById("submit_button1"),w=document.getElementById("submit_button2");function p(){const e=jQuery("#pixelimg");if(!e.length)return;const i=MDS_OBJECT.grid_data||{},t=parseInt(i.grid_width_blocks||MDS_OBJECT.grid_width),o=parseInt(i.grid_height_blocks||MDS_OBJECT.grid_height);if(!t||!o)return void console.error("Invalid grid dimensions in scaleImageMap");const n=e.width(),d=e.height(),r=e[0].getBoundingClientRect(),l=e.parent()[0].getBoundingClientRect(),a=n/t,s=d/o;if(window.blk_width=a,window.blk_height=s,window.grid_width=n,window.grid_height=d,window.grid_width_in_blocks=t,window.grid_height_in_blocks=o,window.$block_pointer){const e=parseInt(window.$block_pointer.attr("data-original-width"))||i.pointer_width||4*a,c=parseInt(window.$block_pointer.attr("data-original-height"))||i.pointer_height||4*s;window.$block_pointer.data("orig-width")||window.$block_pointer.data({"orig-width":e,"orig-height":c});const _=n/(i.orig_width_px||t*i.block_width),w=e*_,p=c*_;if(window.$block_pointer.css({width:w+"px",height:p+"px"}),window.pointer_width=w,window.pointer_height=p,void 0!==window.$block_pointer.data("block_x")){const _=parseInt(window.$block_pointer.data("block_x")),w=parseInt(window.$block_pointer.data("block_y")),p=window.$block_pointer.outerWidth(!0),h=window.$block_pointer.outerHeight(!0);let u=_*a,g=w*s;const b=n-p,m=d-h;u=Math.min(Math.max(0,u),b),g=Math.min(Math.max(0,g),m);const k=r.left-l.left,f=r.top-l.top;window.$block_pointer.css({left:u+k+"px",top:g+f+"px"});const x=Math.round(u/a),y=Math.round(g/s);window.$block_pointer.data({map_x:u,map_y:g,block_x:x,block_y:y}),window.mds_x=u,window.mds_y=g,i.debug_mode&&console.log("ScaleImageMap:",{grid:{blocks:t+"x"+o,pixels:n+"x"+d},block:{width:a,height:s},pointer:{original:e+"x"+c,actual:p+"x"+h},position:{pixel:u+","+g,block:x+","+y,max:b+","+m}})}}}function h(e){if(!l)return;const i=jQuery("#pixelimg");if(!i.length)return;const t=MDS_OBJECT.grid_data||{},o=parseInt(t.grid_width_blocks||MDS_OBJECT.grid_width),n=parseInt(t.grid_height_blocks||MDS_OBJECT.grid_height);if(!o||!n)return console.error("Invalid grid dimensions"),!1;const d=i.width(),r=i.height(),a=window.$block_pointer,s=i[0].getBoundingClientRect(),c=i.parent()[0].getBoundingClientRect(),_=d/o,w=r/n;window.grid_width=d,window.grid_height=r,window.grid_width_in_blocks=o,window.grid_height_in_blocks=n,window.blk_width=_,window.blk_height=w;const p=e.clientX-s.left,h=e.clientY-s.top,u=Math.max(0,Math.min(p,d-1)),g=Math.max(0,Math.min(h,r-1)),b=a.outerWidth(!0),m=a.outerHeight(!0);let k=Math.floor(u/_),f=Math.floor(g/w),x=k*_,y=f*w;const M=d-b,E=r-m;x=Math.min(x,M),y=Math.min(y,E);const T=s.left-c.left,v=s.top-c.top;return a.css({left:x+T+"px",top:y+v+"px"}),k=Math.round(x/_),f=Math.round(y/w),a.data({map_x:x,map_y:y,block_x:k,block_y:f}),window.mds_x=x,window.mds_y=y,t.debug_mode&&console.log("Pointer:",{grid:{blocks:o+"x"+n,pixels:d+"x"+r},block:{width:_,height:w},pointer:{size:b+"x"+m},position:{pixel:x+","+y,block:k+","+f,max:M+","+E}}),!0}function u(){const e=MDS_OBJECT.grid_data||{},i=parseInt(MDS_OBJECT.grid_width||e.grid_width_blocks),t=parseInt(MDS_OBJECT.grid_height||e.grid_height_blocks);if(!i||!t)return console.error("Grid dimensions not available"),-1;if(window.$block_pointer){const o=window.$block_pointer.offset(),n=window.$pixelimg.offset(),d=window.$block_pointer.outerWidth(),r=window.$block_pointer.outerHeight(),l=o.left-n.left+d/2,a=o.top-n.top+r/2,s=window.$pixelimg.width()/i,c=window.$pixelimg.height()/t,_=Math.floor(l/s),w=Math.floor(a/c);return _<0||w<0||_>=i||w>=t?(console.error("Invalid block coordinates:",_,w),-1):(e.debug_mode&&console.log("Selection:",{pointer:{left:o.left,top:o.top,width:d,height:r},center:{x:l,y:a},block:{x:_,y:w,width:s,height:c},grid:{width:i,height:t}}),w*i+_)}return-1}function g(){window.reserving||(o=1,function(){const e=window.$block_pointer.position(),i=u(),t=MDS_OBJECT.grid_data||{},n=parseInt(MDS_OBJECT.grid_width||t.grid_width_blocks),d=window.$pixelimg.width(),r=parseInt(t.orig_width_px||n*t.block_width)/d,c=Math.round(e.left*r),p=Math.round(e.top*r);Math.floor(i/n);let h={_wpnonce:MDS_OBJECT.NONCE,user_id:a,map_x:c,map_y:p,block_id:i,BID:s,t:MDS_OBJECT.time};jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:h,dataType:"json"}).done((function(e){e&&("unavailable"===e.type||"no_orders"===e.type||"no_permission"===e.type?(alert(e.data.value),l=!0):"available"===e.type&&console.log("Blocks are available for selection"))})).fail((function(e,i,t){console.error("Selection check failed:",i,t)})).always((function(){_.disabled=!1,w.disabled=!1,window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer")})),0!==o&&(_.disabled=!0,w.disabled=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"))}(),d=window.$block_pointer.position().left,r=window.$block_pointer.position().top,l=!l)}function b(){window.$block_pointer.css({top:r+"px",left:d+"px",visibility:"visible"}),window.$block_pointer.data({map_y:r,map_x:d})}document.form1.selected_pixels.value=n,window.addEventListener("resize",(function(){clearTimeout(c),c=setTimeout((function(){p()}),100)})),jQuery(document).ready((function(){const e=document.getElementById("pixelimg");e&&e.addEventListener("load",(function(){p()})),setTimeout((function(){p()}),100)})),jQuery(document).off("click","#pixelimg").on("click","#pixelimg",(function(){e.preventDefault(),e.stopPropagation(),g()}));let m=!1;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",(function(){m=!0})),jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",(function(){m=!1})),jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",(function(e){m||h(e)})),jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",(function(e){h(e)})),window.$pixelimg.off("load").on("load",(function(){b(),jQuery(".ajax-loader").remove()})).each((function(){this.complete&&jQuery(this).trigger("load")})),jQuery(window).on("resize",b),jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",(function(e){let i=jQuery(this);return i.prop("disabled",!0),i.attr("value",MDS_OBJECT.WAIT),function(e){e.stopPropagation(),e.preventDefault(),window.reserving=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"),document.body.style.cursor="wait",_.disabled=!0,w.disabled=!0,_.value=MDS_OBJECT.WAIT,w.value=MDS_OBJECT.WAIT,_.style.cursor="wait",w.style.cursor="wait";const i=window.$block_pointer.position(),t=MDS_OBJECT.grid_data||{},o=parseInt(MDS_OBJECT.grid_width||t.grid_width_blocks),n=window.$pixelimg.width(),d=parseInt(t.orig_width_px||o*t.block_width)/n,r=Math.round(i.left*d),c=Math.round(i.top*d);let p={mds_nonce:MDS_OBJECT.mds_nonce,action:"mds_ajax",type:"make-selection",user_id:a,map_x:r,map_y:c,block_id:u(),BID:s,t:MDS_OBJECT.time,package:get_selected_package()};jQuery.ajax({method:"POST",url:MDS_OBJECT.ajaxurl,data:p,dataType:"json"}).done((function(e){e&&("unavailable"===e.type||"max_orders"===e.type?(alert(e.data.value),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",_.disabled=!1,w.disabled=!1,_.value=MDS_OBJECT.WRITE,w.value=MDS_OBJECT.WRITE,_.style.cursor="pointer",w.style.cursor="pointer",window.reserving=!1,l=!0):e.redirect?window.location.href=e.redirect:(mds_update_package(jQuery(document.form1)),document.form1.submit()))})).fail((function(e,i,t){console.error("Selection request failed:",i,t),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",_.disabled=!1,w.disabled=!1,_.value=MDS_OBJECT.WRITE,w.value=MDS_OBJECT.WRITE,_.style.cursor="pointer",w.style.cursor="pointer",window.reserving=!1}))}(e),!1})),jQuery(".mds_pointer_graphic").off("load").on("load",(function(){jQuery(".mds_upload_image").prop("disabled",!1),jQuery(this).attr("value","Upload")})),function(e){let i=jQuery("<div class='ajax-loader'></div>");jQuery(e).append(i),i.css("top",jQuery(e).position().top).css("left",jQuery(e).width()/2-i.width()/2)}(window.$pixelimg.parent())}));