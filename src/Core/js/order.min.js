let first_load=!0;jQuery(document).on("ajaxComplete",(function(i,o,t){if("order"!==new URLSearchParams(t.data).get("type"))return;if(!first_load)return;if(first_load=!1,window.$block_pointer=jQuery("#block_pointer"),window.$pixelimg=jQuery("#pixelimg"),0===window.$block_pointer.length||0===window.$pixelimg.length)return;if(window.MDS_OBJECT&&window.MDS_OBJECT.grid_data){const i=window.MDS_OBJECT.grid_data;window.$block_pointer.attr("data-original-width",i.pointer_width),window.$block_pointer.attr("data-original-height",i.pointer_height),window.$block_pointer.css({width:i.pointer_width+"px",height:i.pointer_height+"px"}),i.debug_mode&&console.log("Grid dimensions:",{width_px:i.orig_width_px,height_px:i.orig_height_px,width_blocks:i.grid_width_blocks,height_blocks:i.grid_height_blocks,block_width:i.block_width,block_height:i.block_height})}let e=0;const n=MDS_OBJECT.block_str;let r=parseInt(MDS_OBJECT.low_x,10),d=parseInt(MDS_OBJECT.low_y,10),l=MDS_OBJECT.is_moving;window.blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10),window.blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10),window.grid_width=parseInt(MDS_OBJECT.grid_width,10)*window.blk_width,window.grid_height=parseInt(MDS_OBJECT.grid_height,10)*window.blk_height,window.pointer_width=window.blk_width,window.pointer_height=window.blk_height;const a=parseInt(MDS_OBJECT.user_id,10),w=parseInt(MDS_OBJECT.BID,10);let _,s=document.getElementById("submit_button1"),c=document.getElementById("submit_button2");function p(){const i=jQuery("#pixelimg");if(!i.length)return;const o=MDS_OBJECT.grid_data||{},t=parseInt(o.grid_width_blocks||MDS_OBJECT.grid_width),e=parseInt(o.grid_height_blocks||MDS_OBJECT.grid_height);if(!t||!e)return void console.error("Invalid grid dimensions in scaleImageMap");const n=i.width(),r=i.height(),d=n/t,l=r/e;if(window.blk_width=d,window.blk_height=l,window.grid_width=n,window.grid_height=r,window.grid_width_in_blocks=t,window.grid_height_in_blocks=e,window.$block_pointer){const i=parseInt(window.$block_pointer.attr("data-original-width"))||o.pointer_width||4*d,a=parseInt(window.$block_pointer.attr("data-original-height"))||o.pointer_height||4*l;window.$block_pointer.data("orig-width")||window.$block_pointer.data({"orig-width":i,"orig-height":a});const w=n/(o.orig_width_px||t*o.block_width),_=i*w,s=a*w;if(window.$block_pointer.css({width:_+"px",height:s+"px"}),window.pointer_width=_,window.pointer_height=s,void 0!==window.$block_pointer.data("block_x")){const w=parseInt(window.$block_pointer.data("block_x")),_=parseInt(window.$block_pointer.data("block_y")),s=window.$block_pointer.outerWidth(!0),c=window.$block_pointer.outerHeight(!0);let p=w*d,h=_*l;const u=n-s,g=r-c;p=Math.min(Math.max(0,p),u),h=Math.min(Math.max(0,h),g),window.$block_pointer.css({left:p+"px",top:h+"px"});const b=Math.round(p/d),m=Math.round(h/l);window.$block_pointer.data({map_x:p,map_y:h,block_x:b,block_y:m}),window.mds_x=p,window.mds_y=h,o.debug_mode&&console.log("ScaleImageMap:",{grid:{blocks:t+"x"+e,pixels:n+"x"+r},block:{width:d,height:l},pointer:{original:i+"x"+a,actual:s+"x"+c},position:{pixel:p+","+h,block:b+","+m,max:u+","+g}})}}}function h(i){if(!l)return;const o=jQuery("#pixelimg");if(!o.length)return;const t=MDS_OBJECT.grid_data||{},e=parseInt(t.grid_width_blocks||MDS_OBJECT.grid_width),n=parseInt(t.grid_height_blocks||MDS_OBJECT.grid_height);if(!e||!n)return console.error("Invalid grid dimensions"),!1;const r=o.width(),d=o.height(),a=o.offset(),w=window.$block_pointer,_=r/e,s=d/n;window.grid_width=r,window.grid_height=d,window.grid_width_in_blocks=e,window.grid_height_in_blocks=n,window.blk_width=_,window.blk_height=s;const c=i.pageX-a.left,p=i.pageY-a.top,h=Math.max(0,Math.min(c,r-1)),u=Math.max(0,Math.min(p,d-1)),g=w.outerWidth(!0),b=w.outerHeight(!0);let m=Math.floor(h/_),k=Math.floor(u/s),f=m*_,x=k*s;const y=r-g,M=d-b;return f=Math.min(f,y),x=Math.min(x,M),w.css({left:f+"px",top:x+"px"}),m=Math.round(f/_),k=Math.round(x/s),w.data({map_x:f,map_y:x,block_x:m,block_y:k}),window.mds_x=f,window.mds_y=x,t.debug_mode&&console.log("Pointer:",{grid:{blocks:e+"x"+n,pixels:r+"x"+d},block:{width:_,height:s},pointer:{size:g+"x"+b},position:{pixel:f+","+x,block:m+","+k,max:y+","+M}}),!0}function u(){const i=MDS_OBJECT.grid_data||{},o=parseInt(MDS_OBJECT.grid_width||i.grid_width_blocks),t=parseInt(MDS_OBJECT.grid_height||i.grid_height_blocks);if(!o||!t)return console.error("Grid dimensions not available"),-1;if(window.$block_pointer){const e=window.$block_pointer.offset(),n=window.$pixelimg.offset(),r=window.$block_pointer.outerWidth(),d=window.$block_pointer.outerHeight(),l=e.left-n.left+r/2,a=e.top-n.top+d/2,w=window.$pixelimg.width()/o,_=window.$pixelimg.height()/t,s=Math.floor(l/w),c=Math.floor(a/_);return s<0||c<0||s>=o||c>=t?(console.error("Invalid block coordinates:",s,c),-1):(i.debug_mode&&console.log("Selection:",{pointer:{left:e.left,top:e.top,width:r,height:d},center:{x:l,y:a},block:{x:s,y:c,width:w,height:_},grid:{width:o,height:t}}),c*o+s)}return-1}function g(){window.reserving||(e=1,function(){const i=window.$block_pointer.position(),o=u(),t=MDS_OBJECT.grid_data||{},n=parseInt(MDS_OBJECT.grid_width||t.grid_width_blocks),r=window.$pixelimg.width(),d=parseInt(t.orig_width_px||n*t.block_width)/r,_=Math.round(i.left*d),p=Math.round(i.top*d);Math.floor(o/n);let h={_wpnonce:MDS_OBJECT.NONCE,user_id:a,map_x:_,map_y:p,block_id:o,BID:w,t:MDS_OBJECT.time};jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:h,dataType:"json"}).done((function(i){i&&("unavailable"===i.type||"no_orders"===i.type||"no_permission"===i.type?(alert(i.data.value),l=!0):"available"===i.type&&console.log("Blocks are available for selection"))})).fail((function(i,o,t){console.error("Selection check failed:",o,t)})).always((function(){s.disabled=!1,c.disabled=!1,window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer")})),0!==e&&(s.disabled=!0,c.disabled=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"))}(),r=window.$block_pointer.position().left,d=window.$block_pointer.position().top,l=!l)}function b(){window.$block_pointer.css({top:d+"px",left:r+"px",visibility:"visible"}),window.$block_pointer.data({map_y:d,map_x:r})}document.form1.selected_pixels.value=n,window.addEventListener("resize",(function(){clearTimeout(_),_=setTimeout((function(){p()}),100)})),jQuery(document).ready((function(){const i=document.getElementById("pixelimg");i&&i.addEventListener("load",(function(){p()})),setTimeout((function(){p()}),100)})),jQuery(document).off("click","#pixelimg").on("click","#pixelimg",(function(){i.preventDefault(),i.stopPropagation(),g()}));let m=!1;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",(function(){m=!0})),jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",(function(){m=!1})),jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",(function(i){m||h(i)})),jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",(function(i){h(i)})),window.$pixelimg.off("load").on("load",(function(){b(),jQuery(".ajax-loader").remove()})).each((function(){this.complete&&jQuery(this).trigger("load")})),jQuery(window).on("resize",b),jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",(function(i){let o=jQuery(this);return o.prop("disabled",!0),o.attr("value",MDS_OBJECT.WAIT),function(i){i.stopPropagation(),i.preventDefault(),window.reserving=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"),document.body.style.cursor="wait",s.disabled=!0,c.disabled=!0,s.value=MDS_OBJECT.WAIT,c.value=MDS_OBJECT.WAIT,s.style.cursor="wait",c.style.cursor="wait";const o=window.$block_pointer.position(),t=MDS_OBJECT.grid_data||{},e=parseInt(MDS_OBJECT.grid_width||t.grid_width_blocks),n=window.$pixelimg.width(),r=parseInt(t.orig_width_px||e*t.block_width)/n,d=Math.round(o.left*r),_=Math.round(o.top*r);let p={mds_nonce:MDS_OBJECT.mds_nonce,action:"mds_ajax",type:"make-selection",user_id:a,map_x:d,map_y:_,block_id:u(),BID:w,t:MDS_OBJECT.time,package:get_selected_package()};jQuery.ajax({method:"POST",url:MDS_OBJECT.ajaxurl,data:p,dataType:"json"}).done((function(i){i&&("unavailable"===i.type||"max_orders"===i.type?(alert(i.data.value),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",s.disabled=!1,c.disabled=!1,s.value=MDS_OBJECT.WRITE,c.value=MDS_OBJECT.WRITE,s.style.cursor="pointer",c.style.cursor="pointer",window.reserving=!1,l=!0):i.redirect?window.location.href=i.redirect:(mds_update_package(jQuery(document.form1)),document.form1.submit()))})).fail((function(i,o,t){console.error("Selection request failed:",o,t),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",s.disabled=!1,c.disabled=!1,s.value=MDS_OBJECT.WRITE,c.value=MDS_OBJECT.WRITE,s.style.cursor="pointer",c.style.cursor="pointer",window.reserving=!1}))}(i),!1})),jQuery(".mds_pointer_graphic").off("load").on("load",(function(){jQuery(".mds_upload_image").prop("disabled",!1),jQuery(this).attr("value","Upload")})),function(i){let o=jQuery("<div class='ajax-loader'></div>");jQuery(i).append(o),o.css("top",jQuery(i).position().top).css("left",jQuery(i).width()/2-o.width()/2)}(window.$pixelimg.parent())}));