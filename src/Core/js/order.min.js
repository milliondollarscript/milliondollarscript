var first_load=!0;jQuery(document).on("ajaxComplete",function(event,xhr,settings){if(new URLSearchParams(settings.data).get("type")!=="order")return;if(first_load)first_load=!1;else return;if(window.$block_pointer=jQuery("#block_pointer"),window.$pixelimg=jQuery("#pixelimg"),window.$block_pointer.length===0||window.$pixelimg.length===0)return;if(window.MDS_OBJECT&&window.MDS_OBJECT.grid_data){let gridData=window.MDS_OBJECT.grid_data;if(window.$block_pointer.attr("data-original-width",gridData.pointer_width),window.$block_pointer.attr("data-original-height",gridData.pointer_height),window.$block_pointer.css({width:gridData.pointer_width+"px",height:gridData.pointer_height+"px"}),gridData.debug_mode)console.log("Grid dimensions:",{width_px:gridData.orig_width_px,height_px:gridData.orig_height_px,width_blocks:gridData.grid_width_blocks,height_blocks:gridData.grid_height_blocks,block_width:gridData.block_width,block_height:gridData.block_height})}let trip_count=0,block_str=MDS_OBJECT.block_str,low_x=parseInt(MDS_OBJECT.low_x,10),low_y=parseInt(MDS_OBJECT.low_y,10),is_moving=MDS_OBJECT.is_moving;window.blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10),window.blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10),window.grid_width=parseInt(MDS_OBJECT.grid_width,10)*window.blk_width,window.grid_height=parseInt(MDS_OBJECT.grid_height,10)*window.blk_height,window.pointer_width=window.blk_width,window.pointer_height=window.blk_height;let user_id=parseInt(MDS_OBJECT.user_id,10),BID=parseInt(MDS_OBJECT.BID,10),submit1=document.getElementById("submit_button1"),submit2=document.getElementById("submit_button2");document.form1.selected_pixels.value=block_str;function check_selection(){let pointerOffset=window.$block_pointer.position(),blockId=get_clicked_block(),gridData=MDS_OBJECT.grid_data||{},gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks),currentImgWidth=window.$pixelimg.width(),scaleFactor=parseInt(gridData.orig_width_px||gridWidthBlocks*gridData.block_width)/currentImgWidth,scaledX=Math.round(pointerOffset.left*scaleFactor),scaledY=Math.round(pointerOffset.top*scaleFactor),blockY=Math.floor(blockId/gridWidthBlocks),blockX=blockId%gridWidthBlocks,ajax_data={_wpnonce:MDS_OBJECT.NONCE,user_id,map_x:scaledX,map_y:scaledY,block_id:blockId,BID,t:MDS_OBJECT.time};if(jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:ajax_data,dataType:"json"}).done(function(response){if(response){if(response.type==="unavailable"||response.type==="no_orders"||response.type==="no_permission")alert(response.data.value),is_moving=!0;else if(response.type==="available")console.log("Blocks are available for selection")}}).fail(function(jqXHR,textStatus,errorThrown){console.error("Selection check failed:",textStatus,errorThrown)}).always(function(){submit1.disabled=!1,submit2.disabled=!1,window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer")}),trip_count!==0)submit1.disabled=!0,submit2.disabled=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait")}function make_selection(event2){event2.stopPropagation(),event2.preventDefault(),window.reserving=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"),document.body.style.cursor="wait",submit1.disabled=!0,submit2.disabled=!0,submit1.value=MDS_OBJECT.WAIT,submit2.value=MDS_OBJECT.WAIT,submit1.style.cursor="wait",submit2.style.cursor="wait";let pointerOffset=window.$block_pointer.position(),gridData=MDS_OBJECT.grid_data||{},gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks),currentImgWidth=window.$pixelimg.width(),scaleFactor=parseInt(gridData.orig_width_px||gridWidthBlocks*gridData.block_width)/currentImgWidth,scaledX=Math.round(pointerOffset.left*scaleFactor),scaledY=Math.round(pointerOffset.top*scaleFactor),ajax_data={mds_nonce:MDS_OBJECT.mds_nonce,action:"mds_ajax",type:"make-selection",user_id,map_x:scaledX,map_y:scaledY,block_id:get_clicked_block(),BID,t:MDS_OBJECT.time,package:get_selected_package()};jQuery.ajax({method:"POST",url:MDS_OBJECT.ajaxurl,data:ajax_data,dataType:"json"}).done(function(response){if(response)if(response.type==="unavailable"||response.type==="max_orders")alert(response.data.value),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",submit1.disabled=!1,submit2.disabled=!1,submit1.value=MDS_OBJECT.WRITE,submit2.value=MDS_OBJECT.WRITE,submit1.style.cursor="pointer",submit2.style.cursor="pointer",window.reserving=!1,is_moving=!0;else if(response.redirect)window.location.href=response.redirect;else mds_update_package(jQuery(document.form1)),document.form1.submit()}).fail(function(jqXHR,textStatus,errorThrown){console.error("Selection request failed:",textStatus,errorThrown),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",submit1.disabled=!1,submit2.disabled=!1,submit1.value=MDS_OBJECT.WRITE,submit2.value=MDS_OBJECT.WRITE,submit1.style.cursor="pointer",submit2.style.cursor="pointer",window.reserving=!1})}function getObjCoords(obj){let offset=obj.offset(),x=offset.left,y=offset.top;return{x,y}}function scaleImageMap(){let img=jQuery("#pixelimg");if(!img.length)return;let gridData=MDS_OBJECT.grid_data||{},gridWidthBlocks=parseInt(gridData.grid_width_blocks||MDS_OBJECT.grid_width),gridHeightBlocks=parseInt(gridData.grid_height_blocks||MDS_OBJECT.grid_height);if(!gridWidthBlocks||!gridHeightBlocks){console.error("Invalid grid dimensions in scaleImageMap");return}let currentWidth=img.width(),currentHeight=img.height(),blockWidth=currentWidth/gridWidthBlocks,blockHeight=currentHeight/gridHeightBlocks;if(window.blk_width=blockWidth,window.blk_height=blockHeight,window.grid_width=currentWidth,window.grid_height=currentHeight,window.grid_width_in_blocks=gridWidthBlocks,window.grid_height_in_blocks=gridHeightBlocks,window.$block_pointer){let origWidth=parseInt(window.$block_pointer.attr("data-original-width"))||gridData.pointer_width||blockWidth*4,origHeight=parseInt(window.$block_pointer.attr("data-original-height"))||gridData.pointer_height||blockHeight*4;if(!window.$block_pointer.data("orig-width"))window.$block_pointer.data({"orig-width":origWidth,"orig-height":origHeight});let origGridWidth=gridData.orig_width_px||gridWidthBlocks*gridData.block_width,scaleFactor=currentWidth/origGridWidth,scaledWidth=origWidth*scaleFactor,scaledHeight=origHeight*scaleFactor;if(window.$block_pointer.css({width:scaledWidth+"px",height:scaledHeight+"px"}),window.pointer_width=scaledWidth,window.pointer_height=scaledHeight,window.$block_pointer.data("block_x")!==void 0){let blockX=parseInt(window.$block_pointer.data("block_x")),blockY=parseInt(window.$block_pointer.data("block_y")),pointerWidth=window.$block_pointer.outerWidth(!0),pointerHeight=window.$block_pointer.outerHeight(!0),pixelX=blockX*blockWidth,pixelY=blockY*blockHeight,maxX=currentWidth-pointerWidth,maxY=currentHeight-pointerHeight;pixelX=Math.min(Math.max(0,pixelX),maxX),pixelY=Math.min(Math.max(0,pixelY),maxY),window.$block_pointer.css({left:pixelX+"px",top:pixelY+"px"});let safeBlockX=Math.round(pixelX/blockWidth),safeBlockY=Math.round(pixelY/blockHeight);if(window.$block_pointer.data({map_x:pixelX,map_y:pixelY,block_x:safeBlockX,block_y:safeBlockY}),window.mds_x=pixelX,window.mds_y=pixelY,gridData.debug_mode)console.log("ScaleImageMap:",{grid:{blocks:gridWidthBlocks+"x"+gridHeightBlocks,pixels:currentWidth+"x"+currentHeight},block:{width:blockWidth,height:blockHeight},pointer:{original:origWidth+"x"+origHeight,actual:pointerWidth+"x"+pointerHeight},position:{pixel:pixelX+","+pixelY,block:safeBlockX+","+safeBlockY,max:maxX+","+maxY}})}}}let resizeTimer;window.addEventListener("resize",function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){scaleImageMap()},100)}),jQuery(document).ready(function(){let pixelimg=document.getElementById("pixelimg");if(pixelimg)pixelimg.addEventListener("load",function(){scaleImageMap()});setTimeout(function(){scaleImageMap()},100)});function show_pointer(e){if(!is_moving)return;let img=jQuery("#pixelimg");if(!img.length)return;let gridData=MDS_OBJECT.grid_data||{},gridWidthBlocks=parseInt(gridData.grid_width_blocks||MDS_OBJECT.grid_width),gridHeightBlocks=parseInt(gridData.grid_height_blocks||MDS_OBJECT.grid_height);if(!gridWidthBlocks||!gridHeightBlocks)return console.error("Invalid grid dimensions"),!1;let imgWidth=img.width(),imgHeight=img.height(),imgOffset=img.offset(),pointer=window.$block_pointer,blockWidth=imgWidth/gridWidthBlocks,blockHeight=imgHeight/gridHeightBlocks;window.grid_width=imgWidth,window.grid_height=imgHeight,window.grid_width_in_blocks=gridWidthBlocks,window.grid_height_in_blocks=gridHeightBlocks,window.blk_width=blockWidth,window.blk_height=blockHeight;let mouseX=e.pageX-imgOffset.left,mouseY=e.pageY-imgOffset.top,boundedMouseX=Math.max(0,Math.min(mouseX,imgWidth-1)),boundedMouseY=Math.max(0,Math.min(mouseY,imgHeight-1)),pointerWidth=pointer.outerWidth(!0),pointerHeight=pointer.outerHeight(!0),blockX=Math.floor(boundedMouseX/blockWidth),blockY=Math.floor(boundedMouseY/blockHeight),pixelX=blockX*blockWidth,pixelY=blockY*blockHeight,maxX=imgWidth-pointerWidth,maxY=imgHeight-pointerHeight;if(pixelX=Math.min(pixelX,maxX),pixelY=Math.min(pixelY,maxY),pointer.css({left:pixelX+"px",top:pixelY+"px"}),blockX=Math.round(pixelX/blockWidth),blockY=Math.round(pixelY/blockHeight),pointer.data({map_x:pixelX,map_y:pixelY,block_x:blockX,block_y:blockY}),window.mds_x=pixelX,window.mds_y=pixelY,gridData.debug_mode)console.log("Pointer:",{grid:{blocks:gridWidthBlocks+"x"+gridHeightBlocks,pixels:imgWidth+"x"+imgHeight},block:{width:blockWidth,height:blockHeight},pointer:{size:pointerWidth+"x"+pointerHeight},position:{pixel:pixelX+","+pixelY,block:blockX+","+blockY,max:maxX+","+maxY}});return!0}function get_clicked_block(){let gridData=MDS_OBJECT.grid_data||{},gridWidthBlocks=parseInt(MDS_OBJECT.grid_width||gridData.grid_width_blocks),gridHeightBlocks=parseInt(MDS_OBJECT.grid_height||gridData.grid_height_blocks);if(!gridWidthBlocks||!gridHeightBlocks)return console.error("Grid dimensions not available"),-1;if(window.$block_pointer){let pointerOffset=window.$block_pointer.offset(),imgOffset=window.$pixelimg.offset(),pointerWidth=window.$block_pointer.outerWidth(),pointerHeight=window.$block_pointer.outerHeight(),centerX=pointerOffset.left-imgOffset.left+pointerWidth/2,centerY=pointerOffset.top-imgOffset.top+pointerHeight/2,imgWidth=window.$pixelimg.width(),imgHeight=window.$pixelimg.height(),blockWidth=imgWidth/gridWidthBlocks,blockHeight=imgHeight/gridHeightBlocks,blockX=Math.floor(centerX/blockWidth),blockY=Math.floor(centerY/blockHeight);if(blockX<0||blockY<0||blockX>=gridWidthBlocks||blockY>=gridHeightBlocks)return console.error("Invalid block coordinates:",blockX,blockY),-1;if(gridData.debug_mode)console.log("Selection:",{pointer:{left:pointerOffset.left,top:pointerOffset.top,width:pointerWidth,height:pointerHeight},center:{x:centerX,y:centerY},block:{x:blockX,y:blockY,width:blockWidth,height:blockHeight},grid:{width:gridWidthBlocks,height:gridHeightBlocks}});return blockY*gridWidthBlocks+blockX}return-1}function do_block_click(){if(window.reserving)return;trip_count=1,check_selection(),low_x=window.$block_pointer.position().left,low_y=window.$block_pointer.position().top,is_moving=!is_moving}function move_image_to_selection(){window.$block_pointer.css({top:low_y+"px",left:low_x+"px",visibility:"visible"}),window.$block_pointer.data({map_y:low_y,map_x:low_x})}function add_ajax_loader(container){let $ajax_loader=jQuery("<div class='ajax-loader'></div>");jQuery(container).append($ajax_loader),$ajax_loader.css("top",jQuery(container).position().top).css("left",jQuery(container).width()/2-$ajax_loader.width()/2)}function remove_ajax_loader(){jQuery(".ajax-loader").remove()}jQuery(document).off("click","#pixelimg").on("click","#pixelimg",function(){event.preventDefault(),event.stopPropagation(),do_block_click()});let isOverBlockPointer=!1;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",function(){isOverBlockPointer=!0}),jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",function(){isOverBlockPointer=!1}),jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",function(event2){if(!isOverBlockPointer)show_pointer(event2)}),jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",function(event2){show_pointer(event2)}),window.$pixelimg.off("load").on("load",function(){move_image_to_selection(),remove_ajax_loader()}).each(function(){if(this.complete)jQuery(this).trigger("load")}),jQuery(window).on("resize",move_image_to_selection),jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",function(event2){let $el=jQuery(this);return $el.prop("disabled",!0),$el.attr("value",MDS_OBJECT.WAIT),make_selection(event2),!1}),jQuery(".mds_pointer_graphic").off("load").on("load",function(){jQuery(".mds_upload_image").prop("disabled",!1),jQuery(this).attr("value","Upload")}),add_ajax_loader(window.$pixelimg.parent())});
