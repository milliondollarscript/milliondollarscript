var p=!0;jQuery(document).on("ajaxComplete",function(Y,l,k){if(new URLSearchParams(k.data).get("type")!=="order")return;if(p)p=!1;else return;if(window.$block_pointer=jQuery("#block_pointer"),window.$pixelimg=jQuery("#pixelimg"),window.$block_pointer.length===0||window.$pixelimg.length===0)return;if(window.MDS_OBJECT&&window.MDS_OBJECT.grid_data){let q=window.MDS_OBJECT.grid_data;if(window.$block_pointer.attr("data-original-width",q.pointer_width),window.$block_pointer.attr("data-original-height",q.pointer_height),window.$block_pointer.css({width:q.pointer_width+"px",height:q.pointer_height+"px"}),q.debug_mode)console.log("Grid dimensions:",{width_px:q.orig_width_px,height_px:q.orig_height_px,width_blocks:q.grid_width_blocks,height_blocks:q.grid_height_blocks,block_width:q.block_width,block_height:q.block_height})}let B=0,h=MDS_OBJECT.block_str,v=parseInt(MDS_OBJECT.low_x,10),D=parseInt(MDS_OBJECT.low_y,10),T=MDS_OBJECT.is_moving;window.blk_width=parseInt(MDS_OBJECT.BLK_WIDTH,10),window.blk_height=parseInt(MDS_OBJECT.BLK_HEIGHT,10),window.grid_width=parseInt(MDS_OBJECT.grid_width,10)*window.blk_width,window.grid_height=parseInt(MDS_OBJECT.grid_height,10)*window.blk_height,window.pointer_width=window.blk_width,window.pointer_height=window.blk_height;let _=parseInt(MDS_OBJECT.user_id,10),H=parseInt(MDS_OBJECT.BID,10),P=document.getElementById("submit_button1"),y=document.getElementById("submit_button2");document.form1.selected_pixels.value=h;function n(){let q=window.$block_pointer.position(),A=W(),E=MDS_OBJECT.grid_data||{},J=parseInt(MDS_OBJECT.grid_width||E.grid_width_blocks),N=window.$pixelimg.width(),K=parseInt(E.orig_width_px||J*E.block_width)/N,V=Math.round(q.left*K),Z=Math.round(q.top*K),G=Math.floor(A/J),L=A%J,S={_wpnonce:MDS_OBJECT.NONCE,user_id:_,map_x:V,map_y:Z,block_id:A,BID:H,t:MDS_OBJECT.time};if(jQuery.ajax({method:"POST",url:MDS_OBJECT.CHECK_SELECTION,data:S,dataType:"json"}).done(function(Q){if(Q){if(Q.type==="unavailable"||Q.type==="no_orders"||Q.type==="no_permission")alert(Q.data.value),T=!0;else if(Q.type==="available")console.log("Blocks are available for selection")}}).fail(function(Q,R,M){console.error("Selection check failed:",R,M)}).always(function(){P.disabled=!1,y.disabled=!1,window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer")}),B!==0)P.disabled=!0,y.disabled=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait")}function a(q){q.stopPropagation(),q.preventDefault(),window.reserving=!0,window.$block_pointer.css("cursor","wait"),window.$pixelimg.css("cursor","wait"),document.body.style.cursor="wait",P.disabled=!0,y.disabled=!0,P.value=MDS_OBJECT.WAIT,y.value=MDS_OBJECT.WAIT,P.style.cursor="wait",y.style.cursor="wait";let A=window.$block_pointer.position(),E=MDS_OBJECT.grid_data||{},J=parseInt(MDS_OBJECT.grid_width||E.grid_width_blocks),N=window.$pixelimg.width(),K=parseInt(E.orig_width_px||J*E.block_width)/N,V=Math.round(A.left*K),Z=Math.round(A.top*K),G={mds_nonce:MDS_OBJECT.mds_nonce,action:"mds_ajax",type:"make-selection",user_id:_,map_x:V,map_y:Z,block_id:W(),BID:H,t:MDS_OBJECT.time,package:get_selected_package()};jQuery.ajax({method:"POST",url:MDS_OBJECT.ajaxurl,data:G,dataType:"json"}).done(function(L){if(L)if(L.type==="unavailable"||L.type==="max_orders")alert(L.data.value),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",P.disabled=!1,y.disabled=!1,P.value=MDS_OBJECT.WRITE,y.value=MDS_OBJECT.WRITE,P.style.cursor="pointer",y.style.cursor="pointer",window.reserving=!1,T=!0;else if(L.redirect)window.location.href=L.redirect;else mds_update_package(jQuery(document.form1)),document.form1.submit()}).fail(function(L,S,Q){console.error("Selection request failed:",S,Q),window.$block_pointer.css("cursor","pointer"),window.$pixelimg.css("cursor","pointer"),document.body.style.cursor="pointer",P.disabled=!1,y.disabled=!1,P.value=MDS_OBJECT.WRITE,y.value=MDS_OBJECT.WRITE,P.style.cursor="pointer",y.style.cursor="pointer",window.reserving=!1})}function o(q){let A=q.offset(),E=A.left,J=A.top;return{x:E,y:J}}function f(){let q=jQuery("#pixelimg");if(!q.length)return;let A=MDS_OBJECT.grid_data||{},E=parseInt(A.grid_width_blocks||MDS_OBJECT.grid_width),J=parseInt(A.grid_height_blocks||MDS_OBJECT.grid_height);if(!E||!J){console.error("Invalid grid dimensions in scaleImageMap");return}let N=q.width(),U=q.height(),K=N/E,V=U/J;if(window.blk_width=K,window.blk_height=V,window.grid_width=N,window.grid_height=U,window.grid_width_in_blocks=E,window.grid_height_in_blocks=J,window.$block_pointer){let Z=parseInt(window.$block_pointer.attr("data-original-width"))||A.pointer_width||K*4,G=parseInt(window.$block_pointer.attr("data-original-height"))||A.pointer_height||V*4;if(!window.$block_pointer.data("orig-width"))window.$block_pointer.data({"orig-width":Z,"orig-height":G});let L=A.orig_width_px||E*A.block_width,S=N/L,Q=Z*S,R=G*S;if(window.$block_pointer.css({width:Q+"px",height:R+"px"}),window.pointer_width=Q,window.pointer_height=R,window.$block_pointer.data("block_x")!==void 0){let M=parseInt(window.$block_pointer.data("block_x")),O=parseInt(window.$block_pointer.data("block_y")),j=window.$block_pointer.outerWidth(!0),F=window.$block_pointer.outerHeight(!0),z=M*K,C=O*V,$=N-j,I=U-F;z=Math.min(Math.max(0,z),$),C=Math.min(Math.max(0,C),I),window.$block_pointer.css({left:z+"px",top:C+"px"});let w=Math.round(z/K),b=Math.round(C/V);if(window.$block_pointer.data({map_x:z,map_y:C,block_x:w,block_y:b}),window.mds_x=z,window.mds_y=C,A.debug_mode)console.log("ScaleImageMap:",{grid:{blocks:E+"x"+J,pixels:N+"x"+U},block:{width:K,height:V},pointer:{original:Z+"x"+G,actual:j+"x"+F},position:{pixel:z+","+C,block:w+","+b,max:$+","+I}})}}}let u;window.addEventListener("resize",function(){clearTimeout(u),u=setTimeout(function(){f()},100)}),jQuery(document).ready(function(){let q=document.getElementById("pixelimg");if(q)q.addEventListener("load",function(){f()});setTimeout(function(){f()},100)});function x(q){if(!T)return;let A=jQuery("#pixelimg");if(!A.length)return;let E=MDS_OBJECT.grid_data||{},J=parseInt(E.grid_width_blocks||MDS_OBJECT.grid_width),N=parseInt(E.grid_height_blocks||MDS_OBJECT.grid_height);if(!J||!N)return console.error("Invalid grid dimensions"),!1;let U=A.width(),K=A.height(),V=A.offset(),Z=window.$block_pointer,G=U/J,L=K/N;window.grid_width=U,window.grid_height=K,window.grid_width_in_blocks=J,window.grid_height_in_blocks=N,window.blk_width=G,window.blk_height=L;let S=q.pageX-V.left,Q=q.pageY-V.top,R=Math.max(0,Math.min(S,U-1)),M=Math.max(0,Math.min(Q,K-1)),O=Z.outerWidth(!0),j=Z.outerHeight(!0),F=Math.floor(R/G),z=Math.floor(M/L),C=F*G,$=z*L,I=U-O,w=K-j;if(C=Math.min(C,I),$=Math.min($,w),Z.css({left:C+"px",top:$+"px"}),F=Math.round(C/G),z=Math.round($/L),Z.data({map_x:C,map_y:$,block_x:F,block_y:z}),window.mds_x=C,window.mds_y=$,E.debug_mode)console.log("Pointer:",{grid:{blocks:J+"x"+N,pixels:U+"x"+K},block:{width:G,height:L},pointer:{size:O+"x"+j},position:{pixel:C+","+$,block:F+","+z,max:I+","+w}});return!0}function W(){let q=MDS_OBJECT.grid_data||{},A=parseInt(MDS_OBJECT.grid_width||q.grid_width_blocks),E=parseInt(MDS_OBJECT.grid_height||q.grid_height_blocks);if(!A||!E)return console.error("Grid dimensions not available"),-1;if(window.$block_pointer){let J=window.$block_pointer.offset(),N=window.$pixelimg.offset(),U=window.$block_pointer.outerWidth(),K=window.$block_pointer.outerHeight(),V=J.left-N.left+U/2,Z=J.top-N.top+K/2,G=window.$pixelimg.width(),L=window.$pixelimg.height(),S=G/A,Q=L/E,R=Math.floor(V/S),M=Math.floor(Z/Q);if(R<0||M<0||R>=A||M>=E)return console.error("Invalid block coordinates:",R,M),-1;if(q.debug_mode)console.log("Selection:",{pointer:{left:J.left,top:J.top,width:U,height:K},center:{x:V,y:Z},block:{x:R,y:M,width:S,height:Q},grid:{width:A,height:E}});return M*A+R}return-1}function c(){if(window.reserving)return;B=1,n(),v=window.$block_pointer.position().left,D=window.$block_pointer.position().top,T=!T}function m(){window.$block_pointer.css({top:D+"px",left:v+"px",visibility:"visible"}),window.$block_pointer.data({map_y:D,map_x:v})}function d(q){let A=jQuery("<div class='ajax-loader'></div>");jQuery(q).append(A),A.css("top",jQuery(q).position().top).css("left",jQuery(q).width()/2-A.width()/2)}function g(){jQuery(".ajax-loader").remove()}jQuery(document).off("click","#pixelimg").on("click","#pixelimg",function(){Y.preventDefault(),Y.stopPropagation(),c()});let X=!1;jQuery(document).off("mouseenter","#block_pointer").on("mouseenter","#block_pointer",function(){X=!0}),jQuery(document).off("mouseleave","#block_pointer").on("mouseleave","#block_pointer",function(){X=!1}),jQuery(document).off("mousemove","#pixelimg").on("mousemove","#pixelimg",function(q){if(!X)x(q)}),jQuery(document).off("mousemove","#block_pointer").on("mousemove","#block_pointer",function(q){x(q)}),window.$pixelimg.off("load").on("load",function(){m(),g()}).each(function(){if(this.complete)jQuery(this).trigger("load")}),jQuery(window).on("resize",m),jQuery(document).off("click","#submit_button1, #submit_button2").on("click","#submit_button1, #submit_button2",function(q){let A=jQuery(this);return A.prop("disabled",!0),A.attr("value",MDS_OBJECT.WAIT),a(q),!1}),jQuery(".mds_pointer_graphic").off("load").on("load",function(){jQuery(".mds_upload_image").prop("disabled",!1),jQuery(this).attr("value","Upload")}),d(window.$pixelimg.parent())});
