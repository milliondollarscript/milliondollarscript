#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook to synchronize plugin version across files
# - Source of truth: Version header in milliondollarscript-two.php
# - Targets: readme.txt Stable tag, MDS_VERSION and MDS_DB_VERSION constants

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

PLUGIN_FILE="milliondollarscript-two.php"
README_FILE="readme.txt"

# Ensure files exist
[[ -f "$PLUGIN_FILE" ]] || exit 0
[[ -f "$README_FILE" ]] || exit 0

# Extract version from plugin header (first match)
PHP_VER=$(grep -E '^[[:space:]]*\*[[:space:]]*Version:[[:space:]]*' "$PLUGIN_FILE" | head -n1 | sed -E 's/.*Version:[[:space:]]*([^[:space:]]+).*/\1/')
if [[ -z "${PHP_VER:-}" ]]; then
  # Also try without leading '*'
  PHP_VER=$(grep -E '^[[:space:]]*Version:[[:space:]]*' "$PLUGIN_FILE" | head -n1 | sed -E 's/.*Version:[[:space:]]*([^[:space:]]+).*/\1/')
fi

if [[ -z "${PHP_VER:-}" ]]; then
  # No version header found; nothing to do
  exit 0
fi

# Sync Stable tag in readme.txt if needed
README_VER=$(grep -E '^[[:space:]]*Stable tag:[[:space:]]*' "$README_FILE" | head -n1 | sed -E 's/.*Stable tag:[[:space:]]*([^[:space:]]+).*/\1/')
if [[ -n "${README_VER:-}" && "$README_VER" != "$PHP_VER" ]]; then
  sed -i -E "s/^([[:space:]]*Stable tag:[[:space:]]*).*/\\1$PHP_VER/" "$README_FILE"
  git add "$README_FILE"
fi

# Ensure MDS_VERSION and MDS_DB_VERSION constants match
# Update values only if they differ
if grep -qE "define\(\s*'MDS_VERSION'\s*,\s*'[^']+'\s*\)" "$PLUGIN_FILE"; then
  CURRENT_MDS_VERSION=$(grep -E "define\(\s*'MDS_VERSION'\s*,\s*'[^']+'\s*\)" "$PLUGIN_FILE" | head -n1 | sed -E "s/.*'MDS_VERSION'\s*,\s*'([^']+)'.*/\1/")
  if [[ "$CURRENT_MDS_VERSION" != "$PHP_VER" ]]; then
    sed -i -E "s/(define\(\s*'MDS_VERSION'\s*,\s*')([^']+)('\s*\))/\1$PHP_VER\3/" "$PLUGIN_FILE"
  fi
fi

if grep -qE "define\(\s*'MDS_DB_VERSION'\s*,\s*'[^']+'\s*\)" "$PLUGIN_FILE"; then
  CURRENT_DB_VERSION=$(grep -E "define\(\s*'MDS_DB_VERSION'\s*,\s*'[^']+'\s*\)" "$PLUGIN_FILE" | head -n1 | sed -E "s/.*'MDS_DB_VERSION'\s*,\s*'([^']+)'.*/\1/")
  if [[ "$CURRENT_DB_VERSION" != "$PHP_VER" ]]; then
    sed -i -E "s/(define\(\s*'MDS_DB_VERSION'\s*,\s*')([^']+)('\s*\))/\1$PHP_VER\3/" "$PLUGIN_FILE"
  fi
fi

git add "$PLUGIN_FILE"

exit 0
