name: Populate GitHub release notes

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  changelog-to-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Extract notes from CHANGELOG.md
        id: extract
        run: |
          python <<'PY'
          import os
          import re
          tag = os.environ.get("TAG_NAME", "")
          if not tag:
              raise SystemExit("TAG_NAME environment variable is required")

          version = tag[1:] if tag.startswith("v") else tag

          changelog_path = "CHANGELOG.md"
          with open(changelog_path, "r", encoding="utf-8") as fh:
              changelog = fh.read()

          pattern = rf"^##\\s+{re.escape(version)}(?:\\s+-\\s+[0-9]{{4}}-[0-9]{{2}}-[0-9]{{2}})?\\s*\\n(?P<body>.*?)(?=^##\\s+|\\Z)"
          match = re.search(pattern, changelog, flags=re.MULTILINE | re.DOTALL)
          if not match:
              raise SystemExit(f"Could not find changelog entry for version '{version}'")

          body = match.group("body").strip()
          if not body:
              raise SystemExit(f"Changelog entry for version '{version}' is empty")

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as out:
              out.write("body<<__CHANGELOG__\\n")
              out.write(body)
              out.write("\\n__CHANGELOG__\\n")
          PY
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}

      - name: Update GitHub release body
        uses: actions/github-script@v7
        env:
          RELEASE_BODY: ${{ steps.extract.outputs.body }}
        with:
          script: |
            const releaseId = context.payload.release.id;
            const body = process.env.RELEASE_BODY;
            if (!body) {
              throw new Error("No release body content found in outputs");
            }
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body,
            });
*** End Patch
