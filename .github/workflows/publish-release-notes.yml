name: Populate GitHub release notes

on:
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to update (e.g., v2.6.15 or 2.6.15)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  changelog-to-release:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag name
        id: vars
        run: |
          tag="${{ github.event.release.tag_name || github.event.inputs.tag_name || github.ref_name }}"
          tag="${tag##refs/tags/}"
          if [ -z "$tag" ]; then
            echo "âŒ Unable to determine tag name" >&2
            exit 1
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Check out repository at tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: refs/tags/${{ steps.vars.outputs.tag }}

      - name: Extract notes from CHANGELOG.md
        id: extract
        run: |
          python <<'PY'
          import os
          import re
          tag = os.environ.get("TAG_NAME", "")
          if not tag:
              raise SystemExit("TAG_NAME environment variable is required")

          version = tag[1:] if tag.startswith("v") else tag

          changelog_path = "CHANGELOG.md"
          with open(changelog_path, "r", encoding="utf-8") as fh:
              changelog = fh.read()

          # Allow CRLF/LF and tolerate optional date suffix on heading
          pattern = rf"^##\\s+{re.escape(version)}[^\\n]*\\r?\\n(?P<body>.*?)(?=^##\\s+|\\Z)"
          match = re.search(pattern, changelog, flags=re.MULTILINE | re.DOTALL)
          if not match:
              raise SystemExit(f"Could not find changelog entry for version '{version}'")

          body = match.group("body").strip()
          if not body:
              raise SystemExit(f"Changelog entry for version '{version}' is empty")

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as out:
              out.write("body<<__CHANGELOG__\n")
              out.write(body)
              out.write("\n__CHANGELOG__\n")
          PY
        env:
          TAG_NAME: ${{ steps.vars.outputs.tag }}

      - name: Update GitHub release body
        uses: actions/github-script@v7
        env:
          RELEASE_BODY: ${{ steps.extract.outputs.body }}
        with:
          script: |
            const releaseId = context.payload.release.id;
            const body = process.env.RELEASE_BODY;
            if (!body) {
              throw new Error("No release body content found in outputs");
            }
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body,
            });
