(function($){let MDSPageCreator={config:{currentStep:1,totalSteps:5,selectedPageTypes:[],previewData:null,configurationLoadTimeout:null},init:function(){this.bindEvents(),this.initializeSteps(),this.loadInitialState()},bindEvents:function(){$(document).on("change",'input[name="implementation_type"]',this.handleImplementationTypeChange.bind(this)),$(document).on("change",'input[name="page_types[]"]',this.handlePageTypeChange.bind(this)),$(document).on("change",'input[name="create_mode"]',this.handleCreateModeChange.bind(this)),$("#mds-quick-create-all").on("click",this.handleQuickCreateAll.bind(this)),$("#mds-grid-sort-type-btn").on("click",this.handleGridSortType.bind(this)),$("#mds-grid-sort-direction-btn").on("click",this.handleGridSortDirection.bind(this)),$("#mds-preview-creation").on("click",this.handlePreviewCreation.bind(this)),$("#mds-create-pages").on("click",this.handleCreatePages.bind(this)),$("#mds-page-creator-form").on("submit",this.handleFormSubmit.bind(this)),$(document).on("click",".mds-modal-close, #mds-modal-ok",this.hideModal.bind(this)),$(document).on("click",".mds-modal-overlay",this.hideModal.bind(this)),$(document).on("keydown",this.handleModalKeydown.bind(this)),$(document).on("click",".mds-step-nav",this.handleStepNavigation.bind(this))},initializeSteps:function(){$(".mds-creator-step").each(function(index){if(index===0)$(this).addClass("active");else $(this).addClass("inactive")})},loadInitialState:function(){this.updateSelectedPageTypes(),this.loadPageConfigurations(),this.initializeCreateModeSelection(),this.performGridSort()},handleImplementationTypeChange:function(e){let implementationType=$(e.target).val();if(this.updateImplementationInfo(implementationType),this.updateCreateButton(),this.config.previewData&&$("#mds-preview-panel").is(":visible"))this.handlePreviewCreation(e)},handlePageTypeChange:function(e){if(this.updateSelectedPageTypes(),this.config.configurationLoadTimeout)clearTimeout(this.config.configurationLoadTimeout);this.config.configurationLoadTimeout=setTimeout(()=>{this.loadPageConfigurations()},300),this.updateCreateButton()},handleCreateModeChange:function(e){let createMode=$(e.target).val();if($(".mds-create-mode-option").removeClass("selected"),$(e.target).closest(".mds-create-mode-option").addClass("selected"),this.config.previewData&&$("#mds-preview-panel").is(":visible"))this.handlePreviewCreation(e)},initializeCreateModeSelection:function(){let checkedCreateMode=$('input[name="create_mode"]:checked');if(checkedCreateMode.length>0)$(".mds-create-mode-option").removeClass("selected"),checkedCreateMode.closest(".mds-create-mode-option").addClass("selected")},handleQuickCreateAll:function(e){e.preventDefault(),$('input[name="implementation_type"][value="block"]').prop("checked",!0).trigger("change"),$('input[name="page_types[]"]').prop("checked",!0).trigger("change"),setTimeout(()=>{this.goToStep(5);let reviewStep=$('.mds-creator-step[data-step="5"]');if(reviewStep.length>0)$("html, body").animate({scrollTop:reviewStep.offset().top-100},800);this.startPreviewButtonBlink()},500)},handleGridSortType:function(e){e.preventDefault();let $btn=$(e.currentTarget),newSortBy=$btn.data("sort-by")==="id"?"name":"id";$btn.data("sort-by",newSortBy),$btn.find(".sort-label").text(newSortBy.toUpperCase()),$btn.addClass("active"),setTimeout(()=>{$btn.removeClass("active")},200),this.performGridSort()},handleGridSortDirection:function(e){e.preventDefault();let $btn=$(e.currentTarget),newDirection=$btn.data("sort-direction")==="asc"?"desc":"asc";$btn.data("sort-direction",newDirection);let $arrow=$btn.find(".sort-direction"),$label=$btn.find(".sort-direction-label");if(newDirection==="asc")$arrow.removeClass("dashicons-arrow-down").addClass("dashicons-arrow-up"),$label.text("ASC");else $arrow.removeClass("dashicons-arrow-up").addClass("dashicons-arrow-down"),$label.text("DESC");$btn.addClass("active"),setTimeout(()=>{$btn.removeClass("active")},200),this.performGridSort()},performGridSort:function(){let sortBy=$("#mds-grid-sort-type-btn").data("sort-by"),direction=$("#mds-grid-sort-direction-btn").data("sort-direction");this.sortGridOptions(sortBy,direction)},sortGridOptions:function(sortBy,direction){let $select=$("#mds-grid-selector");if($select.length===0)return;let $allOptions=$select.find("option"),selectedValue=$select.val(),$gridOptions=$allOptions.filter(function(){return $(this).val()&&$(this).val()!==""});if($gridOptions.length===0)return;let optionsArray=$gridOptions.toArray();if(optionsArray.sort((a,b)=>{let valueA,valueB;if(sortBy==="id")valueA=parseInt($(a).val())||0,valueB=parseInt($(b).val())||0;else valueA=$(a).text().toLowerCase(),valueB=$(b).text().toLowerCase();let comparison=0;if(valueA>valueB)comparison=1;else if(valueA<valueB)comparison=-1;return direction==="asc"?comparison:-comparison}),$gridOptions.remove(),optionsArray.forEach((option)=>{$select.append(option)}),selectedValue&&$select.find(`option[value="${selectedValue}"]`).length>0)$select.val(selectedValue)},updateSelectedPageTypes:function(){this.config.selectedPageTypes=[],$('input[name="page_types[]"]:checked').each((index,element)=>{this.config.selectedPageTypes.push($(element).val())})},loadPageConfigurations:function(){if(this.config.selectedPageTypes.length===0){$("#mds-page-configurations").empty();return}let data={action:"mds_get_page_configuration",nonce:mdsPageCreator.nonce,page_types:this.config.selectedPageTypes};$("#mds-page-configurations").html('<div class="mds-loading">Loading configurations...</div>'),$.post(mdsPageCreator.ajaxUrl,data).done((response)=>{if(response.success)$("#mds-page-configurations").html(response.data.html),this.initializeConfigurationFields();else this.showError("Failed to load page configurations")}).fail(()=>{this.showError("Network error loading configurations")})},initializeConfigurationFields:function(){$(".mds-page-config select").each(function(){}),$('.mds-page-config input[type="number"]').on("change",function(){let min=parseFloat($(this).attr("min")),max=parseFloat($(this).attr("max")),value=parseFloat($(this).val());if(!isNaN(min)&&value<min)$(this).val(min);if(!isNaN(max)&&value>max)$(this).val(max)})},handlePreviewCreation:function(e){e.preventDefault(),this.stopPreviewButtonBlink();let formData=this.getFormData();if(!this.validateFormData(formData))return;$("#mds-preview-creation").prop("disabled",!0).text(mdsPageCreator.strings.preview);let data={action:"mds_get_creation_preview",nonce:mdsPageCreator.nonce,...formData};$.post(mdsPageCreator.ajaxUrl,data).done((response)=>{if(response.success)this.config.previewData=response.data,this.displayPreview(response.data),$("#mds-create-pages").prop("disabled",!1);else this.showError(response.data||"Preview generation failed")}).fail(()=>{this.showError("Network error generating preview")}).always(()=>{$("#mds-preview-creation").prop("disabled",!1).text("Preview Creation")})},handleCreatePages:function(e){e.preventDefault();let formData=this.getFormData();if(!this.validateFormData(formData))return;let confirmMessage=mdsPageCreator.strings.confirm_create;if(formData.create_mode==="update_existing")confirmMessage=mdsPageCreator.strings.confirm_update;if(!confirm(confirmMessage))return;$("#mds-create-pages").prop("disabled",!0).text(mdsPageCreator.strings.creating);let data={action:"mds_creator_create_pages",nonce:mdsPageCreator.nonce,...formData};$.post(mdsPageCreator.ajaxUrl,data).done((response)=>{if(response.success)this.displayResults(response.data),this.showSuccess(mdsPageCreator.strings.success);else this.showError(response.data||"Page creation failed")}).fail((xhr,status,error)=>{this.showError("Network error creating pages: "+error)}).always(()=>{$("#mds-create-pages").prop("disabled",!1).text("Create Pages")})},handleFormSubmit:function(e){e.preventDefault(),this.handleCreatePages(e)},getFormData:function(){let formData={};return formData.implementation_type=$('input[name="implementation_type"]:checked').val(),formData.page_types=[],$('input[name="page_types[]"]:checked').each(function(){formData.page_types.push($(this).val())}),formData.create_mode=$('input[name="create_mode"]:checked').val()||"create_new",formData.selected_grid_id=$("#mds-grid-selector").val(),formData.configurations={},$(".mds-page-config").each(function(){let pageType=$(this).data("page-type");formData.configurations[pageType]={},$(this).find("input, select, textarea").each(function(){let name=$(this).attr("name");if(name&&name.includes(`[${pageType}]`)){let fieldName=name.match(/\[([^\]]+)\]$/)[1];if($(this).attr("type")==="checkbox")if(name.includes("[]")){if(!formData.configurations[pageType][fieldName])formData.configurations[pageType][fieldName]=[];if($(this).is(":checked"))formData.configurations[pageType][fieldName].push($(this).val())}else formData.configurations[pageType][fieldName]=$(this).is(":checked");else formData.configurations[pageType][fieldName]=$(this).val()}})}),formData},validateFormData:function(formData){if(!formData.implementation_type)return this.showError("Please select an implementation type"),!1;if(!formData.page_types||formData.page_types.length===0)return this.showError("Please select at least one page type"),!1;return!0},displayPreview:function(previewData){let html='<div class="mds-preview-summary">';if(html+=`<p><strong>Pages to create:</strong> ${previewData.pages_to_create.length}</p>`,html+=`<p><strong>Estimated time:</strong> ${previewData.estimated_time} seconds</p>`,html+="</div>",previewData.warnings&&previewData.warnings.length>0)html+='<div class="mds-preview-warnings">',html+="<h4>Warnings:</h4>",html+="<ul>",previewData.warnings.forEach((warning)=>{html+=`<li>${warning}</li>`}),html+="</ul>",html+="</div>";if(previewData.recommendations&&previewData.recommendations.length>0)html+='<div class="mds-preview-recommendations">',html+="<h4>Recommendations:</h4>",html+="<ul>",previewData.recommendations.forEach((recommendation)=>{html+=`<li>${recommendation}</li>`}),html+="</ul>",html+="</div>";html+='<div class="mds-preview-pages">',html+="<h4>Pages to be created:</h4>",html+='<table class="wp-list-table widefat fixed striped">',html+="<thead><tr><th>Page Type</th><th>Title</th><th>Implementation</th><th>Status</th><th>Existing Page Details</th></tr></thead>",html+="<tbody>",previewData.pages_to_create.forEach((page)=>{html+="<tr>",html+=`<td><strong>${page.page_type}</strong></td>`,html+=`<td>${page.title}</td>`,html+=`<td>${page.implementation_type}</td>`,html+=`<td>${page.status||(page.existing_page?"Will update existing":"Will create new")}</td>`;let existingPageInfo="";if(page.existing_page_data){let epd=page.existing_page_data;if(existingPageInfo+='<div class="mds-existing-page-info">',existingPageInfo+=`<div><strong>ID:</strong> ${epd.id}</div>`,existingPageInfo+=`<div><strong>Title:</strong> "${epd.title}"</div>`,existingPageInfo+=`<div><strong>Status:</strong> ${epd.status}</div>`,epd.date_modified)existingPageInfo+=`<div><strong>Modified:</strong> ${epd.date_modified}</div>`;if(epd.author)existingPageInfo+=`<div><strong>Author:</strong> ${epd.author}</div>`;if(existingPageInfo+='<div class="mds-page-links">',epd.url)existingPageInfo+=`<a href="${epd.url}" target="_blank" class="button button-small">View Page</a> `;if(epd.edit_link)existingPageInfo+=`<a href="${epd.edit_link}" target="_blank" class="button button-small">Edit Page</a>`;existingPageInfo+="</div>",existingPageInfo+="</div>"}else existingPageInfo="<em>No existing page</em>";html+=`<td>${existingPageInfo}</td>`,html+="</tr>"}),html+="</tbody>",html+="</table>",html+="</div>",$("#mds-preview-content").html(html),$("#mds-preview-panel").show()},displayResults:function(results){let html='<div class="mds-results-summary">';if(html+=`<p><strong>Created:</strong> ${results.total_created} pages</p>`,html+=`<p><strong>Updated:</strong> ${results.total_updated} pages</p>`,html+=`<p><strong>Errors:</strong> ${results.total_errors}</p>`,html+="</div>",results.created_pages&&results.created_pages.length>0)html+='<div class="mds-results-created">',html+="<h4>Created Pages:</h4>",html+="<ul>",results.created_pages.forEach((page)=>{html+=`<li><a href="${page.page_url}" target="_blank">${page.page_title}</a> (${page.page_type})</li>`}),html+="</ul>",html+="</div>";if(results.updated_pages&&results.updated_pages.length>0)html+='<div class="mds-results-updated">',html+="<h4>Updated Pages:</h4>",html+="<ul>",results.updated_pages.forEach((page)=>{html+=`<li><a href="${page.page_url}" target="_blank">${page.page_title}</a> (${page.page_type})</li>`}),html+="</ul>",html+="</div>";if(results.errors&&results.errors.length>0)html+='<div class="mds-results-errors">',html+="<h4>Errors:</h4>",html+="<ul>",results.errors.forEach((error)=>{html+=`<li class="error">${error}</li>`}),html+="</ul>",html+="</div>";if($("#mds-results-content").html(html),$("#mds-results-panel").show(),$("#mds-results-panel").length>0)$("html, body").animate({scrollTop:$("#mds-results-panel").offset().top},500)},updateImplementationInfo:function(implementationType){$(".mds-implementation-option").removeClass("selected"),$(`input[value="${implementationType}"]`).closest(".mds-implementation-option").addClass("selected")},updateCreateButton:function(){let hasSelection=$('input[name="page_types[]"]:checked').length>0,hasImplementationType=$('input[name="implementation_type"]:checked').length>0,isEnabled=hasSelection&&hasImplementationType;if($("#mds-preview-creation").prop("disabled",!isEnabled),isEnabled&&!$("#mds-preview-creation").hasClass("blinking"))this.startPreviewButtonBlink()},startPreviewButtonBlink:function(){let $previewBtn=$("#mds-preview-creation");if(!$previewBtn.prop("disabled")&&!$previewBtn.hasClass("blinking"))$previewBtn.addClass("blinking")},stopPreviewButtonBlink:function(){$("#mds-preview-creation").removeClass("blinking")},showModal:function(type,title,message,callback){let modal=$("#mds-notification-modal"),icon=$("#mds-modal-icon"),titleEl=$("#mds-modal-title"),messageEl=$("#mds-modal-message");icon.removeClass("error success warning info").addClass(type);let icons={error:"✕",success:"✓",warning:"!",info:"i"};icon.attr("data-icon",icons[type]||"i"),titleEl.text(title),messageEl.html(message),modal.fadeIn(200),modal.data("callback",callback),setTimeout(()=>{$("#mds-modal-ok").focus()},250)},hideModal:function(){let modal=$("#mds-notification-modal"),callback=modal.data("callback");if(modal.fadeOut(200),typeof callback==="function")setTimeout(callback,200)},showError:function(message,callback){this.showModal("error","Error",message,callback)},showSuccess:function(message,callback){this.showModal("success","Success",message,callback)},showWarning:function(message,callback){this.showModal("warning","Warning",message,callback)},showInfo:function(message,callback){this.showModal("info","Information",message,callback)},handleModalKeydown:function(e){if($("#mds-notification-modal").is(":visible")){if(e.key==="Escape")e.preventDefault(),this.hideModal();else if(e.key==="Enter")e.preventDefault(),this.hideModal()}},handleStepNavigation:function(e){e.preventDefault();let targetStep=$(e.target).data("step");this.goToStep(targetStep)},goToStep:function(stepNumber){if(stepNumber<1||stepNumber>this.config.totalSteps)return;$(".mds-creator-step").removeClass("active").addClass("inactive"),$(`.mds-creator-step[data-step="${stepNumber}"]`).removeClass("inactive").addClass("active"),this.config.currentStep=stepNumber}};$(document).ready(function(){if($(".mds-create-pages").length>0)MDSPageCreator.init()})})(jQuery);
