(function($){let ErrorResolution={modal:null,currentPageId:null,init:function(){this.bindEvents(),this.setupModal(),this.bindPageListErrorHelpers()},bindEvents:function(){$("#mds-scan-errors").on("click",this.scanForErrors.bind(this)),$("#mds-fix-all-errors").on("click",this.fixAllErrors.bind(this)),$(document).on("click","#mds-modal-close, #mds-modal-cancel",this.closeModal.bind(this)),$(document).on("click","#mds-modal-fix",this.applyModalFix.bind(this)),$(document).on("click",".mds-error-view-details",this.viewErrorDetails.bind(this)),$(document).on("click",".mds-error-fix-single",this.fixSingleError.bind(this)),$(document).on("click",".mds-modal-overlay",function(e){if(e.target===this)ErrorResolution.closeModal()})},setupModal:function(){this.modal=$("#mds-error-modal")},bindPageListErrorHelpers:function(){$(document).on("click",".mds-error-help",function(e){e.preventDefault(),e.stopPropagation();let postId=$(this).data("post-id");if(postId)ErrorResolution.showErrorDetails(postId)})},scanForErrors:function(e){e.preventDefault();let $button=$(e.target),$progress=$("#mds-error-progress"),$results=$("#mds-error-results"),$progressText=$("#mds-error-progress-text");$progress.show(),$results.hide(),$button.prop("disabled",!0),$progressText.text("Scanning for page errors..."),$.ajax({url:"/wp-json/mds/v1/pages",method:"GET",data:{status:"error"},beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(response){if(response.success&&response.data)ErrorResolution.displayErrorResults(response.data);else ErrorResolution.showError("Failed to scan for errors: "+(response.message||"Unknown error"))}).fail(function(xhr){ErrorResolution.showError("Error scanning pages: "+xhr.statusText)}).always(function(){$progress.hide(),$button.prop("disabled",!1)})},displayErrorResults:function(errorPages){let $results=$("#mds-error-results"),$errorList=$(".mds-error-list"),$fixAllButton=$("#mds-fix-all-errors");if(!errorPages||errorPages.length===0)$errorList.html('<div class="mds-notice mds-notice-success"><p>No pages with errors found!</p></div>'),$fixAllButton.hide();else{let html="",autoFixableCount=0;if(errorPages.forEach(function(page){let hasAutoFix=page.suggested_fixes&&page.suggested_fixes.some((fix)=>fix.auto_fixable);if(hasAutoFix)autoFixableCount++;let errorClass=hasAutoFix?"auto-fixable":"manual-fix",errorSummary=page.validation_errors?page.validation_errors.slice(0,2).join(", "):"Unknown error";html+=`
                        <div class="mds-error-item ${errorClass}" data-page-id="${page.page_id}">
                            <div class="mds-error-item-content">
                                <div class="mds-error-item-title">${page.page_title} (ID: ${page.page_id})</div>
                                <div class="mds-error-item-details">
                                    <strong>Page Type:</strong> ${page.page_type||"Unknown"}<br>
                                    <strong>Errors:</strong> ${errorSummary}
                                </div>
                            </div>
                            <div class="mds-error-item-actions">
                                <button type="button" class="button button-secondary mds-error-view-details" 
                                        data-page-id="${page.page_id}">
                                    View Details
                                </button>
                                ${hasAutoFix?`
                                <button type="button" class="button button-primary mds-error-fix-single" 
                                        data-page-id="${page.page_id}">
                                    Fix Now
                                </button>`:""}
                            </div>
                        </div>
                    `}),$errorList.html(html),autoFixableCount>0)$fixAllButton.show().find("span:last").text(`Fix All Auto-Fixable Errors (${autoFixableCount})`);else $fixAllButton.hide()}$results.show()},showErrorDetails:function(pageId){this.currentPageId=pageId,$.ajax({url:`/wp-json/mds/v1/pages/${pageId}/errors`,method:"GET",beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(response){if(response.success&&response.data)ErrorResolution.populateModal(response.data),ErrorResolution.openModal();else ErrorResolution.showError("Failed to load error details: "+(response.message||"Unknown error"))}).fail(function(xhr){ErrorResolution.showError("Error loading page details: "+xhr.statusText)})},populateModal:function(pageData){let $modalTitle=$("#mds-modal-title"),$modalBody=$("#mds-modal-body"),$modalFix=$("#mds-modal-fix");$modalTitle.text(`Error Details: ${pageData.page_title}`);let html=`
                <div class="mds-error-detail">
                    <div class="mds-error-detail-label">Page Information</div>
                    <div class="mds-error-detail-value">
                        <strong>ID:</strong> ${pageData.page_id}<br>
                        <strong>Type:</strong> ${pageData.page_type||"Unknown"}<br>
                        <strong>Status:</strong> ${pageData.status}<br>
                        <strong>Confidence Score:</strong> ${pageData.confidence_score}<br>
                        <strong>Last Validated:</strong> ${pageData.last_validated||"Never"}
                    </div>
                </div>
            `;if(pageData.validation_errors&&pageData.validation_errors.length>0)html+=`
                    <div class="mds-error-detail">
                        <div class="mds-error-detail-label">Validation Errors</div>
                        <div class="mds-error-detail-value">
                            ${pageData.validation_errors.map((error)=>`â€¢ ${error}`).join("<br>")}
                        </div>
                    </div>
                `;if(pageData.suggested_fixes&&pageData.suggested_fixes.length>0)if(html+='<div class="mds-suggested-fixes">',html+='<div class="mds-error-detail-label">Suggested Fixes</div>',pageData.suggested_fixes.forEach(function(fix){let fixClass=fix.auto_fixable?"mds-auto-fixable":"";html+=`
                        <div class="mds-suggested-fix ${fixClass}">
                            <div class="mds-suggested-fix-title">
                                ${fix.title}
                                ${fix.auto_fixable?" (Auto-fixable)":" (Manual)"}
                            </div>
                            <div class="mds-suggested-fix-description">${fix.description}</div>
                        </div>
                    `}),html+="</div>",pageData.suggested_fixes.some((fix)=>fix.auto_fixable))$modalFix.show().data("page-id",pageData.page_id);else $modalFix.hide();else $modalFix.hide();$modalBody.html(html)},viewErrorDetails:function(e){e.preventDefault();let pageId=$(e.target).data("page-id");this.showErrorDetails(pageId)},fixSingleError:function(e){e.preventDefault();let pageId=$(e.target).data("page-id"),$button=$(e.target);this.applyFix(pageId,$button)},applyModalFix:function(e){e.preventDefault();let pageId=$("#mds-modal-fix").data("page-id"),$button=$("#mds-modal-fix");this.applyFix(pageId,$button,!0)},applyFix:function(pageId,$button,closeModal=!1){let originalText=$button.text();$button.prop("disabled",!0).text("Applying fixes..."),$.ajax({url:`/wp-json/mds/v1/pages/${pageId}/fix`,method:"POST",beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(response){if(response.success&&response.data){let fixes=response.data.fixes_applied,newStatus=response.data.new_status;if(fixes&&fixes.length>0){ErrorResolution.showSuccess(`Applied ${fixes.length} fix(es). New status: ${newStatus}`);let $errorItem=$(`.mds-error-item[data-page-id="${pageId}"]`);if(newStatus==="active")$errorItem.fadeOut();else ErrorResolution.refreshErrorItem(pageId);if(closeModal)setTimeout(()=>ErrorResolution.closeModal(),1500)}else ErrorResolution.showError("No fixes were applied. The page may already be fixed.")}else ErrorResolution.showError("Failed to apply fixes: "+(response.message||"Unknown error"))}).fail(function(xhr){ErrorResolution.showError("Error applying fixes: "+xhr.statusText)}).always(function(){$button.prop("disabled",!1).text(originalText)})},fixAllErrors:function(e){e.preventDefault();let $button=$(e.target),pageIds=$(".mds-error-item.auto-fixable").map(function(){return $(this).data("page-id")}).get();if(pageIds.length===0){this.showError("No auto-fixable errors found.");return}$button.prop("disabled",!0).text("Fixing all errors..."),this.fixErrorsBatch(pageIds,0,$button)},fixErrorsBatch:function(pageIds,index,$button){if(index>=pageIds.length){$button.prop("disabled",!1).text("Fix All Auto-Fixable Errors"),this.showSuccess("Completed fixing all auto-fixable errors!"),setTimeout(()=>$("#mds-scan-errors").click(),1000);return}let pageId=pageIds[index],$errorItem=$(`.mds-error-item[data-page-id="${pageId}"]`);$errorItem.css("opacity","0.5"),$.ajax({url:`/wp-json/mds/v1/pages/${pageId}/fix`,method:"POST",beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(response){if(response.success&&response.data.new_status==="active")$errorItem.fadeOut();else $errorItem.css("opacity","1")}).fail(function(){$errorItem.css("opacity","1")}).always(function(){setTimeout(()=>{ErrorResolution.fixErrorsBatch(pageIds,index+1,$button)},300)})},refreshErrorItem:function(pageId){$.ajax({url:`/wp-json/mds/v1/pages/${pageId}/errors`,method:"GET",beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(response){if(response.success&&response.data){let $errorItem=$(`.mds-error-item[data-page-id="${pageId}"]`),page=response.data,errorClass=page.suggested_fixes&&page.suggested_fixes.some((fix)=>fix.auto_fixable)?"auto-fixable":"manual-fix",errorSummary=page.validation_errors?page.validation_errors.slice(0,2).join(", "):"Unknown error";$errorItem.removeClass("auto-fixable manual-fix").addClass(errorClass),$errorItem.find(".mds-error-item-details").html(`
                        <strong>Page Type:</strong> ${page.page_type||"Unknown"}<br>
                        <strong>Errors:</strong> ${errorSummary}
                    `)}})},openModal:function(){this.modal.show(),$("body").addClass("modal-open")},closeModal:function(){this.modal.hide(),$("body").removeClass("modal-open"),this.currentPageId=null},showError:function(message){this.showNotice(message,"error")},showSuccess:function(message){this.showNotice(message,"success")},showNotice:function(message,type="info"){let $notice=$(`
                <div class="notice notice-${type} is-dismissible" style="margin: 10px 0;">
                    <p>${message}</p>
                    <button type="button" class="notice-dismiss">
                        <span class="screen-reader-text">Dismiss this notice.</span>
                    </button>
                </div>
            `);$(".wrap h1").after($notice),setTimeout(()=>$notice.fadeOut(),5000),$notice.on("click",".notice-dismiss",function(){$notice.fadeOut()})}};$(document).ready(function(){ErrorResolution.init()}),window.MDSErrorResolution=ErrorResolution})(jQuery);
