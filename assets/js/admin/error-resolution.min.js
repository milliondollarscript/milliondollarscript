(i=>{let a={modal:null,currentPageId:null,init:function(){this.bindEvents(),this.setupModal(),this.bindPageListErrorHelpers()},bindEvents:function(){i("#mds-scan-errors").on("click",this.scanForErrors.bind(this)),i("#mds-fix-all-errors").on("click",this.fixAllErrors.bind(this)),i(document).on("click","#mds-modal-close, #mds-modal-cancel",this.closeModal.bind(this)),i(document).on("click","#mds-modal-fix",this.applyModalFix.bind(this)),i(document).on("click",".mds-error-view-details",this.viewErrorDetails.bind(this)),i(document).on("click",".mds-error-fix-single",this.fixSingleError.bind(this)),i(document).on("click",".mds-modal-overlay",function(e){e.target===this&&a.closeModal()})},setupModal:function(){this.modal=i("#mds-error-modal")},bindPageListErrorHelpers:function(){i(document).on("click",".mds-error-help",function(e){e.preventDefault(),e.stopPropagation();e=i(this).data("post-id");e&&a.showErrorDetails(e)})},scanForErrors:function(e){e.preventDefault();let s=i(e.target);e=i("#mds-error-results");window.mdsPageManagement&&window.mdsPageManagement.showProgress&&window.mdsPageManagement.showProgress("Scanning for Page Errors","Analyzing pages for validation errors..."),e.hide(),s.prop("disabled",!0),i.ajax({url:"/wp-json/mds/v1/pages",method:"GET",data:{status:"error"},beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){e.success&&e.data?a.displayErrorResults(e.data):a.showError("Failed to scan for errors: "+(e.message||"Unknown error"))}).fail(function(e){a.showError("Error scanning pages: "+e.statusText)}).always(function(){window.mdsPageManagement&&window.mdsPageManagement.hideProgress&&window.mdsPageManagement.hideProgress(),s.prop("disabled",!1)})},displayErrorResults:function(e){var s=i("#mds-error-results"),t=i(".mds-error-list"),o=i("#mds-fix-all-errors");if(e&&0!==e.length){let r="",i=0;e.forEach(function(e){var s=e.suggested_fixes&&e.suggested_fixes.some(e=>e.auto_fixable),t=(s&&i++,s?"auto-fixable":"manual-fix"),o=e.validation_errors?e.validation_errors.slice(0,2).join(", "):"Unknown error";r+=`
                        <div class="mds-error-item ${t}" data-page-id="${e.page_id}">
                            <div class="mds-error-item-content">
                                <div class="mds-error-item-title">${e.page_title} (ID: ${e.page_id})</div>
                                <div class="mds-error-item-details">
                                    <strong>Page Type:</strong> ${e.page_type||"Unknown"}<br>
                                    <strong>Errors:</strong> ${o}
                                </div>
                            </div>
                            <div class="mds-error-item-actions">
                                <button type="button" class="button button-secondary mds-error-view-details" 
                                        data-page-id="${e.page_id}">
                                    View Details
                                </button>
                                ${s?`
                                <button type="button" class="button button-primary mds-error-fix-single" 
                                        data-page-id="${e.page_id}">
                                    Fix Now
                                </button>`:""}
                            </div>
                        </div>
                    `}),t.html(r),0<i?o.show().find("span:last").text(`Fix All Auto-Fixable Errors (${i})`):o.hide()}else t.html('<div class="mds-no-errors"><p>No pages with errors found!</p></div>'),o.hide(),window.mdsPageManagement&&window.mdsPageManagement.showNotification&&window.mdsPageManagement.showNotification("success","Scan Complete","No pages with errors found! All pages appear to be functioning correctly.");s.show()},showErrorDetails:function(e){this.currentPageId=e,i.ajax({url:`/wp-json/mds/v1/pages/${e}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){e.success&&e.data?(a.populateModal(e.data),a.openModal()):a.showError("Failed to load error details: "+(e.message||"Unknown error"))}).fail(function(e){a.showError("Error loading page details: "+e.statusText)})},populateModal:function(e){var s=i("#mds-modal-title"),t=i("#mds-modal-body"),o=i("#mds-modal-fix");s.text("Error Details: "+e.page_title);let r=`
                <div class="mds-error-detail">
                    <div class="mds-error-detail-label">Page Information</div>
                    <div class="mds-error-detail-value">
                        <strong>ID:</strong> ${e.page_id}<br>
                        <strong>Type:</strong> ${e.page_type||"Unknown"}<br>
                        <strong>Status:</strong> ${e.status}<br>
                        <strong>Confidence Score:</strong> ${e.confidence_score}<br>
                        <strong>Last Validated:</strong> ${e.last_validated||"Never"}
                    </div>
                </div>
            `;e.validation_errors&&0<e.validation_errors.length&&(r+=`
                    <div class="mds-error-detail">
                        <div class="mds-error-detail-label">Validation Errors</div>
                        <div class="mds-error-detail-value">
                            ${e.validation_errors.map(e=>"â€¢ "+e).join("<br>")}
                        </div>
                    </div>
                `),e.suggested_fixes&&0<e.suggested_fixes.length&&(r+='<div class="mds-suggested-fixes"><div class="mds-error-detail-label">Suggested Fixes</div>',e.suggested_fixes.forEach(function(e){var s=e.auto_fixable?"mds-auto-fixable":"";r+=`
                        <div class="mds-suggested-fix ${s}">
                            <div class="mds-suggested-fix-title">
                                ${e.title}
                                ${e.auto_fixable?" (Auto-fixable)":" (Manual)"}
                            </div>
                            <div class="mds-suggested-fix-description">${e.description}</div>
                        </div>
                    `}),r+="</div>",e.suggested_fixes.some(e=>e.auto_fixable))?o.show().data("page-id",e.page_id):o.hide(),t.html(r)},viewErrorDetails:function(e){e.preventDefault();e=i(e.target).data("page-id");this.showErrorDetails(e)},fixSingleError:function(e){e.preventDefault();var s=i(e.target).data("page-id"),e=i(e.target);this.applyFix(s,e)},applyModalFix:function(e){e.preventDefault();var e=i("#mds-modal-fix").data("page-id"),s=i("#mds-modal-fix");this.applyFix(e,s,!0)},applyFix:function(o,e,r=!1){let s=e.text();e.prop("disabled",!0).text("Applying fixes..."),i.ajax({url:`/wp-json/mds/v1/pages/${o}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){var s,t;e.success&&e.data?(t=e.data.fixes_applied,s=e.data.new_status,t&&0<t.length?(a.showSuccess(`Applied ${t.length} fix(es). New status: `+s),t=i(`.mds-error-item[data-page-id="${o}"]`),"active"===s?t.fadeOut():a.refreshErrorItem(o),r&&setTimeout(()=>a.closeModal(),1500)):a.showError("No fixes were applied. The page may already be fixed.")):a.showError("Failed to apply fixes: "+(e.message||"Unknown error"))}).fail(function(e){a.showError("Error applying fixes: "+e.statusText)}).always(function(){e.prop("disabled",!1).text(s)})},fixAllErrors:function(e){e.preventDefault();var e=i(e.target),s=i(".mds-error-item.auto-fixable").map(function(){return i(this).data("page-id")}).get();0===s.length?this.showError("No auto-fixable errors found."):(e.prop("disabled",!0).text("Fixing all errors..."),this.fixErrorsBatch(s,0,e))},fixErrorsBatch:function(e,t,o){if(t>=e.length)o.prop("disabled",!1).text("Fix All Auto-Fixable Errors"),this.showSuccess("Completed fixing all auto-fixable errors!"),setTimeout(()=>i("#mds-scan-errors").click(),1e3);else{var r=e[t];let s=i(`.mds-error-item[data-page-id="${r}"]`);s.css("opacity","0.5"),i.ajax({url:`/wp-json/mds/v1/pages/${r}/fix`,method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){e.success&&"active"===e.data.new_status?s.fadeOut():s.css("opacity","1")}).fail(function(){s.css("opacity","1")}).always(function(){setTimeout(()=>{a.fixErrorsBatch(e,t+1,o)},300)})}},refreshErrorItem:function(r){i.ajax({url:`/wp-json/mds/v1/pages/${r}/errors`,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)}}).done(function(e){var s,t,o;e.success&&e.data&&(s=i(`.mds-error-item[data-page-id="${r}"]`),t=(e=e.data).suggested_fixes&&e.suggested_fixes.some(e=>e.auto_fixable)?"auto-fixable":"manual-fix",o=e.validation_errors?e.validation_errors.slice(0,2).join(", "):"Unknown error",s.removeClass("auto-fixable manual-fix").addClass(t),s.find(".mds-error-item-details").html(`
                        <strong>Page Type:</strong> ${e.page_type||"Unknown"}<br>
                        <strong>Errors:</strong> ${o}
                    `))})},openModal:function(){this.modal.show(),i("body").addClass("modal-open")},closeModal:function(){this.modal.hide(),i("body").removeClass("modal-open"),this.currentPageId=null},showError:function(e){this.showNotice(e,"error")},showSuccess:function(e){this.showNotice(e,"success")},showNotice:function(s,t="info"){if(window.mdsPageManagement&&window.mdsPageManagement.showNotification)window.mdsPageManagement.showNotification(t,"error"===t?"Error":"success"===t?"Success":"Information",s);else{let e=i(`
                    <div class="notice notice-${t} is-dismissible" style="margin: 10px 0;">
                        <p>${s}</p>
                        <button type="button" class="notice-dismiss">
                            <span class="screen-reader-text">Dismiss this notice.</span>
                        </button>
                    </div>
                `);i(".wrap h1").after(e),setTimeout(()=>e.fadeOut(),5e3),e.on("click",".notice-dismiss",function(){e.fadeOut()})}}};i(document).ready(function(){a.init()}),window.MDSErrorResolution=a})(jQuery);